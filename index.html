<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Invent√°rio</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00e5a0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Invent√°rio">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161a24;
    --surface2: #1e2436;
    --border: #2a3050;
    --accent: #00e5a0;
    --accent2: #0077ff;
    --warn: #ff6b35;
    --text: #e8eaf0;
    --muted: #6b748c;
    --locked: #2a1a0a;
    --font-mono: 'Space Mono', monospace;
    --font-main: 'Sora', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-main); min-height: 100vh; }

  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 28px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { font-family: var(--font-mono); font-size: 1.05rem; color: var(--accent); letter-spacing: 2px; }
  .logo span { color: var(--muted); }
  .stats { display: flex; gap: 20px; font-size: 0.76rem; color: var(--muted); font-family: var(--font-mono); }
  .stats strong { color: var(--text); }

  .sync-bar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 10px 28px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .sync-status { display: flex; align-items: center; gap: 7px; font-family: var(--font-mono); font-size: 0.78rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .dot.green { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .dot.yellow { background: #ffc107; animation: pulse 1s infinite; }
  .dot.red { background: var(--warn); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .btn-sync {
    margin-left: auto; background: rgba(0,229,160,0.1);
    border: 1px solid rgba(0,229,160,0.3); color: var(--accent);
    padding: 7px 14px; border-radius: 7px; font-size: 0.78rem;
    font-family: var(--font-mono); cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .btn-sync:hover { background: rgba(0,229,160,0.2); }
  .btn-sync:disabled { opacity: 0.4; cursor: not-allowed; }

  .toolbar {
    padding: 16px 28px; display: flex; gap: 10px; align-items: center;
    flex-wrap: wrap; background: var(--surface); border-bottom: 1px solid var(--border);
  }
  .search-wrap { position: relative; flex: 1; min-width: 220px; }
  .search-wrap svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); }
  .search-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.88rem;
    padding: 9px 12px 9px 38px; border-radius: 8px; outline: none; transition: border-color 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }

  .btn {
    padding: 9px 16px; border-radius: 8px; font-family: var(--font-main);
    font-size: 0.83rem; font-weight: 600; cursor: pointer; border: none;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .btn-add { background: var(--accent); color: #0d0f14; }
  .btn-add:hover { background: #00ffb3; }
  .btn-search { background: var(--accent2); color: #fff; }
  .btn-search:hover { background: #1a8aff; }

  .col-info {
    margin: 12px 28px 0;
    background: rgba(0,119,255,0.07); border: 1px solid rgba(0,119,255,0.2);
    border-radius: 8px; padding: 9px 15px;
    font-size: 0.75rem; color: var(--muted); font-family: var(--font-mono);
  }
  .col-info span { color: var(--accent2); }

  .filter-tabs { display: flex; gap: 7px; padding: 14px 28px 0; flex-wrap: wrap; }
  .filter-tab {
    padding: 5px 13px; border-radius: 6px; font-size: 0.76rem;
    font-family: var(--font-mono); cursor: pointer;
    border: 1px solid var(--border); background: transparent; color: var(--muted); transition: all 0.2s;
  }
  .filter-tab.active { background: var(--surface2); color: var(--text); border-color: var(--accent); }

  .table-wrap { padding: 20px 28px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
  thead tr { border-bottom: 2px solid var(--border); }
  th {
    text-align: left; padding: 9px 12px; color: var(--muted);
    font-size: 0.72rem; font-family: var(--font-mono); letter-spacing: 1px;
    text-transform: uppercase; white-space: nowrap;
  }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:hover:not(.locked-row) { background: var(--surface2); }
  tbody tr.locked-row { background: var(--locked); }
  tbody tr.pending-row { border-left: 3px solid var(--accent); }
  td { padding: 9px 12px; vertical-align: middle; }

  .cell-input {
    background: transparent; border: 1px solid transparent; color: var(--text);
    font-family: var(--font-main); font-size: 0.86rem;
    padding: 4px 7px; border-radius: 5px; width: 100%; outline: none; transition: all 0.2s;
  }
  .cell-input:not([disabled]):hover { border-color: var(--border); }
  .cell-input:not([disabled]):focus { border-color: var(--accent); background: var(--surface2); }
  .cell-input[disabled] { cursor: not-allowed; color: var(--muted); opacity: 0.65; }

  .badge {
    display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px;
    border-radius: 20px; font-size: 0.7rem; font-weight: 600;
    font-family: var(--font-mono); white-space: nowrap;
  }
  .badge-ok { background: rgba(0,229,160,0.1); color: var(--accent); }
  .badge-low { background: rgba(255,193,7,0.1); color: #ffc107; }
  .badge-out { background: rgba(255,107,53,0.1); color: var(--warn); }
  .badge-locked { background: rgba(255,107,53,0.12); color: var(--warn); }

  .action-btns { display: flex; gap: 4px; align-items: center; flex-wrap: nowrap; }
  .btn-cons {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.25);
    color: var(--warn); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-cons:hover { background: rgba(255,107,53,0.22); }
  .btn-unlock {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.25);
    color: var(--accent2); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-unlock:hover { background: rgba(0,119,255,0.22); }
  .btn-save-row {
    background: rgba(0,229,160,0.08); border: 1px solid rgba(0,229,160,0.25);
    color: var(--accent); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-save-row:hover { background: rgba(0,229,160,0.2); }

  .empty { text-align: center; padding: 60px 28px; color: var(--muted); }
  .empty h3 { font-size: 1.05rem; margin-bottom: 8px; color: var(--text); }
  .empty p { font-size: 0.83rem; line-height: 1.6; }

  #toast {
    position: fixed; bottom: 22px; right: 22px;
    background: var(--surface2); border: 1px solid var(--accent);
    color: var(--text); padding: 11px 18px; border-radius: 9px;
    font-size: 0.83rem; font-family: var(--font-mono);
    opacity: 0; transform: translateY(10px); transition: all 0.3s;
    pointer-events: none; z-index: 999; max-width: 340px;
  }
  #toast.show { opacity: 1; transform: translateY(0); }
  #toast.err { border-color: var(--warn); }

  .loading-overlay {
    display: none; position: fixed; inset: 0; background: rgba(13,15,20,0.82);
    z-index: 500; align-items: center; justify-content: center; flex-direction: column; gap: 16px;
  }
  .loading-overlay.show { display: flex; }
  .spinner {
    width: 40px; height: 40px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-family: var(--font-mono); color: var(--muted); font-size: 0.85rem; }

  @media(max-width:600px){
    header,.toolbar,.table-wrap,.sync-bar,.filter-tabs{padding-left:14px;padding-right:14px;}
    .stats{display:none;}
  }

  /* ‚îÄ‚îÄ AUTH OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #authOverlay {
    position: fixed; inset: 0; z-index: 1000;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }
  #authOverlay.hidden { display: none; }

  .auth-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 40px 36px; width: 100%; max-width: 420px;
    position: relative; overflow: hidden;
  }
  .auth-card::before {
    content: ''; position: absolute; top: -60px; right: -60px;
    width: 180px; height: 180px; border-radius: 50%;
    background: radial-gradient(circle, rgba(0,229,160,0.08) 0%, transparent 70%);
    pointer-events: none;
  }

  .auth-logo {
    font-family: var(--font-mono); font-size: 1.15rem;
    color: var(--accent); letter-spacing: 3px; margin-bottom: 6px;
  }
  .auth-logo span { color: var(--muted); }
  .auth-subtitle {
    color: var(--muted); font-size: 0.8rem;
    font-family: var(--font-mono); margin-bottom: 32px;
  }

  .auth-tabs {
    display: flex; gap: 0; margin-bottom: 28px;
    border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
  }
  .auth-tab {
    flex: 1; padding: 9px; font-family: var(--font-mono); font-size: 0.78rem;
    background: transparent; border: none; color: var(--muted); cursor: pointer;
    transition: all 0.2s;
  }
  .auth-tab.active { background: var(--surface2); color: var(--accent); }

  .auth-field { margin-bottom: 16px; }
  .auth-field label {
    display: block; font-size: 0.72rem; font-family: var(--font-mono);
    color: var(--muted); margin-bottom: 6px; letter-spacing: 1px;
    text-transform: uppercase;
  }
  .auth-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.9rem;
    padding: 10px 14px; border-radius: 8px; outline: none; transition: all 0.2s;
  }
  .auth-input:focus { border-color: var(--accent); }
  .auth-input::placeholder { color: var(--muted); }

  .btn-auth {
    width: 100%; background: var(--accent); color: #0d0f14;
    border: none; border-radius: 8px; padding: 12px;
    font-family: var(--font-mono); font-size: 0.85rem; font-weight: 700;
    cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
    margin-top: 6px;
  }
  .btn-auth:hover { background: #00ffb3; }

  .auth-err {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.3);
    color: var(--warn); font-size: 0.78rem; font-family: var(--font-mono);
    padding: 9px 13px; border-radius: 7px; margin-bottom: 14px; display: none;
  }
  .auth-err.show { display: block; }

  /* user badge in header */
  .user-badge {
    display: flex; align-items: center; gap: 10px;
    font-family: var(--font-mono); font-size: 0.75rem; color: var(--muted);
  }
  .user-badge strong { color: var(--accent); }
  .btn-logout {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.25);
    color: var(--warn); padding: 4px 10px; border-radius: 6px;
    font-size: 0.72rem; font-weight: 600; cursor: pointer;
    font-family: var(--font-mono); transition: all 0.2s;
  }
  .btn-logout:hover { background: rgba(255,107,53,0.22); }

  /* local file button */
  .btn-file {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.3);
    color: var(--accent2); padding: 7px 14px; border-radius: 7px;
    font-size: 0.78rem; font-family: var(--font-mono); cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .btn-file:hover { background: rgba(0,119,255,0.2); }
  #fileInput { display: none; }

  /* publish button */
  .btn-publish {
    background: rgba(0,229,160,0.12); border: 1px solid rgba(0,229,160,0.4);
    color: var(--accent); padding: 7px 14px; border-radius: 7px;
    font-size: 0.78rem; font-family: var(--font-mono); cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    font-weight: 700; animation: pulseGreen 2s infinite;
  }
  .btn-publish:hover { background: rgba(0,229,160,0.25); }
  .btn-publish:disabled { opacity: 0.4; cursor: not-allowed; animation: none; }
  #pendingCount {
    background: var(--accent); color: #0d0f14; border-radius: 10px;
    padding: 1px 7px; font-size: 0.68rem; font-weight: 700;
  }
  @keyframes pulseGreen {
    0%,100% { box-shadow: 0 0 0 0 rgba(0,229,160,0.3); }
    50% { box-shadow: 0 0 0 5px rgba(0,229,160,0); }
  }

  /* ‚îÄ‚îÄ NAVIGATION SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #navScreen {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: var(--bg); align-items: center; justify-content: center;
    flex-direction: column; gap: 40px; padding: 80px 20px 40px;
  }
  #navScreen.active { display: flex; }
  #chartScreen { display: none; }

  .nav-title {
    font-family: var(--font-mono); font-size: 1.1rem;
    color: var(--accent); letter-spacing: 3px; text-align: center;
  }
  .nav-subtitle {
    font-size: 0.78rem; color: var(--muted);
    font-family: var(--font-mono); text-align: center; margin-top: 6px;
  }
  .nav-sync-status {
    display: flex; align-items: center; gap: 8px;
    font-family: var(--font-mono); font-size: 0.75rem; color: var(--muted);
  }

  .nav-cards {
    display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;
    max-width: 700px; width: 100%;
  }
  .nav-card {
    flex: 1; min-width: 260px; max-width: 300px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 36px 28px; cursor: pointer;
    transition: all 0.25s; text-align: center; position: relative; overflow: hidden;
  }
  .nav-card::before {
    content: ''; position: absolute; inset: 0; opacity: 0; transition: opacity 0.25s;
  }
  .nav-card.inv::before { background: radial-gradient(circle at 50% 0%, rgba(0,229,160,0.08), transparent 70%); }
  .nav-card.chart::before { background: radial-gradient(circle at 50% 0%, rgba(0,119,255,0.08), transparent 70%); }
  .nav-card:hover { transform: translateY(-4px); }
  .nav-card.inv:hover { border-color: var(--accent); box-shadow: 0 8px 32px rgba(0,229,160,0.12); }
  .nav-card.chart:hover { border-color: var(--accent2); box-shadow: 0 8px 32px rgba(0,119,255,0.12); }
  .nav-card:hover::before { opacity: 1; }

  .nav-card-icon {
    font-size: 2.8rem; margin-bottom: 16px; display: block;
  }
  .nav-card-title {
    font-family: var(--font-mono); font-size: 0.95rem; letter-spacing: 2px;
    margin-bottom: 10px;
  }
  .nav-card.inv .nav-card-title { color: var(--accent); }
  .nav-card.chart .nav-card-title { color: var(--accent2); }
  .nav-card-desc {
    font-size: 0.78rem; color: var(--muted); line-height: 1.6;
  }

  /* ‚îÄ‚îÄ CHARTS SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #chartScreen {
    display: none; min-height: 100vh;
    background: var(--bg); padding-bottom: 60px;
  }
  #chartScreen.active { display: block; }

  .chart-header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 28px; display: flex; align-items: center; gap: 14px;
    position: sticky; top: 0; z-index: 100;
  }
  .btn-back {
    background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    color: var(--muted); padding: 6px 13px; border-radius: 7px;
    font-family: var(--font-mono); font-size: 0.75rem; cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 5px;
  }
  .btn-back:hover { color: var(--text); border-color: var(--text); }

  .chart-body { padding: 36px 28px; max-width: 900px; margin: 0 auto; }
  .chart-section-title {
    font-family: var(--font-mono); font-size: 0.72rem;
    color: var(--muted); letter-spacing: 2px; text-transform: uppercase;
    margin-bottom: 24px;
  }

  /* big KPI card */
  .kpi-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 36px 32px; margin-bottom: 28px;
    display: flex; align-items: center; gap: 36px; flex-wrap: wrap;
  }
  .kpi-donut-wrap { position: relative; width: 160px; height: 160px; flex-shrink: 0; }
  .kpi-donut-wrap svg { width: 160px; height: 160px; transform: rotate(-90deg); }
  .kpi-donut-center {
    position: absolute; inset: 0; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
  }
  .kpi-pct {
    font-family: var(--font-mono); font-size: 2rem; font-weight: 700;
    color: var(--accent2); line-height: 1;
  }
  .kpi-pct-label {
    font-size: 0.65rem; color: var(--muted); font-family: var(--font-mono);
    margin-top: 4px; letter-spacing: 1px;
  }
  .kpi-info { flex: 1; min-width: 200px; }
  .kpi-title {
    font-family: var(--font-mono); font-size: 1.1rem;
    color: var(--text); margin-bottom: 10px; letter-spacing: 1px;
  }
  .kpi-title span { color: var(--accent2); }
  .kpi-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.7; }
  .kpi-numbers {
    display: flex; gap: 28px; margin-top: 20px; flex-wrap: wrap;
  }
  .kpi-num { text-align: center; }
  .kpi-num-val {
    font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700;
    display: block;
  }
  .kpi-num-val.mod { color: var(--accent2); }
  .kpi-num-val.total { color: var(--text); }
  .kpi-num-lbl { font-size: 0.7rem; color: var(--muted); font-family: var(--font-mono); }

  /* bar visualization */
  .bar-visual {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px 32px; margin-bottom: 28px;
  }
  .bar-visual-title {
    font-family: var(--font-mono); font-size: 0.8rem; color: var(--muted);
    margin-bottom: 18px; letter-spacing: 1px;
  }
  .bar-track {
    background: var(--surface2); border-radius: 100px;
    height: 28px; width: 100%; overflow: hidden; position: relative;
  }
  .bar-fill {
    height: 100%; border-radius: 100px;
    background: linear-gradient(90deg, var(--accent2), rgba(0,119,255,0.6));
    transition: width 1s cubic-bezier(0.4,0,0.2,1);
    display: flex; align-items: center; justify-content: flex-end;
    padding-right: 12px;
  }
  .bar-fill-label {
    font-family: var(--font-mono); font-size: 0.72rem;
    color: #fff; font-weight: 700; white-space: nowrap;
  }
  .bar-legend {
    display: flex; gap: 20px; margin-top: 14px; flex-wrap: wrap;
  }
  .bar-leg-item {
    display: flex; align-items: center; gap: 7px;
    font-family: var(--font-mono); font-size: 0.72rem; color: var(--muted);
  }
  .bar-leg-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* no data */
  .chart-empty {
    text-align: center; padding: 80px 28px; color: var(--muted);
  }
  .chart-empty h3 { font-size: 1rem; color: var(--text); margin-bottom: 8px; }
  .chart-empty p { font-size: 0.82rem; line-height: 1.6; }

  /* ‚îÄ‚îÄ DROPDOWN CELL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .cell-wrap { position: relative; display: flex; align-items: center; gap: 3px; }
  .btn-dropdown {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.25);
    color: var(--accent2); width: 22px; height: 22px; border-radius: 4px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s; padding: 0;
  }
  .btn-dropdown:hover { background: rgba(0,119,255,0.25); }
  .dropdown-list {
    position: absolute; top: 100%; left: 0; min-width: 180px; max-width: 280px;
    background: var(--surface); border: 1px solid var(--accent2);
    border-radius: 8px; z-index: 500; overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    margin-top: 3px;
  }
  .dropdown-list-inner { max-height: 200px; overflow-y: auto; }
  .dropdown-item {
    padding: 8px 13px; font-size: 0.82rem; cursor: pointer;
    color: var(--text); transition: background 0.12s;
    border-bottom: 1px solid var(--border);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .dropdown-item:last-child { border-bottom: none; }
  .dropdown-item:hover { background: var(--surface2); color: var(--accent); }
  .dropdown-empty {
    padding: 10px 13px; font-size: 0.78rem;
    color: var(--muted); font-family: var(--font-mono);
  }
  .dropdown-header {
    padding: 7px 13px; font-size: 0.68rem; font-family: var(--font-mono);
    color: var(--muted); letter-spacing: 1px; text-transform: uppercase;
    border-bottom: 1px solid var(--border); background: var(--surface2);
  }

  /* ‚îÄ‚îÄ ITEM DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #itemDrawer {
    position: fixed; inset: 0; z-index: 800;
    display: flex; justify-content: flex-end;
    pointer-events: none;
  }
  #itemDrawer.open { pointer-events: all; }

  .drawer-backdrop {
    position: absolute; inset: 0;
    background: rgba(13,15,20,0); transition: background 0.3s;
  }
  #itemDrawer.open .drawer-backdrop { background: rgba(13,15,20,0.75); }

  .drawer-panel {
    position: relative; width: 100%; max-width: 420px;
    background: var(--surface); border-left: 1px solid var(--border);
    height: 100%; overflow-y: auto;
    transform: translateX(100%); transition: transform 0.32s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column;
  }
  #itemDrawer.open .drawer-panel { transform: translateX(0); }

  .drawer-top {
    padding: 18px 20px 14px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; background: var(--surface); z-index: 10;
  }
  .drawer-title {
    font-family: var(--font-mono); font-size: 0.8rem;
    color: var(--accent); letter-spacing: 2px;
  }
  .drawer-close {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.25);
    color: var(--warn); width: 30px; height: 30px; border-radius: 7px;
    cursor: pointer; font-size: 1rem; display: flex;
    align-items: center; justify-content: center; transition: all 0.2s;
  }
  .drawer-close:hover { background: rgba(255,107,53,0.25); }

  .drawer-body { padding: 20px; flex: 1; }

  .drawer-badge-row { margin-bottom: 18px; }

  .drawer-fields { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
  .drawer-field {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 14px;
  }
  .drawer-field-label {
    font-family: var(--font-mono); font-size: 0.65rem;
    color: var(--muted); letter-spacing: 1px; text-transform: uppercase;
    margin-bottom: 5px;
  }
  .drawer-field-value {
    font-size: 0.9rem; color: var(--text); word-break: break-word; line-height: 1.5;
  }
  .drawer-field-value.empty { color: var(--muted); font-style: italic; font-size: 0.8rem; }

  .drawer-actions {
    display: flex; flex-direction: column; gap: 10px;
    padding: 16px 20px; border-top: 1px solid var(--border);
    position: sticky; bottom: 0; background: var(--surface);
  }
  .drawer-btn {
    width: 100%; padding: 11px; border-radius: 9px;
    font-family: var(--font-mono); font-size: 0.8rem; font-weight: 700;
    cursor: pointer; border: none; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .drawer-btn-cons { background: var(--warn); color: #fff; }
  .drawer-btn-cons:hover { filter: brightness(1.15); }
  .drawer-btn-unlock { background: var(--accent2); color: #fff; }
  .drawer-btn-unlock:hover { filter: brightness(1.15); }
  .drawer-btn-save { background: rgba(0,229,160,0.12); color: var(--accent); border: 1px solid rgba(0,229,160,0.3) !important; }
  .drawer-btn-save:hover { background: rgba(0,229,160,0.22); }

  /* view button in table */
  .btn-view {
    background: rgba(0,229,160,0.08); border: 1px solid rgba(0,229,160,0.2);
    color: var(--accent); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-view:hover { background: rgba(0,229,160,0.18); }

  @media(max-width:480px) {
    .drawer-panel { max-width: 100%; border-left: none; border-top: 1px solid var(--border); }
    #itemDrawer { align-items: flex-end; }
    .drawer-panel { height: 90vh; border-radius: 16px 16px 0 0; }
    .drawer-panel { transform: translateY(100%); }
    #itemDrawer.open .drawer-panel { transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ DRAWER EDIT FIELDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .drawer-field.editable { border-color: rgba(0,229,160,0.25); background: rgba(0,229,160,0.03); }
  .drawer-field.readonly { opacity: 0.75; }
  .drawer-field-label-row {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;
  }
  .drawer-edit-tag {
    font-size: 0.58rem; font-family: var(--font-mono); color: var(--accent);
    background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.2);
    padding: 1px 6px; border-radius: 10px; letter-spacing: 1px;
  }
  .drawer-date-tag {
    font-size: 0.58rem; font-family: var(--font-mono); color: var(--accent2);
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.2);
    padding: 1px 6px; border-radius: 10px; letter-spacing: 1px;
  }
  .drawer-field-input {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.88rem;
    padding: 8px 11px; border-radius: 7px; outline: none; transition: all 0.2s;
  }
  .drawer-field-input:focus { border-color: var(--accent); background: var(--bg); }
  .drawer-field-input::placeholder { color: var(--muted); }
  .drawer-field-input[type="date"] {
    color-scheme: dark; cursor: pointer;
    border-color: rgba(0,119,255,0.3);
  }
  .drawer-field-input[type="date"]:focus { border-color: var(--accent2); }
  .drawer-field-textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.88rem;
    padding: 8px 11px; border-radius: 7px; outline: none; transition: all 0.2s;
    resize: vertical; min-height: 70px; line-height: 1.5;
  }
  .drawer-field-textarea:focus { border-color: var(--accent); background: var(--bg); }
  .drawer-dropdown-wrap { position: relative; }
  .drawer-dropdown-btn {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    background: rgba(0,119,255,0.12); border: 1px solid rgba(0,119,255,0.25);
    color: var(--accent2); border-radius: 5px; width: 22px; height: 22px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .drawer-dropdown-btn:hover { background: rgba(0,119,255,0.25); }
  .drawer-field-input.has-dropdown { padding-right: 36px; }
  .btn-drawer-save-all {
    background: var(--accent); color: #0d0f14; width: 100%; padding: 12px;
    border-radius: 9px; font-family: var(--font-mono); font-size: 0.82rem;
    font-weight: 700; cursor: pointer; border: none; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    letter-spacing: 1px;
  }
  .btn-drawer-save-all:hover { background: #00ffb3; }

  /* ‚îÄ‚îÄ ADMIN BLOCK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #adminBlockModal {
    display: none; position: fixed; inset: 0; z-index: 1100;
    background: rgba(13,15,20,0.88); align-items: center; justify-content: center;
    padding: 20px;
  }
  #adminBlockModal.open { display: flex; }
  .admin-block-card {
    background: var(--surface); border: 1px solid rgba(255,107,53,0.4);
    border-radius: 16px; padding: 36px 32px; max-width: 380px; width: 100%;
    text-align: center; position: relative;
    box-shadow: 0 0 40px rgba(255,107,53,0.1);
  }
  .admin-block-icon { font-size: 3rem; margin-bottom: 16px; display: block; }
  .admin-block-title {
    font-family: var(--font-mono); font-size: 0.95rem; color: var(--warn);
    letter-spacing: 2px; margin-bottom: 12px;
  }
  .admin-block-msg {
    font-size: 0.84rem; color: var(--muted); line-height: 1.7; margin-bottom: 24px;
  }
  .admin-block-msg strong { color: var(--text); }
  .btn-admin-block-ok {
    background: var(--warn); color: #fff; border: none; border-radius: 9px;
    padding: 11px 32px; font-family: var(--font-mono); font-size: 0.82rem;
    font-weight: 700; cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
  }
  .btn-admin-block-ok:hover { filter: brightness(1.15); }

  /* ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #confirmModal {
    display: none; position: fixed; inset: 0; z-index: 1200;
    background: rgba(13,15,20,0.88); align-items: center; justify-content: center;
    padding: 20px;
  }
  #confirmModal.open { display: flex; }
  .confirm-card {
    background: var(--surface); border: 1px solid rgba(255,107,53,0.35);
    border-radius: 16px; padding: 36px 32px; max-width: 400px; width: 100%;
    text-align: center; box-shadow: 0 0 40px rgba(255,107,53,0.08);
  }
  .confirm-icon { font-size: 2.8rem; margin-bottom: 14px; display: block; }
  .confirm-title {
    font-family: var(--font-mono); font-size: 0.95rem; color: var(--warn);
    letter-spacing: 2px; margin-bottom: 10px;
  }
  .confirm-msg { font-size: 0.84rem; color: var(--muted); line-height: 1.75; margin-bottom: 28px; }
  .confirm-msg strong { color: var(--text); }
  .confirm-btns { display: flex; gap: 12px; justify-content: center; }
  .btn-confirm-yes {
    background: var(--warn); color: #fff; border: none; border-radius: 9px;
    padding: 11px 32px; font-family: var(--font-mono); font-size: 0.82rem;
    font-weight: 700; cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
  }
  .btn-confirm-yes:hover { filter: brightness(1.15); }
  .btn-confirm-no {
    background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    color: var(--muted); border-radius: 9px; padding: 11px 32px;
    font-family: var(--font-mono); font-size: 0.82rem; cursor: pointer;
    transition: all 0.2s; letter-spacing: 1px;
  }
  .btn-confirm-no:hover { color: var(--text); border-color: var(--text); }

  /* ‚îÄ‚îÄ BARCODE SCANNER MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #scannerModal {
    display: none; position: fixed; inset: 0; z-index: 1200;
    background: rgba(13,15,20,0.95); align-items: center; justify-content: center;
    flex-direction: column; gap: 20px; padding: 20px;
  }
  #scannerModal.open { display: flex; }
  .scanner-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; width: 100%; max-width: 480px; overflow: hidden;
  }
  .scanner-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .scanner-title { font-family: var(--font-mono); color: var(--accent); font-size: 0.85rem; letter-spacing: 2px; }
  .scanner-close {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.25);
    color: var(--warn); width: 30px; height: 30px; border-radius: 7px;
    cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center;
  }
  .scanner-video-wrap {
    position: relative; background: #000; width: 100%; aspect-ratio: 4/3; overflow: hidden;
  }
  #scannerVideo { width: 100%; height: 100%; object-fit: cover; display: block; }
  .scanner-crosshair {
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
    pointer-events: none;
  }
  .scanner-crosshair::before {
    content: ''; display: block; width: 70%; height: 38%;
    border: 2px solid var(--accent); border-radius: 8px;
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.45);
  }
  .scanner-crosshair-line {
    position: absolute; left: 15%; right: 15%; height: 2px;
    background: var(--accent); opacity: 0.7;
    animation: scanLine 1.8s ease-in-out infinite;
  }
  @keyframes scanLine {
    0%,100% { top: 31%; } 50% { top: 63%; }
  }
  .scanner-result {
    padding: 14px 20px; border-top: 1px solid var(--border);
    font-family: var(--font-mono); font-size: 0.82rem;
  }
  .scanner-result-label { color: var(--muted); font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 5px; }
  .scanner-result-value { color: var(--accent); font-size: 0.95rem; font-weight: 700; word-break: break-all; }
  .scanner-actions { display: flex; gap: 10px; padding: 14px 20px; border-top: 1px solid var(--border); }
  .btn-scanner-use {
    flex: 1; background: var(--accent); color: #0d0f14; border: none;
    border-radius: 9px; padding: 11px; font-family: var(--font-mono);
    font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 7px;
  }
  .btn-scanner-use:hover { background: #00ffb3; }
  .btn-scanner-use:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-scanner-retry {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.25);
    color: var(--accent2); border-radius: 9px; padding: 11px 18px;
    font-family: var(--font-mono); font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
  }
  .btn-scanner-retry:hover { background: rgba(0,119,255,0.2); }
  .scanner-status {
    padding: 10px 20px; text-align: center;
    font-family: var(--font-mono); font-size: 0.75rem; color: var(--muted);
  }

  /* ‚îÄ‚îÄ REPORTS SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #reportsScreen { display: none; min-height: 100vh; background: var(--bg); padding-bottom: 60px; }
  #reportsScreen.active { display: block; }
  .reports-header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 28px; display: flex; align-items: center; gap: 14px;
    position: sticky; top: 0; z-index: 100;
  }
  .reports-body { padding: 28px; max-width: 960px; margin: 0 auto; }
  .reports-filters {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 22px 24px; margin-bottom: 24px;
  }
  .reports-filter-title {
    font-family: var(--font-mono); font-size: 0.72rem; color: var(--muted);
    letter-spacing: 2px; text-transform: uppercase; margin-bottom: 16px;
  }
  .reports-filter-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 12px;
  }
  .reports-filter-item label {
    display: block; font-size: 0.7rem; font-family: var(--font-mono);
    color: var(--muted); margin-bottom: 5px; letter-spacing: 1px; text-transform: uppercase;
  }
  .reports-filter-select, .reports-filter-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.85rem;
    padding: 8px 11px; border-radius: 8px; outline: none; transition: border-color 0.2s;
    cursor: pointer;
  }
  .reports-filter-select:focus, .reports-filter-input:focus { border-color: var(--accent); }
  .reports-filter-select option { background: var(--surface2); }
  .reports-actions { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
  .btn-reports-apply {
    background: var(--accent); color: #0d0f14; border: none; border-radius: 8px;
    padding: 9px 20px; font-family: var(--font-mono); font-size: 0.8rem;
    font-weight: 700; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 7px;
  }
  .btn-reports-apply:hover { background: #00ffb3; }
  .btn-reports-print {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.3);
    color: var(--accent2); border-radius: 8px; padding: 9px 20px;
    font-family: var(--font-mono); font-size: 0.8rem; font-weight: 700;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 7px;
  }
  .btn-reports-print:hover { background: rgba(0,119,255,0.2); }
  .btn-reports-clear {
    background: transparent; border: 1px solid var(--border); color: var(--muted);
    border-radius: 8px; padding: 9px 20px; font-family: var(--font-mono); font-size: 0.8rem;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-reports-clear:hover { color: var(--text); border-color: var(--text); }

  .reports-summary {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 12px;
    margin-bottom: 24px;
  }
  .reports-kpi {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 18px 16px; text-align: center;
  }
  .reports-kpi-val {
    font-family: var(--font-mono); font-size: 1.6rem; font-weight: 700;
    color: var(--accent); display: block; margin-bottom: 4px;
  }
  .reports-kpi-lbl { font-size: 0.7rem; color: var(--muted); font-family: var(--font-mono); }

  .reports-table-wrap {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; overflow: hidden;
  }
  .reports-table-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    font-family: var(--font-mono); font-size: 0.75rem; color: var(--muted);
  }
  .reports-table-header span { color: var(--accent); font-weight: 700; }
  .reports-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  .reports-table th {
    text-align: left; padding: 9px 12px; color: var(--muted);
    font-size: 0.68rem; font-family: var(--font-mono); letter-spacing: 1px;
    text-transform: uppercase; border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }
  .reports-table td { padding: 9px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .reports-table tr:last-child td { border-bottom: none; }
  .reports-table tr:hover td { background: var(--surface2); }

  /* Print styles */
  @media print {
    body > *:not(#printArea) { display: none !important; }
    #printArea {
      display: block !important; position: fixed; inset: 0;
      background: #fff; color: #000; padding: 20px; font-size: 12px;
    }
    #printArea table { width: 100%; border-collapse: collapse; }
    #printArea th, #printArea td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
    #printArea th { background: #f0f0f0; font-weight: bold; }
    #printArea .print-header { margin-bottom: 16px; }
    #printArea .print-title { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
    #printArea .print-sub { font-size: 11px; color: #555; }
  }
  #printArea { display: none; }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ AUTH OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="authOverlay">
  <div class="auth-card">
    <div class="auth-logo">INV<span>//</span>CTRL</div>
    <div class="auth-subtitle">Sistema de controle de invent√°rio</div>

    <div id="authErr" class="auth-err"></div>

    <div class="auth-field">
      <label>Usu√°rio</label>
      <input class="auth-input" id="loginUser" type="text" placeholder="seu usu√°rio" autocomplete="username">
    </div>
    <div class="auth-field">
      <label>Senha</label>
      <input class="auth-input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn-auth" onclick="doLogin()">ENTRAR ‚Üí</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="adminOverlay" style="display:none;position:fixed;inset:0;z-index:900;background:rgba(13,15,20,0.92);align-items:center;justify-content:center;padding:20px;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;padding:32px 30px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <div>
        <div style="font-family:var(--font-mono);color:var(--accent);font-size:0.9rem;letter-spacing:2px;">PAINEL ADMIN</div>
        <div style="font-size:0.74rem;color:var(--muted);font-family:var(--font-mono);margin-top:2px;">Gerenciamento de usu√°rios</div>
      </div>
      <button onclick="closeAdmin()" style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.25);color:var(--warn);padding:6px 13px;border-radius:7px;font-family:var(--font-mono);font-size:0.75rem;cursor:pointer;">‚úï Fechar</button>
    </div>

    <!-- User list -->
    <div style="margin-bottom:24px;">
      <div style="font-size:0.72rem;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Usu√°rios cadastrados</div>
      <div id="adminUserList"></div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin-bottom:22px;">

    <!-- Add user -->
    <div style="font-size:0.72rem;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;">Adicionar usu√°rio</div>
    <div id="adminErr" class="auth-err"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="auth-field"><label>Nome completo</label><input class="auth-input" id="regName" type="text" placeholder="Jo√£o Silva"></div>
      <div class="auth-field"><label>Usu√°rio</label><input class="auth-input" id="regUser" type="text" placeholder="joaosilva"></div>
      <div class="auth-field"><label>Senha</label><input class="auth-input" id="regPass" type="password" placeholder="m√≠n. 6 caracteres"></div>
      <div class="auth-field"><label>Confirmar senha</label><input class="auth-input" id="regPass2" type="password" placeholder="repita a senha"></div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <label style="display:flex;align-items:center;gap:7px;font-family:var(--font-mono);font-size:0.75rem;color:var(--muted);cursor:pointer;">
        <input type="checkbox" id="regIsAdmin" style="accent-color:var(--accent)"> Admin
      </label>
      <button class="btn-auth" style="flex:1" onclick="doRegister()">ADICIONAR USU√ÅRIO ‚Üí</button>
    </div>

    <!-- Change password -->
    <hr style="border:none;border-top:1px solid var(--border);margin:22px 0;">
    <div style="font-size:0.72rem;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;">Alterar senha de usu√°rio</div>
    <div id="adminPassErr" class="auth-err"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="auth-field"><label>Usu√°rio</label>
        <select class="auth-input" id="chgUser" style="cursor:pointer;"></select>
      </div>
      <div class="auth-field"><label>Nova senha</label><input class="auth-input" id="chgPass" type="password" placeholder="m√≠n. 6 caracteres"></div>
      <div class="auth-field"><label>Confirmar</label><input class="auth-input" id="chgPass2" type="password" placeholder="repita"></div>
    </div>
    <button class="btn-auth" onclick="doChangePass()" style="background:rgba(0,119,255,0.15);color:var(--accent2);border:1px solid rgba(0,119,255,0.3);">ALTERAR SENHA ‚Üí</button>
  </div>
</div>


<!-- ‚îÄ‚îÄ NAVIGATION SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="navScreen">
  <!-- top bar with user info and logout -->
  <div style="position:absolute;top:0;left:0;right:0;padding:16px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--surface);">
    <div style="font-family:var(--font-mono);font-size:0.9rem;color:var(--accent);letter-spacing:2px;">INV<span style="color:var(--muted)">//</span>CTRL</div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span style="font-family:var(--font-mono);font-size:0.75rem;color:var(--muted);">üë§ <strong id="navUserName" style="color:var(--text)"></strong></span>
      <button onclick="doLogout()" style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.25);color:var(--warn);padding:5px 12px;border-radius:6px;font-size:0.73rem;font-weight:600;cursor:pointer;font-family:var(--font-mono);transition:all 0.2s;">Sair</button>
    </div>
  </div>

  <div style="text-align:center;margin-top:20px;">
    <div class="nav-subtitle">Selecione uma op√ß√£o para continuar</div>
    <div class="nav-sync-status" style="justify-content:center;margin-top:10px;">
      <div class="dot" id="navSyncDot"></div>
      <span id="navSyncLabel">Carregando dados...</span>
    </div>
  </div>

  <div class="nav-cards">
    <div class="nav-card inv" onclick="goTo('inventory')">
      <span class="nav-card-icon">üì¶</span>
      <div class="nav-card-title">INVENT√ÅRIO</div>
      <div class="nav-card-desc">Consulte, edite e gerencie todos os itens carregados da planilha.</div>
    </div>
    <div class="nav-card chart" onclick="goTo('charts')">
      <span class="nav-card-icon">üìä</span>
      <div class="nav-card-title">GR√ÅFICOS</div>
      <div class="nav-card-desc">Visualize o percentual de itens Moderados em rela√ß√£o ao total.</div>
    </div>
    <div class="nav-card" style="border-color:var(--border)" onclick="goTo('reports')"
      onmouseenter="this.style.borderColor='#a855f7';this.style.boxShadow='0 8px 32px rgba(168,85,247,0.12)';this.style.transform='translateY(-4px)'"
      onmouseleave="this.style.borderColor='var(--border)';this.style.boxShadow='';this.style.transform=''">
      <span class="nav-card-icon">üóÇÔ∏è</span>
      <div class="nav-card-title" style="color:#a855f7">RELAT√ìRIOS</div>
      <div class="nav-card-desc">Filtre, visualize e imprima relat√≥rios personalizados da planilha.</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ CHART SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="chartScreen">
  <div class="chart-header">
    <button class="btn-back" onclick="goTo('nav')">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
      Voltar
    </button>
    <div style="font-family:var(--font-mono);font-size:0.85rem;color:var(--accent);letter-spacing:2px;">GR√ÅFICOS</div>
    <div style="margin-left:auto;font-family:var(--font-mono);font-size:0.72rem;color:var(--muted)" id="chartLastSync"></div>
  </div>
  <div class="chart-body">
    <div id="chartContent"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ INVENTORY SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="inventoryScreen" style="display:none;">
<header>
  <button class="btn-back" onclick="goTo('nav')" style="margin-right:8px;">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <polyline points="15 18 9 12 15 6"/>
    </svg>
    Menu
  </button>
  <div class="logo">INV<span>//</span>CTRL</div>
  <div class="stats">
    <span>Total: <strong id="statTotal">0</strong></span>
    <span>Consolidados: <strong id="statLocked">0</strong></span>
    <span id="statLow" style="display:none"></span>
  </div>
  <div class="user-badge">
    <span>üë§ <strong id="headerUser"></strong></span>
    <button id="btnAdminPanel" onclick="openAdmin()" style="display:none;background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.3);color:var(--accent);padding:4px 10px;border-radius:6px;font-size:0.72rem;font-weight:600;cursor:pointer;font-family:var(--font-mono);">‚öô Admin</button>
    <!-- Notification bell ‚Äî shown for admins only -->
    <div id="notifWrap" style="display:none;position:relative;">
      <button id="btnNotif" onclick="toggleNotifPanel()"
        style="background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.25);color:var(--accent);
               width:30px;height:30px;border-radius:6px;font-size:0.9rem;cursor:pointer;
               display:flex;align-items:center;justify-content:center;position:relative;transition:all 0.2s;"
        title="Notifica√ß√µes">
        üîî
        <span id="notifBadge"
          style="display:none;position:absolute;top:-5px;right:-5px;background:var(--warn);color:#fff;
                 border-radius:50%;width:16px;height:16px;font-size:0.6rem;font-weight:700;
                 align-items:center;justify-content:center;font-family:var(--font-mono);">0</span>
      </button>
      <div id="notifPanel"
        style="display:none;position:absolute;right:0;top:38px;width:300px;
               background:var(--surface);border:1px solid var(--border);border-radius:12px;
               z-index:500;box-shadow:0 8px 32px rgba(0,0,0,0.4);overflow:hidden;">
      </div>
    </div>
    <button class="btn-logout" onclick="doLogout()">Sair</button>
  </div>
</header>

<div class="sync-bar">
  <div class="sync-status">
    <div class="dot" id="syncDot"></div>
    <span id="syncLabel">N√£o sincronizado</span>
  </div>
  <span id="lastSync" style="color:var(--muted);font-size:0.74rem;font-family:var(--font-mono)"></span>
  <button class="btn-file" onclick="document.getElementById('fileInput').click()">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    Carregar Arquivo
  </button>
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="loadLocalFile(event)">
  <button class="btn-sync" id="btnSync" onclick="syncSheet()">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
    </svg>
    Sincronizar Planilha
  </button>
  <button class="btn-publish" id="btnPublish" onclick="publishChanges()" style="display:none">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
      <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
    </svg>
    Publicar Altera√ß√µes <span id="pendingCount"></span>
  </button>
</div>

<div id="colInfo" style="display:none"><span id="colInfoText"></span></div>

<div class="toolbar">
  <div class="search-wrap">
    <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    <input class="search-input" id="searchInput" type="text" placeholder="Buscar em qualquer coluna..." onkeydown="if(event.key==='Enter') doSearch()">
  </div>
  <button class="btn btn-search" onclick="doSearch()">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    Buscar
  </button>
  <button class="btn" style="background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.3);color:var(--accent)" onclick="openScanner()" title="Ler c√≥digo de barras">
    <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
      <circle cx="12" cy="13" r="4"/>
    </svg>
    C√¢mera
  </button>
  <button class="btn btn-add" onclick="addRow()">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    Novo Item
  </button>
</div>

<div class="filter-tabs">
  <button class="filter-tab active" onclick="setFilter('all',this)">Todos</button>
  <button class="filter-tab" onclick="setFilter('ok',this)">ATIVO</button>
  <button class="filter-tab" onclick="setFilter('low',this)">Baixo estoque</button>
  <button class="filter-tab" onclick="setFilter('out',this)">Sem estoque</button>
  <button class="filter-tab" onclick="setFilter('locked',this)">Consolidados</button>
</div>

<div class="table-wrap">
  <table>
    <thead><tr id="tHead"></tr></thead>
    <tbody id="tBody"></tbody>
  </table>
  <div class="empty" id="emptyState">
    <h3 id="emptyTitle">Pronto para conectar!</h3>
    <p id="emptyMsg">Clique em <strong style="color:var(--accent)">Sincronizar Planilha</strong> para carregar<br>seus dados do Google Sheets automaticamente.</p>
  </div>
  <div class="empty" id="searchPrompt" style="display:none;">
    <div style="font-size:2.5rem;margin-bottom:16px;">üîç</div>
    <h3>Digite para buscar</h3>
    <p>Use a barra de pesquisa acima para localizar itens.<br>
    <span style="color:var(--muted);font-family:var(--font-mono);font-size:0.75rem;">
      <strong id="searchPromptCount" style="color:var(--accent)">0</strong> itens carregados
    </span></p>
  </div>
</div>

</div><!-- /inventoryScreen -->

<!-- ‚îÄ‚îÄ REPORTS SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="reportsScreen">
  <div class="reports-header">
    <button class="btn-back" onclick="goTo('nav')">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
      Menu
    </button>
    <div style="font-family:var(--font-mono);font-size:0.85rem;color:#a855f7;letter-spacing:2px;">RELAT√ìRIOS</div>
    <div style="margin-left:auto;font-family:var(--font-mono);font-size:0.72rem;color:var(--muted)" id="reportsSyncLabel"></div>
  </div>
  <div class="reports-body">
    <div class="reports-filters">
      <div class="reports-filter-title">‚öô Filtros do relat√≥rio</div>
      <div class="reports-filter-grid" id="reportsFilterGrid">
        <div class="reports-filter-item">
          <label>Status</label>
          <select class="reports-filter-select" id="rFilterStatus">
            <option value="all">Todos</option>
            <option value="ok">ATIVO</option>
            <option value="low">Baixo estoque</option>
            <option value="out">Sem estoque</option>
            <option value="locked">Consolidados</option>
          </select>
        </div>
        <div class="reports-filter-item">
          <label>Busca geral</label>
          <input class="reports-filter-input" id="rFilterSearch" type="text" placeholder="Qualquer campo...">
        </div>
      </div>
      <div class="reports-actions">
        <button class="btn-reports-apply" onclick="applyReportFilter()">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          Aplicar filtros
        </button>
        <button class="btn-reports-print" onclick="printReport()">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
            <rect x="6" y="14" width="12" height="8"/>
          </svg>
          Imprimir relat√≥rio
        </button>
        <button class="btn-reports-clear" onclick="clearReportFilter()">Limpar filtros</button>
      </div>
    </div>

    <div class="reports-summary" id="reportsSummary"></div>

    <div class="reports-table-wrap">
      <div class="reports-table-header">
        <div>Resultados: <span id="reportsCount">0</span> itens</div>
        <div id="reportsActiveFilters" style="color:var(--muted);font-size:0.7rem;"></div>
      </div>
      <div style="overflow-x:auto">
        <table class="reports-table" id="reportsTable">
          <thead><tr id="reportsHead"></tr></thead>
          <tbody id="reportsBody"></tbody>
        </table>
      </div>
      <div id="reportsEmpty" style="display:none;text-align:center;padding:50px 20px;color:var(--muted);">
        <div style="font-size:2rem;margin-bottom:12px;">üóÇÔ∏è</div>
        <div style="font-family:var(--font-mono);font-size:0.85rem;">Nenhum resultado encontrado</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="confirmModal">
  <div class="confirm-card">
    <span class="confirm-icon">üîí</span>
    <div class="confirm-title">CONSOLIDAR ITEM</div>
    <div class="confirm-msg" id="confirmMsg">
      Tem certeza que deseja consolidar este item?<br>
      <strong>Esta a√ß√£o n√£o pode ser desfeita por usu√°rios comuns.</strong>
    </div>
    <div class="confirm-btns">
      <button class="btn-confirm-yes" id="confirmYesBtn">Sim, consolidar</button>
      <button class="btn-confirm-no" onclick="closeConfirm()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SCANNER MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="scannerModal">
  <div class="scanner-card">
    <div class="scanner-header">
      <span class="scanner-title">üì∑ LEITOR DE C√ìDIGO DE BARRAS</span>
      <button class="scanner-close" onclick="closeScanner()">‚úï</button>
    </div>
    <div class="scanner-video-wrap">
      <video id="scannerVideo" playsinline autoplay muted></video>
      <div class="scanner-crosshair">
        <div class="scanner-crosshair-line"></div>
      </div>
    </div>
    <div class="scanner-status" id="scannerStatus">Aponte a c√¢mera para o c√≥digo de barras</div>
    <div class="scanner-result" id="scannerResultBox" style="display:none">
      <div class="scanner-result-label">C√ìDIGO DETECTADO</div>
      <div class="scanner-result-value" id="scannerResultVal"></div>
    </div>
    <div class="scanner-actions">
      <button class="btn-scanner-use" id="btnUseCode" disabled onclick="useScannedCode()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        Usar c√≥digo para buscar
      </button>
      <button class="btn-scanner-retry" onclick="restartScanner()">‚Ü∫ Novo scan</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ PRINT AREA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="printArea"></div>
  <div class="spinner"></div>
  <div class="loading-text" id="loadText">Conectando...</div>
</div>

<div id="toast"></div>

<script>
// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SESSION_KEY = 'invctr_session';
const USERS_SHEET_NAME = 'Usu√°rios';
const DEFAULT_ADMIN = { user: 'ericson', name: 'Ericson Cardoso', hash: btoa('123456'), admin: true };

// In-memory users cache loaded from Sheets
let usersCache = null;

function getSession() { try { return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); } catch { return null; } }
function saveSession(s) { localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }

function authErr(msg) {
  const el = document.getElementById('authErr');
  el.textContent = msg; el.classList.toggle('show', !!msg);
}
function adminErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.classList.toggle('show', !!msg);
}

// ‚îÄ‚îÄ USERS SHEET HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Colunas: usuario | nome | hash | admin
async function loadUsersFromSheet() {
  try {
    // Verifica se a aba Usu√°rios existe
    const meta = await sheetsAPI('');
    const userSheet = meta.sheets?.find(s => s.properties.title === USERS_SHEET_NAME);

    if (!userSheet) {
      await createUsersSheet();
      usersCache = buildDefaultUsers();
      return usersCache;
    }

    const json = await sheetsAPI(
      `/values/${encodeURIComponent(USERS_SHEET_NAME)}!A1:D200`
    );
    const rows = json.values || [];

    if (rows.length < 2) {
      await writeUsersToSheet(buildDefaultUsers());
      usersCache = buildDefaultUsers();
      return usersCache;
    }

    const users = {};
    rows.slice(1).forEach(r => {
      if (!r[0]) return;
      users[r[0]] = { name: r[1] || '', hash: r[2] || '', admin: r[3] === 'true' };
    });

    // Garante que o admin padr√£o sempre existe
    if (!users[DEFAULT_ADMIN.user]) {
      users[DEFAULT_ADMIN.user] = { name: DEFAULT_ADMIN.name, hash: DEFAULT_ADMIN.hash, admin: true };
      await writeUsersToSheet(users);
    }

    usersCache = users;
    return users;
  } catch(e) {
    console.error('Erro ao carregar usu√°rios:', e);
    usersCache = buildDefaultUsers();
    return usersCache;
  }
}

function buildDefaultUsers() {
  return { [DEFAULT_ADMIN.user]: { name: DEFAULT_ADMIN.name, hash: DEFAULT_ADMIN.hash, admin: true } };
}

async function createUsersSheet() {
  // Cria a aba Usu√°rios via batchUpdate
  await sheetsAPI(':batchUpdate', {
    method: 'POST',
    body: JSON.stringify({ requests: [{ addSheet: { properties: { title: USERS_SHEET_NAME } } }] })
  });
  await writeUsersToSheet(buildDefaultUsers());
}

async function writeUsersToSheet(users) {
  const rows = [['usuario','nome','hash','admin']];
  Object.entries(users).forEach(([k, u]) => {
    rows.push([k, u.name || '', u.hash || '', String(!!u.admin)]);
  });
  const range = `${USERS_SHEET_NAME}!A1:D${rows.length}`;
  await sheetsAPI(
    `/values/${encodeURIComponent(range)}?valueInputOption=RAW`,
    {
      method: 'PUT',
      body: JSON.stringify({ range, majorDimension: 'ROWS', values: rows })
    }
  );
  usersCache = users;
}

async function saveUsersToSheet(users) {
  try {
    await writeUsersToSheet(users);
  } catch(e) {
    showToast('‚ö†Ô∏è Erro ao salvar usu√°rios na planilha: ' + e.message, true);
    console.error(e);
  }
}

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin() {
  const user = document.getElementById('loginUser').value.trim().toLowerCase();
  const pass = document.getElementById('loginPass').value;
  if (!user || !pass) return authErr('Preencha usu√°rio e senha.');

  authErr('');
  const btn = document.querySelector('.btn-auth');
  btn.textContent = 'Aguarde...'; btn.disabled = true;

  try {
    const users = await loadUsersFromSheet();
    if (!users[user]) return authErr('Usu√°rio n√£o encontrado.');
    if (users[user].hash !== btoa(pass)) return authErr('Senha incorreta.');
    saveSession({ user, name: users[user].name, admin: !!users[user].admin });
    showApp(users[user].name, !!users[user].admin);
  } catch(e) {
    authErr('Erro ao conectar. Tente novamente.');
  } finally {
    btn.textContent = 'ENTRAR ‚Üí'; btn.disabled = false;
  }
}

function showApp(name, isAdmin) {
  document.getElementById('authOverlay').classList.add('hidden');
  document.getElementById('headerUser').textContent = name;
  document.getElementById('navUserName').textContent = name;
  document.getElementById('btnAdminPanel').style.display = isAdmin ? '' : 'none';
  // Show notification bell only for admins
  const notifWrap = document.getElementById('notifWrap');
  if (notifWrap) notifWrap.style.display = isAdmin ? '' : 'none';
  if (isAdmin) updateNotifBadge();
  goTo('nav');
  setTimeout(() => { syncSheet().then(() => updateNavSync()); }, 300);
}

function doLogout() {
  localStorage.removeItem(SESSION_KEY);
  usersCache = null;
  document.getElementById('navScreen').classList.remove('active');
  document.getElementById('inventoryScreen').style.display = 'none';
  document.getElementById('chartScreen').classList.remove('active');
  document.getElementById('authOverlay').classList.remove('hidden');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  authErr('');
}

// ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openAdmin() {
  const s = getSession();
  if (!s || !s.admin) return showToast('‚ùå Acesso negado', true);
  document.getElementById('adminOverlay').style.display = 'flex';
  setLoad(true, 'Carregando usu√°rios...');
  await loadUsersFromSheet();
  setLoad(false);
  renderAdminUsers();
  refreshChgSelect();
  adminErr('adminErr', '');
  adminErr('adminPassErr', '');
}

function closeAdmin() {
  document.getElementById('adminOverlay').style.display = 'none';
  ['regName','regUser','regPass','regPass2','chgPass','chgPass2'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '';
  });
}

function renderAdminUsers() {
  const users = usersCache || {};
  const session = getSession();
  const list = document.getElementById('adminUserList');
  const entries = Object.entries(users);
  if (!entries.length) { list.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;font-family:var(--font-mono);">Nenhum usu√°rio.</div>'; return; }
  list.innerHTML = entries.map(([key, u]) => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:9px 13px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;">
      <div>
        <span style="font-weight:600;color:var(--text);font-size:0.86rem;">${u.name}</span>
        <span style="font-family:var(--font-mono);font-size:0.72rem;color:var(--muted);margin-left:9px;">@${key}</span>
        ${u.admin ? '<span style="font-family:var(--font-mono);font-size:0.68rem;color:var(--accent);margin-left:7px;background:rgba(0,229,160,0.1);padding:2px 7px;border-radius:10px;">ADMIN</span>' : ''}
      </div>
      ${key !== session?.user ? `<button onclick="deleteUser('${key}')" style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.2);color:var(--warn);padding:3px 9px;border-radius:5px;font-size:0.72rem;cursor:pointer;font-family:var(--font-mono);">Remover</button>` : '<span style="font-size:0.7rem;color:var(--muted);font-family:var(--font-mono);">(voc√™)</span>'}
    </div>`).join('');
}

function refreshChgSelect() {
  const users = usersCache || {};
  const sel = document.getElementById('chgUser');
  sel.innerHTML = Object.entries(users).map(([k,u]) => `<option value="${k}">${u.name} (@${k})</option>`).join('');
}

async function deleteUser(key) {
  const session = getSession();
  if (key === session?.user) return showToast('‚ùå N√£o √© poss√≠vel remover a si mesmo.', true);
  const users = usersCache || {};
  const name = users[key]?.name || key;
  delete users[key];
  await saveUsersToSheet(users);
  showToast(`üóë Usu√°rio "${name}" removido.`);
  renderAdminUsers();
  refreshChgSelect();
}

async function doRegister() {
  const name = document.getElementById('regName').value.trim();
  const user = document.getElementById('regUser').value.trim().toLowerCase();
  const pass = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  const isAdmin = document.getElementById('regIsAdmin').checked;
  if (!name || !user || !pass) return adminErr('adminErr', 'Preencha todos os campos.');
  if (!/^[a-z0-9_]+$/.test(user)) return adminErr('adminErr', 'Usu√°rio: apenas letras, n√∫meros e _');
  if (pass.length < 6) return adminErr('adminErr', 'Senha m√≠nima: 6 caracteres.');
  if (pass !== pass2) return adminErr('adminErr', 'As senhas n√£o coincidem.');
  const users = usersCache || {};
  if (users[user]) return adminErr('adminErr', 'Usu√°rio j√° cadastrado.');
  users[user] = { name, hash: btoa(pass), admin: isAdmin };
  await saveUsersToSheet(users);
  adminErr('adminErr', '');
  ['regName','regUser','regPass','regPass2'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('regIsAdmin').checked = false;
  showToast(`‚úÖ Usu√°rio "${name}" salvo na planilha!`);
  renderAdminUsers();
  refreshChgSelect();
}

async function doChangePass() {
  const user = document.getElementById('chgUser').value;
  const pass = document.getElementById('chgPass').value;
  const pass2 = document.getElementById('chgPass2').value;
  if (!user || !pass) return adminErr('adminPassErr', 'Selecione o usu√°rio e informe a nova senha.');
  if (pass.length < 6) return adminErr('adminPassErr', 'Senha m√≠nima: 6 caracteres.');
  if (pass !== pass2) return adminErr('adminPassErr', 'As senhas n√£o coincidem.');
  const users = usersCache || {};
  if (!users[user]) return adminErr('adminPassErr', 'Usu√°rio n√£o encontrado.');
  users[user].hash = btoa(pass);
  await saveUsersToSheet(users);
  adminErr('adminPassErr', '');
  document.getElementById('chgPass').value = '';
  document.getElementById('chgPass2').value = '';
  showToast(`‚úÖ Senha de "${users[user].name}" alterada na planilha!`);
}

// Check existing session on load
(function checkSession() {
  const s = getSession();
  if (s) { showApp(s.name, s.admin); }
})();

// ‚îÄ‚îÄ LOCAL FILE LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadLocalFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = ''; // reset so same file can be re-loaded
  const ext = file.name.split('.').pop().toLowerCase();
  setLoad(true, `Carregando "${file.name}"...`);
  const reader = new FileReader();

  if (ext === 'csv') {
    reader.onload = e => {
      try {
        processRows(parseCSV(e.target.result), file.name);
      } catch(err) {
        showToast('‚ùå Erro ao ler CSV: ' + err.message, true);
      } finally { setLoad(false); }
    };
    reader.readAsText(file, 'UTF-8');
  } else if (ext === 'xlsx' || ext === 'xls') {
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        processRows(rows.map(r => r.map(c => String(c ?? ''))), file.name);
      } catch(err) {
        showToast('‚ùå Erro ao ler Excel: ' + err.message, true);
      } finally { setLoad(false); }
    };
    reader.readAsArrayBuffer(file);
  } else {
    setLoad(false);
    showToast('‚ùå Formato n√£o suportado. Use CSV ou Excel.', true);
  }
}

function processRows(rows, filename) {
  if (!rows || rows.length < 2) throw new Error('Arquivo vazio ou sem dados.');
  headers = rows[0].map(h => String(h).trim()).filter(Boolean);
  const qIdx = headers.findIndex(h => /qtd|quant|quantidade|qty|estoque|stock/i.test(h));
  const qCol = qIdx >= 0 ? headers[qIdx] : null;
  const mColIdx = headers.findIndex(h => h.trim().toLowerCase() === 'moderado');
  const mColName = mColIdx >= 0 ? headers[mColIdx] : null;
  data = rows.slice(1)
    .filter(r => r.some(c => c && String(c).trim()))
    .map(row => {
      const obj = { _id: nextId++, _locked: false, _qCol: qCol };
      headers.forEach((h, i) => { obj[h] = row[i] !== undefined ? String(row[i]) : ''; });
      // Auto-lock if Moderado === 'SIM'
      if (mColName && String(obj[mColName] || '').trim().toUpperCase() === 'SIM') {
        obj._locked = true;
      }
      return obj;
    });
  document.getElementById('colInfoText').textContent = headers.join(' ¬∑ ');
  // colInfo hidden
  setSyncState('ok', `Arquivo local ¬∑ ${data.length} itens`);
  document.getElementById('lastSync').textContent = `"${filename}" ¬∑ ${new Date().toLocaleTimeString('pt-BR')}`;
  showToast(`‚úÖ ${data.length} itens carregados de "${filename}"`);
  render();
}

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHEET_ID = '1Wh50lTf9TFOz0-RyjS1g28A47_VsuP5MJXkGma67-zI';

const SA = {
  email: 'inventario@invetario2.iam.gserviceaccount.com',
  key: `MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCuE+JyaPridKbP
O0mFVX5xwakOzj46wEMhT0IxhdDT4CekI2EnjuUeiAoR+DmB5oWA9AHmiyy1RM6Q
Owm+BxFZR4BVPVAQk2zEi20hUvlwnlIZN85DnvDpdupn+yrQoFyxSVOXWqUnZcf7
i1A1UU0LfrEAtLd4EfE5SvTxoDMQ4egHDps3PqCU9nZD3fkUtt+Z/CBqihon9Voa
02+rlZfVrEhnlvJoetCPQvtYUfmdIpsCht6yJTeIa0hoheGLQvQDdIi1gO6FLb67
OGL1JvLOagVz0ZPjRlMF8hcvaWZrnwSRwvT+mQLj9+5kkDD1B4k/DHlF1997X21S
A5cJylZZAgMBAAECggEAHO1w/qeItC5uX0Ga621USyhuJOe2Wk0DhXrbpR8iShNA
gyYzSZTqvjLHzvSmRHqU9OOXl+1zddaup4koCqFiC1QLyh5w5PrwDY6d3qEgknZn
bjQNMsTW2Up0PuieKiJ773of9KbmNbB+6xjbhgCyAkGraFKfqnRQ1xR9tSl0qE6b
60X2dQIYHmqJMeMW5H7fmVOTYJ+RmRF7QzCmGXRUzLNVs22CWQaL6N7OkqizjJr/
HgF7jfm1JnnORlbrmD0h6Amuexx9YQ2+MLN13ntCmI14cf5DxDVlV1jMmY9X7a+w
YR9pme+e1vVXtvStbdwaRB0mrHRPv2bFhtMFkj5pgQKBgQDa3q+9UzggvHn/QmMC
Si6sb0dliGI5AVN/C2Qec5BmG2Zd0kYq+GQl/JmwU1y6gT1Tu2i611iq9aUfKy04
5X46hJzG3SmihjH24VCeN7BYAl2J2xISeggFSK2QLEylBOrb9tpnjINW/l+eG+Kr
hEJmV8U1idPOkxo+o5IsLNSGpwKBgQDLm+o8CM7HSwJt0AwvBzMaxzcQaRtqec3C
AJy7iyT0Bc3CDlhKax2SI9Xfy76w8W4nmVg2C7GlpHmzZBaLdOu54BstTCxY11tU
DGO6Sfk2ScpkCkxoh740XcgR/TCnZQUw/FLc1Yjtr3ae+egXDsJwH+U5erEphHMz
oJO6OOLa/wKBgBjggMcbI2ENKyypRgmnluCAkXPn6YojLXNePxX6+qmwaZU2ZkVS
EEgFCw7wmrSUJf1Tatb5zRk5bHg7dxtlclCCbDNqReY0LI+sEna5S7DlK+6UWNyC
xFCdbyTY9Ck5gtxXlYF5hiAoL4QQFVZ7ZPSu+zpXnRx4ud3ux5l/yvQ3AoGBAK0U
8k5sclLqCbuN0v2bUi8eUEnL/7lIp8eWO6YVx6kE0f93sEg6vF2BxwrCqWzDH4/c
BCeVU0NrCOWdXKjaEJTm1FNyYHR5RbKyAYjX31jt63WVZ5SoZ+EeI7hfEiAKeRpG
NK5zez4KHX1RFaGcM1+bTYHKMZYIeOHXTB1OxFHDAoGAEGwrlF2gYH6fwGFrjhjK
RwO5/YQEyCNvHn3KjwOcFW7e5CTnMh4baOtR2wLQWuvJYnPh0NblrQBdyX+IFk7c
JkwVQ9B2+GtSripk8pREQgJm3Zt8OwwJP0MkEM+Xm1hf3f1AlIICGxpmALsN+QoP
Uvx2ldx0l6Pznan3XUum4TI=`
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let data = [], headers = [], nextId = 1, filterState = 'all';
let cachedToken = null, tokenExpiry = 0;
let cachedSheetName = null;          // ‚Üê cache do nome da aba principal
let pendingChanges = new Set();
let sheetRowMap = [];

// ‚îÄ‚îÄ SHEETS API LAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Centraliza todas as chamadas √† API. Lan√ßa erro com mensagem leg√≠vel.
async function sheetsAPI(path, options = {}) {
  const token = await getToken();
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}${path}`;
  const res = await fetch(url, {
    ...options,
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json',
      ...(options.headers || {})
    }
  });
  if (!res.ok) {
    let msg = `HTTP ${res.status}`;
    try { const e = await res.clone().json(); msg = e.error?.message || msg; } catch(_) {}
    throw new Error(msg);
  }
  return res.json();
}

// Retorna o nome da primeira aba, usando cache para evitar chamadas repetidas.
async function getMainSheetName(forceRefresh = false) {
  if (cachedSheetName && !forceRefresh) return cachedSheetName;
  const meta = await sheetsAPI('');
  // Primeira aba que N√ÉO seja a aba de usu√°rios
  const sheet = meta.sheets?.find(s => s.properties.title !== USERS_SHEET_NAME)
             || meta.sheets?.[0];
  cachedSheetName = sheet?.properties?.title || 'Sheet1';
  return cachedSheetName;
}

// Retorna letra(s) de coluna: 1‚ÜíA, 27‚ÜíAA
function colLetter(n) {
  let s = '';
  while (n > 0) { s = String.fromCharCode(64 + (n % 26 || 26)) + s; n = Math.floor((n - 1) / 26); }
  return s;
}

// ‚îÄ‚îÄ JWT AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function b64u(str) { return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,''); }
function b64uBuf(buf) {
  let s = ''; new Uint8Array(buf).forEach(b => s += String.fromCharCode(b));
  return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

async function getToken() {
  if (cachedToken && Date.now() < tokenExpiry - 60000) return cachedToken;

  const now = Math.floor(Date.now() / 1000);
  const hdr = b64u(JSON.stringify({ alg: 'RS256', typ: 'JWT' }));
  const pay = b64u(JSON.stringify({
    iss: SA.email,
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    aud: 'https://oauth2.googleapis.com/token',
    exp: now + 3600,
    iat: now
  }));
  const msg = `${hdr}.${pay}`;

  // Remove PEM headers/footers e qualquer whitespace ‚Äî funciona com ou sem eles
  const pemClean = SA.key
    .replace(/-----BEGIN[^-]+-----/g, '')
    .replace(/-----END[^-]+-----/g, '')
    .replace(/[\s\r\n]+/g, '');

  let der;
  try {
    der = Uint8Array.from(atob(pemClean), c => c.charCodeAt(0));
  } catch(e) {
    throw new Error('Chave privada inv√°lida (base64 corrompido). Verifique a SA.key.');
  }

  let ck;
  try {
    ck = await crypto.subtle.importKey(
      'pkcs8', der.buffer,
      { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
      false, ['sign']
    );
  } catch(e) {
    throw new Error('Falha ao importar chave privada: ' + e.message + '. Verifique se a chave √© PKCS8 (formato JSON da Service Account do Google).');
  }

  const sig = await crypto.subtle.sign(
    'RSASSA-PKCS1-v1_5', ck,
    new TextEncoder().encode(msg)
  );
  const jwt = `${msg}.${b64uBuf(sig)}`;

  let res;
  try {
    res = await fetch('https://oauth2.googleapis.com/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
    });
  } catch(e) {
    throw new Error('Sem conex√£o com o servidor Google. Verifique sua internet: ' + e.message);
  }

  if (!res.ok) {
    let detail = '';
    try {
      const j = await res.json();
      detail = j.error_description || j.error || JSON.stringify(j);
    } catch(_) { detail = await res.text().catch(() => res.status); }
    throw new Error(`Autentica√ß√£o Google falhou (${res.status}): ${detail}`);
  }

  const j = await res.json();
  if (!j.access_token) throw new Error('Resposta de auth inv√°lida ‚Äî sem access_token.');
  cachedToken = j.access_token;
  tokenExpiry = Date.now() + (j.expires_in || 3600) * 1000;
  return cachedToken;
}


// ‚îÄ‚îÄ CSV PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseCSV(text) {
  const rows = [];
  let row = [], cell = '', inQuote = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (inQuote) {
      if (c === '"' && text[i+1] === '"') { cell += '"'; i++; }
      else if (c === '"') { inQuote = false; }
      else { cell += c; }
    } else {
      if (c === '"') { inQuote = true; }
      else if (c === ',') { row.push(cell.trim()); cell = ''; }
      else if (c === '\n') { row.push(cell.trim()); rows.push(row); row = []; cell = ''; }
      else if (c === '\r') { /* skip */ }
      else { cell += c; }
    }
  }
  if (cell || row.length) { row.push(cell.trim()); rows.push(row); }
  return rows.filter(r => r.length > 0);
}

// ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncSheet() {
  const btn = document.getElementById('btnSync');
  btn.disabled = true;
  setSyncState('loading', 'Conectando...');
  setLoad(true, 'Autenticando com Google...');
  try {
    // For√ßa refresh do nome da aba (pode ter mudado)
    setLoad(true, 'Lendo estrutura da planilha...');
    const sheetName = await getMainSheetName(true);
    setLoad(true, `Carregando aba "${sheetName}"...`);

    const json = await sheetsAPI(
      `/values/${encodeURIComponent(sheetName)}!A1:ZZ10000`
    );
    const rows = json.values || [];
    if (rows.length < 2) throw new Error(`Aba "${sheetName}" est√° vazia ou sem dados al√©m do cabe√ßalho.`);

    headers = rows[0].map(h => String(h).trim());

    const qIdx = headers.findIndex(h => /qtd|quant|quantidade|qty|estoque|stock/i.test(h));
    const qCol = qIdx >= 0 ? headers[qIdx] : null;
    const mColIdx = headers.findIndex(h => h.trim().toLowerCase() === 'moderado');
    const mColName = mColIdx >= 0 ? headers[mColIdx] : null;

    data = rows.slice(1)
      .filter(r => r.some(c => c && String(c).trim()))
      .map((row, idx) => {
        const obj = { _id: nextId++, _locked: false, _qCol: qCol, _sheetRow: idx + 2 };
        headers.forEach((h, i) => { obj[h] = row[i] !== undefined ? String(row[i]) : ''; });
        if (mColName && String(obj[mColName] || '').trim().toUpperCase() === 'SIM') {
          obj._locked = true;
        }
        return obj;
      });

    pendingChanges = new Set();
    updatePublishBtn();

    document.getElementById('colInfoText').textContent = headers.join(' ¬∑ ');
    document.getElementById('syncDiagPanel')?.remove(); // limpa diagn√≥stico anterior
    setSyncState('ok', `Sincronizado ¬∑ ${data.length} itens`);
    document.getElementById('lastSync').textContent =
      '√öltima sync: ' + new Date().toLocaleTimeString('pt-BR');
    showToast(`‚úÖ ${data.length} itens carregados da aba "${sheetName}"`);
    render();
    updateNavSync();
  } catch(e) {
    setSyncState('error', 'Erro na sync');
    const msg = e.message || String(e);
    showToast('‚ùå ' + msg, true);
    console.error('syncSheet error:', e);
    // Painel de diagn√≥stico visual
    showSyncDiag(msg);
    updateNavSync();
  } finally {
    setLoad(false);
    btn.disabled = false;
  }
}

// ‚îÄ‚îÄ DIAGN√ìSTICO DE SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSyncDiag(errorMsg) {
  // Remove painel anterior se existir
  document.getElementById('syncDiagPanel')?.remove();

  // Classifica o tipo de erro para mostrar solu√ß√£o espec√≠fica
  let cause = '', solution = '';
  const m = errorMsg.toLowerCase();

  if (m.includes('chave privada') || m.includes('pkcs8') || m.includes('base64') || m.includes('importkey')) {
    cause = 'üîë Problema com a chave privada da Service Account';
    solution = `A chave no arquivo HTML pode estar truncada, corrompida ou no formato errado.<br><br>
      <strong>Como corrigir:</strong><br>
      1. Acesse o <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank" style="color:var(--accent2)">Google Cloud Console</a><br>
      2. Abra a Service Account ‚Üí Chaves ‚Üí Adicionar Chave ‚Üí JSON<br>
      3. No JSON baixado, copie o valor de <code style="color:var(--accent)">private_key</code><br>
      4. Cole no arquivo HTML substituindo o conte√∫do de <code style="color:var(--accent)">SA.key</code>`;
  } else if (m.includes('autentica√ß√£o google') || m.includes('auth') || m.includes('401') || m.includes('403')) {
    cause = 'üîê Falha de autentica√ß√£o com o Google';
    solution = `O token JWT foi gerado mas o Google rejeitou.<br><br>
      <strong>Verifique:</strong><br>
      1. O email da Service Account (<code style="color:var(--accent)">SA.email</code>) est√° correto<br>
      2. A planilha foi compartilhada com este email (Editor)<br>
      3. A Google Sheets API est√° ativada no projeto do Google Cloud<br>
      4. A chave n√£o foi revogada no console`;
  } else if (m.includes('sem conex√£o') || m.includes('failed to fetch') || m.includes('network')) {
    cause = 'üåê Sem conex√£o com a internet ou CORS bloqueado';
    solution = `O navegador bloqueou a requisi√ß√£o.<br><br>
      <strong>Verifique:</strong><br>
      1. Sua conex√£o com a internet est√° ativa<br>
      2. Se estiver testando localmente via <code>file://</code>, hospede em um servidor (GitHub Pages, Live Server)<br>
      3. Extens√µes do navegador n√£o est√£o bloqueando requisi√ß√µes externas`;
  } else if (m.includes('http 404') || m.includes('not found') || m.includes('sheet_id')) {
    cause = 'üìÑ Planilha n√£o encontrada';
    solution = `O SHEET_ID no c√≥digo n√£o corresponde a nenhuma planilha acess√≠vel.<br><br>
      <strong>Verifique:</strong><br>
      1. O <code style="color:var(--accent)">SHEET_ID</code> no HTML est√° correto<br>
      2. A planilha existe e n√£o foi exclu√≠da<br>
      3. A Service Account tem acesso a ela (compartilhe como Editor)`;
  } else if (m.includes('vazia') || m.includes('cabe√ßalho')) {
    cause = 'üìã Planilha sem dados';
    solution = `A aba principal da planilha est√° vazia ou s√≥ tem cabe√ßalho.<br><br>
      Adicione ao menos uma linha de dados abaixo do cabe√ßalho e tente novamente.`;
  } else {
    cause = '‚ö†Ô∏è Erro inesperado';
    solution = `Mensagem original: <code style="color:var(--warn)">${errorMsg}</code><br><br>
      Abra o Console do navegador (F12 ‚Üí Console) para mais detalhes.`;
  }

  const panel = document.createElement('div');
  panel.id = 'syncDiagPanel';
  panel.style.cssText = `
    margin: 16px 28px; background: rgba(255,107,53,0.06);
    border: 1px solid rgba(255,107,53,0.3); border-radius: 12px;
    padding: 18px 22px; font-size: 0.82rem; line-height: 1.7;
    font-family: var(--font-main);
  `;
  panel.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <strong style="color:var(--warn);font-family:var(--font-mono);font-size:0.78rem;letter-spacing:1px;">DIAGN√ìSTICO DE ERRO</strong>
      <button onclick="this.closest('#syncDiagPanel').remove()"
        style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;">‚úï</button>
    </div>
    <div style="color:var(--text);margin-bottom:10px;"><strong>${cause}</strong></div>
    <div style="color:var(--muted);">${solution}</div>
    <div style="margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,107,53,0.2);">
      <span style="font-family:var(--font-mono);font-size:0.68rem;color:var(--muted);">ERRO T√âCNICO:</span>
      <span style="font-family:var(--font-mono);font-size:0.7rem;color:var(--warn);margin-left:8px;">${errorMsg}</span>
    </div>`;

  // Insere ap√≥s a sync-bar
  const syncBar = document.querySelector('.sync-bar');
  if (syncBar) syncBar.after(panel);
}


  const d = document.getElementById('syncDot');
  d.className = 'dot' + (s==='ok'?' green':s==='loading'?' yellow':s==='error'?' red':'');
  document.getElementById('syncLabel').textContent = lbl;
}
function setLoad(show, txt='') {
  document.getElementById('loadOverlay').classList.toggle('show', show);
  if (txt) document.getElementById('loadText').textContent = txt;
}

// ‚îÄ‚îÄ PUBLISH CHANGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function publishChanges() {
  if (!pendingChanges.size) return showToast('‚ö†Ô∏è Nenhuma altera√ß√£o pendente.', true);

  const btn = document.getElementById('btnPublish');
  btn.disabled = true;
  setLoad(true, 'Publicando altera√ß√µes...');

  try {
    const sheetName = await getMainSheetName();

    // Monta o batchUpdate com todas as linhas modificadas
    const valueRanges = [];
    for (const id of pendingChanges) {
      const row = data.find(r => r._id === id);
      if (!row || !row._sheetRow) continue;
      const rowValues = headers.map(h => row[h] ?? '');
      const range = `${sheetName}!A${row._sheetRow}:${colLetter(headers.length)}${row._sheetRow}`;
      valueRanges.push({ range, values: [rowValues] });
    }

    if (!valueRanges.length) {
      showToast('‚ö†Ô∏è Nenhuma linha com refer√™ncia na planilha para publicar.', true);
      return;
    }

    await sheetsAPI('/values:batchUpdate', {
      method: 'POST',
      body: JSON.stringify({ valueInputOption: 'USER_ENTERED', data: valueRanges })
    });

    const count = pendingChanges.size;
    pendingChanges.clear();
    updatePublishBtn();
    const session = getSession();
    notifyAdminPublish(count, session?.name || 'Usu√°rio');
    showToast(`‚úÖ ${count} linha(s) publicada(s) na planilha!`);
    render();
  } catch(e) {
    showToast('‚ùå Erro ao publicar: ' + e.message, true);
    console.error('publishChanges error:', e);
  } finally {
    setLoad(false);
    btn.disabled = false;
  }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function qty(row) {
  if (!row._qCol) return null;
  const v = parseFloat(row[row._qCol]);
  return isNaN(v) ? null : v;
}
function status(row) {
  const q = qty(row);
  if (q === null) return 'ok';
  if (q <= 0) return 'out';
  if (q <= 10) return 'low';
  return 'ok';
}
function badge(row) {
  if (row._locked) return `<span class="badge badge-locked">üîí Consolidado</span>`;
  const s = status(row);
  if (s==='out') return `<span class="badge badge-out">‚óè Sem estoque</span>`;
  if (s==='low') return `<span class="badge badge-low">‚óè Baixo estoque</span>`;
  return `<span class="badge badge-ok">‚óè ATIVO</span>`;
}

function setFilter(f, el) {
  filterState = f;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  render();
}



// ‚îÄ‚îÄ ITEM DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Columns editable via dropdown
const DRAWER_DROPDOWN_COLS = ['equipamento','modelo','fabricante','setor','situa√ß√£o','situacao'];
// Columns that are dates
function isDateCol(h) {
  return /data|date|vencimento|validade|prazo|instala√ß√£o|instalacao|aquisi√ß√£o|aquisicao/i.test(h);
}
// Columns editable freely (dropdown + date + textarea)
const DRAWER_EDIT_COLS = ['equipamento','modelo','fabricante','setor','situa√ß√£o','situacao'];

function isDrawerDropdown(h) {
  return DRAWER_DROPDOWN_COLS.includes(h.trim().toLowerCase());
}
function isDrawerEdit(h) {
  return DRAWER_EDIT_COLS.includes(h.trim().toLowerCase()) || isDateCol(h);
}

function openDrawer(id) {
  const row = data.find(r => r._id === id);
  if (!row) return;

  document.getElementById('drawerBadge').innerHTML = badge(row);
  document.getElementById('drawerFields').innerHTML = headers.map(h => buildDrawerField(row, h)).join('');

  const acts = document.getElementById('drawerActions');
  acts.innerHTML = '';

  if (!row._locked) {
    acts.innerHTML += `<button class="btn-drawer-save-all" onclick="saveDrawerChanges(${id})">‚úÖ Salvar altera√ß√µes</button>`;
  }
  if (row._locked) {
    acts.innerHTML += `<button class="drawer-btn drawer-btn-unlock" onclick="unlock(${id});openDrawer(${id})">üîì Desconsolidar</button>`;
  } else {
    acts.innerHTML += `<button class="drawer-btn drawer-btn-cons" onclick="lock(${id})">üîí Consolidar</button>`;
    acts.innerHTML += `<button class="drawer-btn drawer-btn-save" onclick="saveRow(${id})">üíæ Salvar na planilha</button>`;
  }

  document.getElementById('itemDrawer').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function buildDrawerField(row, h) {
  const val = row[h] || '';
  const locked = row._locked;
  const isEdit = isDrawerEdit(h) || true; // all fields editable
  const isDD = isDrawerDropdown(h);
  const isDate = isDateCol(h);

  if (locked) {
    // Read-only when locked
    return `<div class="drawer-field readonly">
      <div class="drawer-field-label-row">
        <div class="drawer-field-label">${esc(h)}</div>
      </div>
      <div class="drawer-field-value${!val ? ' empty' : ''}">${val ? esc(val) : 'N√£o informado'}</div>
    </div>`;
  }

  if (isDate) {
    // Format value to YYYY-MM-DD for date input if possible
    let dateVal = '';
    if (val) {
      // Try DD/MM/YYYY ‚Üí YYYY-MM-DD
      const dmyMatch = val.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (dmyMatch) dateVal = `${dmyMatch[3]}-${dmyMatch[2].padStart(2,'0')}-${dmyMatch[1].padStart(2,'0')}`;
      else dateVal = val; // assume already ISO
    }
    return `<div class="drawer-field editable">
      <div class="drawer-field-label-row">
        <div class="drawer-field-label">${esc(h)}</div>
        <span class="drawer-date-tag">üìÖ DATA</span>
      </div>
      <input type="date" class="drawer-field-input"
        id="dfield_${row._id}_${escA(h)}"
        value="${dateVal}"
        onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">
    </div>`;
  }

  if (isDD) {
    const opts = getUniqueValues(h);
    return `<div class="drawer-field editable">
      <div class="drawer-field-label-row">
        <div class="drawer-field-label">${esc(h)}</div>
        <span class="drawer-edit-tag">EDIT√ÅVEL</span>
      </div>
      <div class="drawer-dropdown-wrap">
        <input type="text" class="drawer-field-input has-dropdown"
          id="dfield_${row._id}_${escA(h)}"
          value="${esc(val)}" placeholder="Digite ou selecione..."
          onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">
        <button class="drawer-dropdown-btn" onclick="showDrawerDropdown(event,${row._id},'${escA(h)}')"
          title="Ver op√ß√µes">
          <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
      </div>
    </div>`;
  }

  // Default: textarea for long text, input for short
  const isLong = val.length > 60;
  return `<div class="drawer-field editable">
    <div class="drawer-field-label-row">
      <div class="drawer-field-label">${esc(h)}</div>
      <span class="drawer-edit-tag">EDIT√ÅVEL</span>
    </div>
    ${isLong
      ? `<textarea class="drawer-field-textarea"
          id="dfield_${row._id}_${escA(h)}"
          onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">${esc(val)}</textarea>`
      : `<input type="text" class="drawer-field-input"
          id="dfield_${row._id}_${escA(h)}"
          value="${esc(val)}" placeholder="N√£o informado"
          onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">`
    }
  </div>`;
}

// Track drawer changes separately before committing
let drawerChanges = {};

function drawerFieldChange(id, col, val) {
  if (!drawerChanges[id]) drawerChanges[id] = {};
  drawerChanges[id][col] = val;
}

function saveDrawerChanges(id) {
  const row = data.find(r => r._id === id);
  if (!row) return;
  const changes = drawerChanges[id] || {};
  let changed = false;

  for (const [col, val] of Object.entries(changes)) {
    const h = headers.find(hh => escA(hh) === col) || col;
    // Convert date back to DD/MM/YYYY for consistency
    let finalVal = val;
    if (isDateCol(h) && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
      const [y,m,d] = val.split('-');
      finalVal = `${d}/${m}/${y}`;
    }
    row[h] = finalVal;
    changed = true;
  }

  if (changed) {
    if (row._sheetRow) pendingChanges.add(id);
    updatePublishBtn();
    drawerChanges[id] = {};
    render();
    // Refresh badge in drawer
    document.getElementById('drawerBadge').innerHTML = badge(row);
    showToast('‚úÖ Altera√ß√µes aplicadas! Clique em Salvar na planilha para publicar.');
  } else {
    showToast('‚ö†Ô∏è Nenhuma altera√ß√£o detectada.', true);
  }
}

function showDrawerDropdown(e, id, col) {
  e.stopPropagation();
  closeDropdown();
  const h = headers.find(hh => escA(hh) === col) || col;
  const values = getUniqueValues(h);
  const btn = e.currentTarget;
  const wrap = btn.closest('.drawer-dropdown-wrap');

  const dl = document.createElement('div');
  dl.className = 'dropdown-list';
  dl.style.cssText = 'position:absolute;top:100%;left:0;right:0;z-index:900;margin-top:3px;';
  dl.innerHTML = `
    <div class="dropdown-header">Valores cadastrados</div>
    <div class="dropdown-list-inner">
      ${values.length
        ? values.map(v => `<div class="dropdown-item" onclick="pickDrawerDropdown(${id},'${col}',this)">${esc(v)}</div>`).join('')
        : `<div class="dropdown-empty">Nenhum valor encontrado</div>`}
    </div>`;

  wrap.style.position = 'relative';
  wrap.appendChild(dl);
  activeDropdown = dl;
  setTimeout(() => document.addEventListener('click', closeDropdown, { once: true }), 10);
}

function pickDrawerDropdown(id, col, el) {
  const val = el.textContent.trim();
  const inputEl = document.getElementById(`dfield_${id}_${col}`);
  if (inputEl) inputEl.value = val;
  drawerFieldChange(id, col, val);
  closeDropdown();
}


function closeDrawer() {
  document.getElementById('itemDrawer').classList.remove('open');
  document.body.style.overflow = '';
}

// ‚îÄ‚îÄ DROPDOWN COLUMNS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DROPDOWN_COLS = ['equipamento','modelo','fabricante','situa√ß√£o','situacao'];

function isDropdownCol(h) {
  return DROPDOWN_COLS.includes(h.trim().toLowerCase());
}

function getUniqueValues(col) {
  const vals = data
    .map(r => String(r[col] || '').trim())
    .filter(v => v.length > 0);
  return [...new Set(vals)].sort((a, b) => a.localeCompare(b, 'pt-BR'));
}

function renderCell(row, h) {
  const minW = h.length > 10 ? 130 : 85;
  const val = esc(row[h] || '');
  const disabled = row._locked ? 'disabled' : '';
  const id = row._id;
  const hEsc = escA(h);

  if (!row._locked && isDropdownCol(h)) {
    return `<div class="cell-wrap">
      <input class="cell-input" style="min-width:${minW}px"
        id="ci_${id}_${escA(h)}"
        value="${val}"
        onchange="upd(${id},'${hEsc}',this.value)">
      <button class="btn-dropdown" onclick="showDropdown(event,${id},'${hEsc}')" title="Ver op√ß√µes">
        <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
    </div>`;
  }

  return `<input class="cell-input" style="min-width:${minW}px"
    value="${val}" ${disabled}
    onchange="upd(${id},'${hEsc}',this.value)">`;
}

let activeDropdown = null;

function showDropdown(e, id, col) {
  e.stopPropagation();
  closeDropdown();

  // Find the actual header key (un-escaped)
  const h = headers.find(hh => escA(hh) === col) || col;
  const values = getUniqueValues(h);
  const btn = e.currentTarget;
  const wrap = btn.closest('.cell-wrap');

  const dl = document.createElement('div');
  dl.className = 'dropdown-list';
  dl.innerHTML = `
    <div class="dropdown-header">Valores cadastrados</div>
    <div class="dropdown-list-inner">
      ${values.length
        ? values.map(v => `<div class="dropdown-item" onclick="selectDropdown(${id},'${col}',this)">${esc(v)}</div>`).join('')
        : `<div class="dropdown-empty">Nenhum valor encontrado</div>`
      }
    </div>`;

  wrap.style.position = 'relative';
  wrap.appendChild(dl);
  activeDropdown = dl;

  // Close on outside click
  setTimeout(() => document.addEventListener('click', closeDropdown, { once: true }), 10);
}

function selectDropdown(id, col, el) {
  const val = el.textContent.trim();
  const h = headers.find(hh => escA(hh) === col) || col;
  const inputId = `ci_${id}_${col}`;
  const input = document.getElementById(inputId);
  if (input) { input.value = val; }
  upd(id, h, val);
  closeDropdown();
}

function closeDropdown() {
  if (activeDropdown) { activeDropdown.remove(); activeDropdown = null; }
}

function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q && filterState === 'all') {
    showToast('‚ö†Ô∏è Digite algo para buscar.', true);
    return;
  }
  render();
}

function render() {
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const emptyState   = document.getElementById('emptyState');
  const searchPrompt = document.getElementById('searchPrompt');

  updateStats();

  // No data loaded yet
  if (!data.length) {
    emptyState.style.display = '';
    searchPrompt.style.display = 'none';
    document.getElementById('tHead').innerHTML = '';
    document.getElementById('tBody').innerHTML = '';
    return;
  }

  // Data loaded but no search query ‚Äî show prompt
  if (!q && filterState === 'all') {
    emptyState.style.display = 'none';
    searchPrompt.style.display = '';
    document.getElementById('searchPromptCount').textContent = data.length;
    document.getElementById('tHead').innerHTML = '';
    document.getElementById('tBody').innerHTML = '';
    return;
  }

  // Has query or active filter ‚Äî show results
  const filtered = data.filter(row => {
    const ms = !q || headers.some(h => (row[h]||'').toLowerCase().includes(q));
    const mf = filterState==='all' || (filterState==='locked'&&row._locked) || (!row._locked&&filterState===status(row));
    return ms && mf;
  });

  searchPrompt.style.display = 'none';

  if (!filtered.length) {
    emptyState.style.display = '';
    document.getElementById('emptyTitle').textContent = 'Nenhum resultado';
    document.getElementById('emptyMsg').innerHTML = 'Tente outros termos ou filtros.';
    document.getElementById('tHead').innerHTML = '';
    document.getElementById('tBody').innerHTML = '';
    return;
  }

  emptyState.style.display = 'none';

  // Summary columns ‚Äî only show these if present in headers
  const SUMMARY_COLS = ['equipamento','modelo','fabricante','situa√ß√£o','situacao','setor','moderado'];
  const visibleHeaders = headers.filter(h => SUMMARY_COLS.includes(h.trim().toLowerCase()));
  const displayHeaders = visibleHeaders.length > 0 ? visibleHeaders : headers.slice(0, 4);

  document.getElementById('tHead').innerHTML =
    `<th style="width:110px">A√ß√µes</th>` +
    `<th style="width:90px">Status</th>` +
    displayHeaders.map(h=>`<th>${esc(h)}</th>`).join('');

  document.getElementById('tBody').innerHTML = filtered.map((row,i)=>`
    <tr class="${row._locked?'locked-row':''}${pendingChanges.has(row._id)?' pending-row':''}">
      <td>
        <div class="action-btns">
          <button class="btn-view" onclick="openDrawer(${row._id})">üëÅ</button>
          ${row._locked
            ?`<button class="btn-unlock" onclick="unlock(${row._id})">üîì</button>`
            :`<button class="btn-cons"   onclick="lock(${row._id})">üîí</button>`}
          ${!row._locked
            ?`<button class="btn-save-row" onclick="saveRow(${row._id})" title="Salvar na planilha">üíæ</button>`
            :''}
        </div>
      </td>
      <td>${badge(row)}</td>
      ${displayHeaders.map(h=>`
        <td>${renderCell(row, h)}</td>
      `).join('')}
    </tr>`).join('');
}

function updateStats() {
  document.getElementById('statTotal').textContent = data.length;
  document.getElementById('statLocked').textContent = data.filter(r=>r._locked).length;
  document.getElementById('statLow').textContent = data.filter(r=>!r._locked&&status(r)==='low').length;
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escA(s) { return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

function upd(id, col, val) {
  const r = data.find(r=>r._id===id);
  if (r && !r._locked) {
    r[col]=val;
    if (r._sheetRow) pendingChanges.add(r._id);
    updatePublishBtn();
    render();
  }
}

function updatePublishBtn() {
  const btn = document.getElementById('btnPublish');
  const count = pendingChanges.size;
  btn.style.display = count > 0 ? 'flex' : 'none';
  document.getElementById('pendingCount').textContent = count > 0 ? count : '';
}
function getModeradoCol() {
  return headers.find(h => h.trim().toLowerCase() === 'moderado') || null;
}

// ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let confirmCallback = null;

function openConfirm(msg, icon, title, yesLabel, cb) {
  document.getElementById('confirmMsg').innerHTML = msg;
  document.querySelector('.confirm-icon').textContent = icon;
  document.querySelector('.confirm-title').textContent = title;
  document.getElementById('confirmYesBtn').textContent = yesLabel;
  confirmCallback = cb;
  document.getElementById('confirmModal').classList.add('open');
}
function closeConfirm() {
  document.getElementById('confirmModal').classList.remove('open');
  confirmCallback = null;
}
document.getElementById('confirmYesBtn').addEventListener('click', () => {
  if (confirmCallback) confirmCallback();
  closeConfirm();
});

function lock(id) {
  const r = data.find(r => r._id === id);
  if (!r) return;
  const itemName = r[headers[0]] || 'este item';
  openConfirm(
    `Tem certeza que deseja consolidar <strong>"${esc(itemName)}"</strong>?<br><br>
     Ap√≥s consolidado, somente um <strong>Administrador</strong> poder√° desfazer esta a√ß√£o.`,
    'üîí', 'CONSOLIDAR ITEM', 'Sim, consolidar',
    () => {
      r._locked = true;
      const mCol = getModeradoCol();
      if (mCol) {
        r[mCol] = 'SIM';
        if (r._sheetRow) pendingChanges.add(r._id);
        updatePublishBtn();
      }
      showToast(`‚úÖ "${itemName}" consolidado`);
      render();
      if (document.getElementById('itemDrawer').classList.contains('open')) openDrawer(id);
    }
  );
}

function unlock(id) {
  const session = getSession();
  if (!session || !session.admin) { openAdminBlock(); return; }
  const r = data.find(r => r._id === id);
  if (!r) return;
  r._locked = false;
  const mCol = getModeradoCol();
  if (mCol && r[mCol] === 'SIM') {
    r[mCol] = '';
    if (r._sheetRow) pendingChanges.add(r._id);
    updatePublishBtn();
  }
  showToast(`üîì "${r[headers[0]] || 'Item'}" desbloqueado`);
  render();
}

// ‚îÄ‚îÄ BARCODE SCANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let scannerStream = null;
let barcodeDetector = null;
let scannerAnimFrame = null;
let lastScannedCode = '';

async function openScanner() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showToast('‚ùå C√¢mera n√£o suportada neste dispositivo.', true); return;
  }
  document.getElementById('scannerModal').classList.add('open');
  lastScannedCode = '';
  document.getElementById('scannerResultBox').style.display = 'none';
  document.getElementById('btnUseCode').disabled = true;
  document.getElementById('scannerStatus').textContent = 'Solicitando permiss√£o de c√¢mera...';
  await startCamera();
}

async function startCamera() {
  try {
    stopCamera();
    const constraints = {
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
    };
    scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = document.getElementById('scannerVideo');
    video.srcObject = scannerStream;
    await video.play();
    document.getElementById('scannerStatus').textContent = 'Aponte para um c√≥digo de barras ou QR Code';
    if ('BarcodeDetector' in window) {
      barcodeDetector = new BarcodeDetector({ formats: [
        'code_128','code_39','ean_13','ean_8','qr_code','upc_a','upc_e','itf','pdf417','data_matrix'
      ]});
      scanLoop();
    } else {
      document.getElementById('scannerStatus').textContent =
        '‚ö†Ô∏è Detec√ß√£o autom√°tica indispon√≠vel neste navegador. Digite o c√≥digo manualmente na busca.';
    }
  } catch (err) {
    let msg = '‚ùå N√£o foi poss√≠vel acessar a c√¢mera.';
    if (err.name === 'NotAllowedError') msg = '‚ùå Permiss√£o negada. Permita o acesso nas configura√ß√µes do dispositivo.';
    else if (err.name === 'NotFoundError') msg = '‚ùå C√¢mera n√£o encontrada neste dispositivo.';
    document.getElementById('scannerStatus').textContent = msg;
    showToast(msg, true);
  }
}

function scanLoop() {
  const video = document.getElementById('scannerVideo');
  if (!barcodeDetector || !scannerStream || video.readyState < 2) {
    scannerAnimFrame = requestAnimationFrame(scanLoop); return;
  }
  barcodeDetector.detect(video).then(codes => {
    if (codes.length > 0) {
      const code = codes[0].rawValue;
      if (code !== lastScannedCode) {
        lastScannedCode = code;
        document.getElementById('scannerResultVal').textContent = code;
        document.getElementById('scannerResultBox').style.display = 'block';
        document.getElementById('btnUseCode').disabled = false;
        document.getElementById('scannerStatus').textContent = '‚úÖ C√≥digo detectado!';
        if (navigator.vibrate) navigator.vibrate([80, 40, 80]);
      }
    }
  }).catch(() => {}).finally(() => {
    if (scannerStream) scannerAnimFrame = requestAnimationFrame(scanLoop);
  });
}

function restartScanner() {
  lastScannedCode = '';
  document.getElementById('scannerResultBox').style.display = 'none';
  document.getElementById('btnUseCode').disabled = true;
  document.getElementById('scannerStatus').textContent = 'Aponte para um c√≥digo de barras ou QR Code';
}

function useScannedCode() {
  if (!lastScannedCode) return;
  closeScanner();
  goTo('inventory');
  document.getElementById('searchInput').value = lastScannedCode;
  doSearch();
  showToast(`üîç Buscando: "${lastScannedCode}"`);
}

function closeScanner() {
  stopCamera();
  document.getElementById('scannerModal').classList.remove('open');
}

function stopCamera() {
  if (scannerAnimFrame) { cancelAnimationFrame(scannerAnimFrame); scannerAnimFrame = null; }
  if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
  const video = document.getElementById('scannerVideo');
  if (video) video.srcObject = null;
}

// ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let reportData = [];
const REPORT_DISPLAY_COLS = ['equipamento','modelo','fabricante','setor','situa√ß√£o','situacao','moderado'];

function initReportsScreen() {
  const grid = document.getElementById('reportsFilterGrid');
  Array.from(grid.querySelectorAll('.dynamic-filter')).forEach(el => el.remove());
  const dynamicCols = headers.filter(h => REPORT_DISPLAY_COLS.includes(h.trim().toLowerCase()));
  dynamicCols.forEach(col => {
    const vals = getUniqueValues(col);
    if (!vals.length) return;
    const div = document.createElement('div');
    div.className = 'reports-filter-item dynamic-filter';
    div.innerHTML = `<label>${esc(col)}</label>
      <select class="reports-filter-select" id="rFilter_${escA(col)}">
        <option value="">Todos</option>
        ${vals.map(v => `<option value="${esc(v)}">${esc(v)}</option>`).join('')}
      </select>`;
    grid.appendChild(div);
  });
  document.getElementById('reportsSyncLabel').textContent =
    document.getElementById('lastSync').textContent;
  applyReportFilter();
}

function applyReportFilter() {
  const statusF = document.getElementById('rFilterStatus').value;
  const searchF = document.getElementById('rFilterSearch').value.trim().toLowerCase();
  let filtered = data.filter(row => {
    const ms = !searchF || headers.some(h => (row[h] || '').toLowerCase().includes(searchF));
    const mf = statusF === 'all' ||
      (statusF === 'locked' && row._locked) ||
      (!row._locked && statusF === status(row));
    return ms && mf;
  });
  headers.forEach(col => {
    const el = document.getElementById(`rFilter_${escA(col)}`);
    if (el && el.value) filtered = filtered.filter(row => (row[col] || '').trim() === el.value);
  });
  reportData = filtered;
  renderReportTable();
  renderReportSummary();
}

function renderReportSummary() {
  const total = reportData.length;
  const locked = reportData.filter(r => r._locked).length;
  const active = reportData.filter(r => !r._locked && status(r) === 'ok').length;
  const low = reportData.filter(r => !r._locked && status(r) === 'low').length;
  const out = reportData.filter(r => !r._locked && status(r) === 'out').length;
  document.getElementById('reportsSummary').innerHTML = `
    <div class="reports-kpi"><span class="reports-kpi-val">${total}</span><span class="reports-kpi-lbl">TOTAL</span></div>
    <div class="reports-kpi"><span class="reports-kpi-val" style="color:var(--accent)">${active}</span><span class="reports-kpi-lbl">ATIVO</span></div>
    <div class="reports-kpi"><span class="reports-kpi-val" style="color:#ffc107">${low}</span><span class="reports-kpi-lbl">BAIXO ESTOQUE</span></div>
    <div class="reports-kpi"><span class="reports-kpi-val" style="color:var(--warn)">${out}</span><span class="reports-kpi-lbl">SEM ESTOQUE</span></div>
    <div class="reports-kpi"><span class="reports-kpi-val" style="color:var(--muted)">${locked}</span><span class="reports-kpi-lbl">CONSOLIDADOS</span></div>`;
}

function renderReportTable() {
  const visHeaders = headers.filter(h => REPORT_DISPLAY_COLS.includes(h.trim().toLowerCase()));
  const showHeaders = visHeaders.length > 0 ? visHeaders : headers.slice(0, 5);
  document.getElementById('reportsCount').textContent = reportData.length;
  document.getElementById('reportsHead').innerHTML =
    '<th>Status</th>' + showHeaders.map(h => `<th>${esc(h)}</th>`).join('');
  const tbody = document.getElementById('reportsBody');
  const empty = document.getElementById('reportsEmpty');
  if (!reportData.length) {
    tbody.innerHTML = ''; empty.style.display = '';
    document.querySelector('.reports-table').style.display = 'none'; return;
  }
  document.querySelector('.reports-table').style.display = '';
  empty.style.display = 'none';
  tbody.innerHTML = reportData.map(row => `
    <tr>
      <td>${badge(row)}</td>
      ${showHeaders.map(h => `<td>${esc(row[h] || '‚Äî')}</td>`).join('')}
    </tr>`).join('');
}

function clearReportFilter() {
  document.getElementById('rFilterStatus').value = 'all';
  document.getElementById('rFilterSearch').value = '';
  headers.forEach(col => { const el = document.getElementById(`rFilter_${escA(col)}`); if (el) el.value = ''; });
  applyReportFilter();
}

function printReport() {
  if (!reportData.length) { showToast('‚ö†Ô∏è Nenhum dado para imprimir.', true); return; }
  const visHeaders = headers.filter(h => REPORT_DISPLAY_COLS.includes(h.trim().toLowerCase()));
  const showHeaders = visHeaders.length > 0 ? visHeaders : headers.slice(0, 5);
  const now = new Date().toLocaleString('pt-BR');
  const session = getSession();
  document.getElementById('printArea').innerHTML = `
    <div class="print-header">
      <div class="print-title">INV//CTRL ‚Äî Relat√≥rio de Invent√°rio</div>
      <div class="print-sub">Gerado em: ${now} ¬∑ Por: ${session?.name || '‚Äî'} ¬∑ Total: ${reportData.length} itens</div>
    </div>
    <table>
      <thead><tr><th>Status</th>${showHeaders.map(h=>`<th>${esc(h)}</th>`).join('')}</tr></thead>
      <tbody>${reportData.map(row=>`<tr>
        <td>${row._locked?'Consolidado':status(row)==='out'?'Sem estoque':status(row)==='low'?'Baixo estoque':'ATIVO'}</td>
        ${showHeaders.map(h=>`<td>${esc(row[h]||'‚Äî')}</td>`).join('')}
      </tr>`).join('')}</tbody>
    </table>`;
  window.print();
}

// ‚îÄ‚îÄ ADMIN NOTIFICATIONS ON PUBLISH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function notifyAdminPublish(count, userName) {
  try {
    const existing = JSON.parse(localStorage.getItem('invctr_notifications') || '[]');
    existing.unshift({
      id: Date.now(),
      msg: `üì§ ${userName} publicou ${count} altera√ß√£o(√µes) na planilha.`,
      time: new Date().toLocaleString('pt-BR'),
      read: false
    });
    localStorage.setItem('invctr_notifications', JSON.stringify(existing.slice(0, 20)));
    // Trigger cross-tab update
    localStorage.setItem('invctr_notify_ping', Date.now().toString());
    setTimeout(() => localStorage.removeItem('invctr_notify_ping'), 100);
  } catch(e) {}
}

function getUnreadNotifications() {
  try { return JSON.parse(localStorage.getItem('invctr_notifications') || '[]').filter(n => !n.read); }
  catch { return []; }
}

function markAllNotificationsRead() {
  try {
    const all = JSON.parse(localStorage.getItem('invctr_notifications') || '[]');
    all.forEach(n => n.read = true);
    localStorage.setItem('invctr_notifications', JSON.stringify(all));
    updateNotifBadge();
  } catch {}
}

function updateNotifBadge() {
  const badge = document.getElementById('notifBadge');
  if (!badge) return;
  const count = getUnreadNotifications().length;
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline-flex' : 'none';
}

function toggleNotifPanel() {
  const panel = document.getElementById('notifPanel');
  if (!panel) return;
  const open = panel.style.display !== 'none';
  if (open) { panel.style.display = 'none'; return; }
  let all = [];
  try { all = JSON.parse(localStorage.getItem('invctr_notifications') || '[]'); } catch {}
  panel.innerHTML = `
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span style="font-family:var(--font-mono);font-size:0.75rem;color:var(--accent);letter-spacing:1px;">NOTIFICA√á√ïES</span>
      <button onclick="markAllNotificationsRead()" style="font-size:0.68rem;font-family:var(--font-mono);color:var(--muted);background:none;border:none;cursor:pointer;">Marcar lidas</button>
    </div>
    <div style="max-height:280px;overflow-y:auto;">
      ${all.length ? all.map(n => `
        <div style="padding:11px 16px;border-bottom:1px solid var(--border);${!n.read?'background:rgba(0,229,160,0.04)':''}">
          <div style="font-size:0.82rem;color:${n.read?'var(--muted)':'var(--text)'};">${n.msg}</div>
          <div style="font-size:0.68rem;color:var(--muted);font-family:var(--font-mono);margin-top:3px;">${n.time}</div>
        </div>`).join('')
      : '<div style="padding:24px;text-align:center;color:var(--muted);font-size:0.8rem;">Sem notifica√ß√µes</div>'}
    </div>`;
  panel.style.display = 'block';
  markAllNotificationsRead();
}

// Cross-tab listener for admin notifications
window.addEventListener('storage', (e) => {
  if (e.key === 'invctr_notify_ping') {
    const session = getSession();
    if (session && session.admin) {
      updateNotifBadge();
      const unread = getUnreadNotifications();
      if (unread.length) showToast(`üîî ${unread[0].msg}`);
    }
  }
});

function openAdminBlock() {
  document.getElementById('adminBlockModal').classList.add('open');
}
function closeAdminBlock() {
  document.getElementById('adminBlockModal').classList.remove('open');
}
function addRow() {
  if (!headers.length) { showToast('‚ö†Ô∏è Sincronize ou carregue um arquivo primeiro.', true); return; }
  const obj = { _id: nextId++, _locked: false, _qCol: data[0]?._qCol || null, _sheetRow: null };
  headers.forEach(h => { obj[h] = ''; });
  data.unshift(obj);
  setFilter('all', document.querySelector('.filter-tab'));
  render();
  showToast('‚ûï Novo item adicionado ‚Äî preencha e clique em üíæ para salvar na planilha.');
}

async function saveRow(id) {
  const row = data.find(r => r._id === id);
  if (!row) return;

  setLoad(true, 'Salvando linha...');
  try {
    const sheetName = await getMainSheetName();
    const rowValues = headers.map(h => row[h] ?? '');

    if (row._sheetRow) {
      // Linha existente ‚Üí PUT na linha espec√≠fica
      const range = `${sheetName}!A${row._sheetRow}:${colLetter(headers.length)}${row._sheetRow}`;
      await sheetsAPI(
        `/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,
        {
          method: 'PUT',
          body: JSON.stringify({ range, majorDimension: 'ROWS', values: [rowValues] })
        }
      );
    } else {
      // Novo item sem _sheetRow ‚Üí APPEND ao final da planilha
      const appendRange = `${sheetName}!A:${colLetter(headers.length)}`;
      const result = await sheetsAPI(
        `/values/${encodeURIComponent(appendRange)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`,
        {
          method: 'POST',
          body: JSON.stringify({ majorDimension: 'ROWS', values: [rowValues] })
        }
      );
      // Captura o n√∫mero da linha criada para futuras edi√ß√µes
      const updatedRange = result.updates?.updatedRange || '';
      const match = updatedRange.match(/(\d+)$/);
      if (match) row._sheetRow = parseInt(match[1], 10);
    }

    pendingChanges.delete(id);
    updatePublishBtn();
    render();
    showToast('‚úÖ Linha salva na planilha!');
  } catch(e) {
    showToast('‚ùå Erro ao salvar: ' + e.message, true);
    console.error('saveRow error:', e);
  } finally {
    setLoad(false);
  }
}

let tTimer;
function showToast(msg, err=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = (err?'err ':'') + 'show';
  clearTimeout(tTimer);
  tTimer = setTimeout(()=>t.classList.remove('show'), 3500);
}

// Search triggered by button or Enter key only

// Enter key support for login
['loginUser','loginPass'].forEach(id =>
  document.getElementById(id).addEventListener('keydown', e => e.key==='Enter' && doLogin()));

render();



// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(screen) {
  document.getElementById('navScreen').classList.remove('active');
  document.getElementById('inventoryScreen').style.display = 'none';
  document.getElementById('chartScreen').classList.remove('active');
  document.getElementById('reportsScreen').classList.remove('active');

  if (screen === 'nav') {
    document.getElementById('navScreen').classList.add('active');
    updateNavSync();
  } else if (screen === 'inventory') {
    document.getElementById('inventoryScreen').style.display = 'block';
  } else if (screen === 'charts') {
    document.getElementById('chartScreen').classList.add('active');
    renderCharts();
  } else if (screen === 'reports') {
    document.getElementById('reportsScreen').classList.add('active');
    initReportsScreen();
  }
}

function updateNavSync() {
  const dot = document.getElementById('navSyncDot');
  const lbl = document.getElementById('navSyncLabel');
  const srcDot = document.getElementById('syncDot');
  const srcLbl = document.getElementById('syncLabel');
  dot.className = srcDot.className;
  lbl.textContent = srcLbl.textContent;
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCharts() {
  const el = document.getElementById('chartContent');
  const lastSync = document.getElementById('lastSync').textContent;
  document.getElementById('chartLastSync').textContent = lastSync;

  if (!data.length) {
    el.innerHTML = `
      <div class="chart-empty">
        <h3>Sem dados carregados</h3>
        <p>Volte ao menu e sincronize a planilha primeiro.</p>
      </div>`;
    return;
  }

  // Find "Moderado" column by name, count rows with value "SIM"
  const mCol = headers.find(h => h.trim().toLowerCase() === 'moderado') || null;
  const total = data.length;

  if (!mCol) {
    el.innerHTML = `
      <div class="chart-empty">
        <h3>Coluna "Moderado" n√£o encontrada</h3>
        <p>Verifique se sua planilha possui uma coluna chamada <strong style="color:var(--accent2)">Moderado</strong>.</p>
      </div>`;
    return;
  }

  const moderadoCount = data.filter(row =>
    String(row[mCol] || '').trim().toUpperCase() === 'SIM'
  ).length;

  const pct = total > 0 ? Math.round((moderadoCount / total) * 100) : 0;
  const outros = total - moderadoCount;

  // SVG donut
  const r = 60, stroke = 18;
  const circ = 2 * Math.PI * r;
  const dash = (pct / 100) * circ;
  const gap = circ - dash;

  el.innerHTML = `
    <div class="chart-section-title">An√°lise ¬∑ Consolidados na coluna Moderado</div>

    <div class="kpi-card">
      <div class="kpi-donut-wrap">
        <svg viewBox="0 0 160 160">
          <circle cx="80" cy="80" r="${r}" fill="none"
            stroke="var(--surface2)" stroke-width="${stroke}"/>
          <circle cx="80" cy="80" r="${r}" fill="none"
            stroke="var(--accent2)" stroke-width="${stroke}"
            stroke-dasharray="${dash.toFixed(2)} ${gap.toFixed(2)}"
            stroke-linecap="round"
            style="transition: stroke-dasharray 1s cubic-bezier(0.4,0,0.2,1)"/>
        </svg>
        <div class="kpi-donut-center">
          <span class="kpi-pct">${pct}%</span>
          <span class="kpi-pct-label">SIM</span>
        </div>
      </div>

      <div class="kpi-info">
        <div class="kpi-title">Itens <span>Consolidados</span> (SIM)</div>
        <div class="kpi-desc">
          Propor√ß√£o de itens consolidados (<strong style="color:var(--accent2)">SIM</strong> na coluna Moderado)
          em rela√ß√£o ao total de itens carregados da planilha.
        </div>
        <div class="kpi-numbers">
          <div class="kpi-num">
            <span class="kpi-num-val mod">${moderadoCount}</span>
            <span class="kpi-num-lbl">SIM</span>
          </div>
          <div class="kpi-num">
            <span class="kpi-num-val" style="color:var(--muted)">${outros}</span>
            <span class="kpi-num-lbl">Outros</span>
          </div>
          <div class="kpi-num">
            <span class="kpi-num-val total">${total}</span>
            <span class="kpi-num-lbl">Total</span>
          </div>
        </div>
      </div>
    </div>

    <div class="bar-visual">
      <div class="bar-visual-title">Distribui√ß√£o visual</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${pct}%">
          ${pct >= 10 ? `<span class="bar-fill-label">${pct}%</span>` : ''}
        </div>
      </div>
      <div class="bar-legend">
        <div class="bar-leg-item">
          <div class="bar-leg-dot" style="background:var(--accent2)"></div>
          SIM na col. Moderado (${moderadoCount} itens ¬∑ ${pct}%)
        </div>
        <div class="bar-leg-item">
          <div class="bar-leg-dot" style="background:var(--surface2);border:1px solid var(--border)"></div>
          Outros (${outros} itens ¬∑ ${100 - pct}%)
        </div>
      </div>
    </div>
  `;
}

// Register PWA service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>

<!-- ‚îÄ‚îÄ ITEM DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="itemDrawer">
  <div class="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="drawer-panel">
    <div class="drawer-top">
      <span class="drawer-title">DETALHES DO ITEM</span>
      <button class="drawer-close" onclick="closeDrawer()">‚úï</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-badge-row" id="drawerBadge"></div>
      <div class="drawer-fields" id="drawerFields"></div>
    </div>
    <div class="drawer-actions" id="drawerActions"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ADMIN BLOCK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="adminBlockModal">
  <div class="admin-block-card">
    <span class="admin-block-icon">üîê</span>
    <div class="admin-block-title">ACESSO RESTRITO</div>
    <div class="admin-block-msg">
      Desconsolidar um item √© uma a√ß√£o exclusiva de <strong>Administradores</strong>.<br><br>
      Entre em contato com o administrador do sistema para realizar esta opera√ß√£o.
    </div>
    <button class="btn-admin-block-ok" onclick="closeAdminBlock()">ENTENDIDO</button>
  </div>
</div>
</body>
</html>
