<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Inventário</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00e5a0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Inventário">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161a24;
    --surface2: #1e2436;
    --border: #2a3050;
    --accent: #00e5a0;
    --accent2: #0077ff;
    --warn: #ff6b35;
    --text: #e8eaf0;
    --muted: #6b748c;
    --locked: #2a1a0a;
    --font-mono: 'Space Mono', monospace;
    --font-main: 'Sora', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-main); min-height: 100vh; }

  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 28px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { font-family: var(--font-mono); font-size: 1.05rem; color: var(--accent); letter-spacing: 2px; }
  .logo span { color: var(--muted); }
  .stats { display: flex; gap: 20px; font-size: 0.76rem; color: var(--muted); font-family: var(--font-mono); }
  .stats strong { color: var(--text); }

  .sync-bar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 10px 28px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .sync-status { display: flex; align-items: center; gap: 7px; font-family: var(--font-mono); font-size: 0.78rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .dot.green { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .dot.yellow { background: #ffc107; animation: pulse 1s infinite; }
  .dot.red { background: var(--warn); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .btn-sync {
    margin-left: auto; background: rgba(0,229,160,0.1);
    border: 1px solid rgba(0,229,160,0.3); color: var(--accent);
    padding: 7px 14px; border-radius: 7px; font-size: 0.78rem;
    font-family: var(--font-mono); cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .btn-sync:hover { background: rgba(0,229,160,0.2); }
  .btn-sync:disabled { opacity: 0.4; cursor: not-allowed; }

  .toolbar {
    padding: 16px 28px; display: flex; gap: 10px; align-items: center;
    flex-wrap: wrap; background: var(--surface); border-bottom: 1px solid var(--border);
  }
  .search-wrap { position: relative; flex: 1; min-width: 220px; }
  .search-wrap svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); }
  .search-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.88rem;
    padding: 9px 12px 9px 38px; border-radius: 8px; outline: none; transition: border-color 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }

  .btn {
    padding: 9px 16px; border-radius: 8px; font-family: var(--font-main);
    font-size: 0.83rem; font-weight: 600; cursor: pointer; border: none;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .btn-add { background: var(--accent); color: #0d0f14; }
  .btn-add:hover { background: #00ffb3; }
  .btn-search { background: var(--accent2); color: #fff; }
  .btn-search:hover { background: #1a8aff; }

  .col-info {
    margin: 12px 28px 0;
    background: rgba(0,119,255,0.07); border: 1px solid rgba(0,119,255,0.2);
    border-radius: 8px; padding: 9px 15px;
    font-size: 0.75rem; color: var(--muted); font-family: var(--font-mono);
  }
  .col-info span { color: var(--accent2); }

  .filter-tabs { display: flex; gap: 7px; padding: 14px 28px 0; flex-wrap: wrap; }
  .filter-tab {
    padding: 5px 13px; border-radius: 6px; font-size: 0.76rem;
    font-family: var(--font-mono); cursor: pointer;
    border: 1px solid var(--border); background: transparent; color: var(--muted); transition: all 0.2s;
  }
  .filter-tab.active { background: var(--surface2); color: var(--text); border-color: var(--accent); }

  .table-wrap { padding: 20px 28px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
  thead tr { border-bottom: 2px solid var(--border); }
  th {
    text-align: left; padding: 9px 12px; color: var(--muted);
    font-size: 0.72rem; font-family: var(--font-mono); letter-spacing: 1px;
    text-transform: uppercase; white-space: nowrap;
  }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:hover:not(.locked-row) { background: var(--surface2); }
  tbody tr.locked-row { background: var(--locked); }
  tbody tr.pending-row { border-left: 3px solid var(--accent); }
  td { padding: 9px 12px; vertical-align: middle; }

  .cell-input {
    background: transparent; border: 1px solid transparent; color: var(--text);
    font-family: var(--font-main); font-size: 0.86rem;
    padding: 4px 7px; border-radius: 5px; width: 100%; outline: none; transition: all 0.2s;
  }
  .cell-input:not([disabled]):hover { border-color: var(--border); }
  .cell-input:not([disabled]):focus { border-color: var(--accent); background: var(--surface2); }
  .cell-input[disabled] { cursor: not-allowed; color: var(--muted); opacity: 0.65; }

  .badge {
    display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px;
    border-radius: 20px; font-size: 0.7rem; font-weight: 600;
    font-family: var(--font-mono); white-space: nowrap;
  }
  .badge-ok { background: rgba(0,229,160,0.1); color: var(--accent); }
  .badge-low { background: rgba(255,193,7,0.1); color: #ffc107; }
  .badge-out { background: rgba(255,107,53,0.1); color: var(--warn); }
  .badge-locked { background: rgba(255,107,53,0.12); color: var(--warn); }

  .action-btns { display: flex; gap: 4px; align-items: center; flex-wrap: nowrap; }
  .btn-cons {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.25);
    color: var(--warn); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-cons:hover { background: rgba(255,107,53,0.22); }
  .btn-unlock {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.25);
    color: var(--accent2); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-unlock:hover { background: rgba(0,119,255,0.22); }
  .btn-save-row {
    background: rgba(0,229,160,0.08); border: 1px solid rgba(0,229,160,0.25);
    color: var(--accent); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-save-row:hover { background: rgba(0,229,160,0.2); }

  .empty { text-align: center; padding: 60px 28px; color: var(--muted); }
  .empty h3 { font-size: 1.05rem; margin-bottom: 8px; color: var(--text); }
  .empty p { font-size: 0.83rem; line-height: 1.6; }

  #toast {
    position: fixed; bottom: 22px; right: 22px;
    background: var(--surface2); border: 1px solid var(--accent);
    color: var(--text); padding: 11px 18px; border-radius: 9px;
    font-size: 0.83rem; font-family: var(--font-mono);
    opacity: 0; transform: translateY(10px); transition: all 0.3s;
    pointer-events: none; z-index: 999; max-width: 340px;
  }
  #toast.show { opacity: 1; transform: translateY(0); }
  #toast.err { border-color: var(--warn); }

  .loading-overlay {
    display: none; position: fixed; inset: 0; background: rgba(13,15,20,0.82);
    z-index: 500; align-items: center; justify-content: center; flex-direction: column; gap: 16px;
  }
  .loading-overlay.show { display: flex; }
  .spinner {
    width: 40px; height: 40px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-family: var(--font-mono); color: var(--muted); font-size: 0.85rem; }

  @media(max-width:600px){
    header,.toolbar,.table-wrap,.sync-bar,.filter-tabs{padding-left:14px;padding-right:14px;}
    .stats{display:none;}
  }

  /* ── AUTH OVERLAY ─────────────────────────────────────── */
  #authOverlay {
    position: fixed; inset: 0; z-index: 1000;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }
  #authOverlay.hidden { display: none; }

  .auth-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 40px 36px; width: 100%; max-width: 420px;
    position: relative; overflow: hidden;
  }
  .auth-card::before {
    content: ''; position: absolute; top: -60px; right: -60px;
    width: 180px; height: 180px; border-radius: 50%;
    background: radial-gradient(circle, rgba(0,229,160,0.08) 0%, transparent 70%);
    pointer-events: none;
  }

  .auth-logo {
    font-family: var(--font-mono); font-size: 1.15rem;
    color: var(--accent); letter-spacing: 3px; margin-bottom: 6px;
  }
  .auth-logo span { color: var(--muted); }
  .auth-subtitle {
    color: var(--muted); font-size: 0.8rem;
    font-family: var(--font-mono); margin-bottom: 32px;
  }

  .auth-tabs {
    display: flex; gap: 0; margin-bottom: 28px;
    border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
  }
  .auth-tab {
    flex: 1; padding: 9px; font-family: var(--font-mono); font-size: 0.78rem;
    background: transparent; border: none; color: var(--muted); cursor: pointer;
    transition: all 0.2s;
  }
  .auth-tab.active { background: var(--surface2); color: var(--accent); }

  .auth-field { margin-bottom: 16px; }
  .auth-field label {
    display: block; font-size: 0.72rem; font-family: var(--font-mono);
    color: var(--muted); margin-bottom: 6px; letter-spacing: 1px;
    text-transform: uppercase;
  }
  .auth-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.9rem;
    padding: 10px 14px; border-radius: 8px; outline: none; transition: all 0.2s;
  }
  .auth-input:focus { border-color: var(--accent); }
  .auth-input::placeholder { color: var(--muted); }

  .btn-auth {
    width: 100%; background: var(--accent); color: #0d0f14;
    border: none; border-radius: 8px; padding: 12px;
    font-family: var(--font-mono); font-size: 0.85rem; font-weight: 700;
    cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
    margin-top: 6px;
  }
  .btn-auth:hover { background: #00ffb3; }

  .auth-err {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.3);
    color: var(--warn); font-size: 0.78rem; font-family: var(--font-mono);
    padding: 9px 13px; border-radius: 7px; margin-bottom: 14px; display: none;
  }
  .auth-err.show { display: block; }

  /* user badge in header */
  .user-badge {
    display: flex; align-items: center; gap: 10px;
    font-family: var(--font-mono); font-size: 0.75rem; color: var(--muted);
  }
  .user-badge strong { color: var(--accent); }
  .btn-logout {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.25);
    color: var(--warn); padding: 4px 10px; border-radius: 6px;
    font-size: 0.72rem; font-weight: 600; cursor: pointer;
    font-family: var(--font-mono); transition: all 0.2s;
  }
  .btn-logout:hover { background: rgba(255,107,53,0.22); }

  /* local file button */
  .btn-file {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.3);
    color: var(--accent2); padding: 7px 14px; border-radius: 7px;
    font-size: 0.78rem; font-family: var(--font-mono); cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .btn-file:hover { background: rgba(0,119,255,0.2); }
  #fileInput { display: none; }

  /* publish button */
  .btn-publish {
    background: rgba(0,229,160,0.12); border: 1px solid rgba(0,229,160,0.4);
    color: var(--accent); padding: 7px 14px; border-radius: 7px;
    font-size: 0.78rem; font-family: var(--font-mono); cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    font-weight: 700; animation: pulseGreen 2s infinite;
  }
  .btn-publish:hover { background: rgba(0,229,160,0.25); }
  .btn-publish:disabled { opacity: 0.4; cursor: not-allowed; animation: none; }
  #pendingCount {
    background: var(--accent); color: #0d0f14; border-radius: 10px;
    padding: 1px 7px; font-size: 0.68rem; font-weight: 700;
  }
  @keyframes pulseGreen {
    0%,100% { box-shadow: 0 0 0 0 rgba(0,229,160,0.3); }
    50% { box-shadow: 0 0 0 5px rgba(0,229,160,0); }
  }

  /* ── NAVIGATION SCREEN ───────────────────────────────────────────────────── */
  #navScreen {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: var(--bg); align-items: center; justify-content: center;
    flex-direction: column; gap: 40px; padding: 80px 20px 40px;
  }
  #navScreen.active { display: flex; }
  #chartScreen { display: none; }

  .nav-title {
    font-family: var(--font-mono); font-size: 1.1rem;
    color: var(--accent); letter-spacing: 3px; text-align: center;
  }
  .nav-subtitle {
    font-size: 0.78rem; color: var(--muted);
    font-family: var(--font-mono); text-align: center; margin-top: 6px;
  }
  .nav-sync-status {
    display: flex; align-items: center; gap: 8px;
    font-family: var(--font-mono); font-size: 0.75rem; color: var(--muted);
  }

  .nav-cards {
    display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;
    max-width: 1100px; width: 100%;
  }
  .nav-card {
    flex: 1; min-width: 200px; max-width: 240px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 36px 28px; cursor: pointer;
    transition: all 0.25s; text-align: center; position: relative; overflow: hidden;
  }
  .nav-card::before {
    content: ''; position: absolute; inset: 0; opacity: 0; transition: opacity 0.25s;
  }
  .nav-card.inv::before { background: radial-gradient(circle at 50% 0%, rgba(0,229,160,0.08), transparent 70%); }
  .nav-card.chart::before { background: radial-gradient(circle at 50% 0%, rgba(0,119,255,0.08), transparent 70%); }
  .nav-card:hover { transform: translateY(-4px); }
  .nav-card.inv:hover { border-color: var(--accent); box-shadow: 0 8px 32px rgba(0,229,160,0.12); }
  .nav-card.chart:hover { border-color: var(--accent2); box-shadow: 0 8px 32px rgba(0,119,255,0.12); }
  .nav-card:hover::before { opacity: 1; }

  .nav-card-icon {
    font-size: 2.8rem; margin-bottom: 16px; display: block;
  }
  .nav-card-title {
    font-family: var(--font-mono); font-size: 0.95rem; letter-spacing: 2px;
    margin-bottom: 10px;
  }
  .nav-card.inv .nav-card-title { color: var(--accent); }
  .nav-card.chart .nav-card-title { color: var(--accent2); }
  .nav-card-desc {
    font-size: 0.78rem; color: var(--muted); line-height: 1.6;
  }

  /* ── CHARTS SCREEN ───────────────────────────────────────────────────────── */
  #chartScreen {
    display: none; min-height: 100vh;
    background: var(--bg); padding-bottom: 60px;
  }
  #chartScreen.active { display: block; }

  .chart-header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 28px; display: flex; align-items: center; gap: 14px;
    position: sticky; top: 0; z-index: 100;
  }
  .btn-back {
    background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    color: var(--muted); padding: 6px 13px; border-radius: 7px;
    font-family: var(--font-mono); font-size: 0.75rem; cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 5px;
  }
  .btn-back:hover { color: var(--text); border-color: var(--text); }

  .chart-body { padding: 36px 28px; max-width: 900px; margin: 0 auto; }
  .chart-section-title {
    font-family: var(--font-mono); font-size: 0.72rem;
    color: var(--muted); letter-spacing: 2px; text-transform: uppercase;
    margin-bottom: 24px;
  }

  /* big KPI card */
  .kpi-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 36px 32px; margin-bottom: 28px;
    display: flex; align-items: center; gap: 36px; flex-wrap: wrap;
  }
  .kpi-donut-wrap { position: relative; width: 160px; height: 160px; flex-shrink: 0; }
  .kpi-donut-wrap svg { width: 160px; height: 160px; transform: rotate(-90deg); }
  .kpi-donut-center {
    position: absolute; inset: 0; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
  }
  .kpi-pct {
    font-family: var(--font-mono); font-size: 2rem; font-weight: 700;
    color: var(--accent2); line-height: 1;
  }
  .kpi-pct-label {
    font-size: 0.65rem; color: var(--muted); font-family: var(--font-mono);
    margin-top: 4px; letter-spacing: 1px;
  }
  .kpi-info { flex: 1; min-width: 200px; }
  .kpi-title {
    font-family: var(--font-mono); font-size: 1.1rem;
    color: var(--text); margin-bottom: 10px; letter-spacing: 1px;
  }
  .kpi-title span { color: var(--accent2); }
  .kpi-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.7; }
  .kpi-numbers {
    display: flex; gap: 28px; margin-top: 20px; flex-wrap: wrap;
  }
  .kpi-num { text-align: center; }
  .kpi-num-val {
    font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700;
    display: block;
  }
  .kpi-num-val.mod { color: var(--accent2); }
  .kpi-num-val.total { color: var(--text); }
  .kpi-num-lbl { font-size: 0.7rem; color: var(--muted); font-family: var(--font-mono); }

  /* bar visualization */
  .bar-visual {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px 32px; margin-bottom: 28px;
  }
  .bar-visual-title {
    font-family: var(--font-mono); font-size: 0.8rem; color: var(--muted);
    margin-bottom: 18px; letter-spacing: 1px;
  }
  .bar-track {
    background: var(--surface2); border-radius: 100px;
    height: 28px; width: 100%; overflow: hidden; position: relative;
  }
  .bar-fill {
    height: 100%; border-radius: 100px;
    background: linear-gradient(90deg, var(--accent2), rgba(0,119,255,0.6));
    transition: width 1s cubic-bezier(0.4,0,0.2,1);
    display: flex; align-items: center; justify-content: flex-end;
    padding-right: 12px;
  }
  .bar-fill-label {
    font-family: var(--font-mono); font-size: 0.72rem;
    color: #fff; font-weight: 700; white-space: nowrap;
  }
  .bar-legend {
    display: flex; gap: 20px; margin-top: 14px; flex-wrap: wrap;
  }
  .bar-leg-item {
    display: flex; align-items: center; gap: 7px;
    font-family: var(--font-mono); font-size: 0.72rem; color: var(--muted);
  }
  .bar-leg-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* no data */
  .chart-empty {
    text-align: center; padding: 80px 28px; color: var(--muted);
  }
  .chart-empty h3 { font-size: 1rem; color: var(--text); margin-bottom: 8px; }
  .chart-empty p { font-size: 0.82rem; line-height: 1.6; }

  /* ── DROPDOWN CELL ───────────────────────────────────────────────────────── */
  .cell-wrap { position: relative; display: flex; align-items: center; gap: 3px; }
  .btn-dropdown {
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.25);
    color: var(--accent2); width: 22px; height: 22px; border-radius: 4px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s; padding: 0;
  }
  .btn-dropdown:hover { background: rgba(0,119,255,0.25); }
  .dropdown-list {
    position: absolute; top: 100%; left: 0; min-width: 180px; max-width: 280px;
    background: var(--surface); border: 1px solid var(--accent2);
    border-radius: 8px; z-index: 500; overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    margin-top: 3px;
  }
  .dropdown-list-inner { max-height: 200px; overflow-y: auto; }
  .dropdown-item {
    padding: 8px 13px; font-size: 0.82rem; cursor: pointer;
    color: var(--text); transition: background 0.12s;
    border-bottom: 1px solid var(--border);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .dropdown-item:last-child { border-bottom: none; }
  .dropdown-item:hover { background: var(--surface2); color: var(--accent); }
  .dropdown-empty {
    padding: 10px 13px; font-size: 0.78rem;
    color: var(--muted); font-family: var(--font-mono);
  }
  .dropdown-header {
    padding: 7px 13px; font-size: 0.68rem; font-family: var(--font-mono);
    color: var(--muted); letter-spacing: 1px; text-transform: uppercase;
    border-bottom: 1px solid var(--border); background: var(--surface2);
  }

  /* ── ITEM DRAWER ─────────────────────────────────────────────────────────── */
  #itemDrawer {
    position: fixed; inset: 0; z-index: 800;
    display: flex; justify-content: flex-end;
    pointer-events: none;
  }
  #itemDrawer.open { pointer-events: all; }

  .drawer-backdrop {
    position: absolute; inset: 0;
    background: rgba(13,15,20,0); transition: background 0.3s;
  }
  #itemDrawer.open .drawer-backdrop { background: rgba(13,15,20,0.75); }

  .drawer-panel {
    position: relative; width: 100%; max-width: 420px;
    background: var(--surface); border-left: 1px solid var(--border);
    height: 100%; overflow-y: auto;
    transform: translateX(100%); transition: transform 0.32s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column;
  }
  #itemDrawer.open .drawer-panel { transform: translateX(0); }

  .drawer-top {
    padding: 18px 20px 14px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; background: var(--surface); z-index: 10;
  }
  .drawer-title {
    font-family: var(--font-mono); font-size: 0.8rem;
    color: var(--accent); letter-spacing: 2px;
  }
  .drawer-close {
    background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.25);
    color: var(--warn); width: 30px; height: 30px; border-radius: 7px;
    cursor: pointer; font-size: 1rem; display: flex;
    align-items: center; justify-content: center; transition: all 0.2s;
  }
  .drawer-close:hover { background: rgba(255,107,53,0.25); }

  .drawer-body { padding: 20px; flex: 1; }

  .drawer-badge-row { margin-bottom: 18px; }

  .drawer-fields { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
  .drawer-field {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 14px;
  }
  .drawer-field-label {
    font-family: var(--font-mono); font-size: 0.65rem;
    color: var(--muted); letter-spacing: 1px; text-transform: uppercase;
    margin-bottom: 5px;
  }
  .drawer-field-value {
    font-size: 0.9rem; color: var(--text); word-break: break-word; line-height: 1.5;
  }
  .drawer-field-value.empty { color: var(--muted); font-style: italic; font-size: 0.8rem; }

  .drawer-actions {
    display: flex; flex-direction: column; gap: 10px;
    padding: 16px 20px; border-top: 1px solid var(--border);
    position: sticky; bottom: 0; background: var(--surface);
  }
  .drawer-btn {
    width: 100%; padding: 11px; border-radius: 9px;
    font-family: var(--font-mono); font-size: 0.8rem; font-weight: 700;
    cursor: pointer; border: none; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .drawer-btn-cons { background: var(--warn); color: #fff; }
  .drawer-btn-cons:hover { filter: brightness(1.15); }
  .drawer-btn-unlock { background: var(--accent2); color: #fff; }
  .drawer-btn-unlock:hover { filter: brightness(1.15); }
  .drawer-btn-save { background: rgba(0,229,160,0.12); color: var(--accent); border: 1px solid rgba(0,229,160,0.3) !important; }
  .drawer-btn-save:hover { background: rgba(0,229,160,0.22); }

  /* view button in table */
  .btn-view {
    background: rgba(0,229,160,0.08); border: 1px solid rgba(0,229,160,0.2);
    color: var(--accent); width: 28px; height: 28px; border-radius: 6px;
    font-size: 0.85rem; cursor: pointer; display:flex; align-items:center;
    justify-content:center; transition: all 0.2s; flex-shrink:0;
  }
  .btn-view:hover { background: rgba(0,229,160,0.18); }

  @media(max-width:480px) {
    .drawer-panel { max-width: 100%; border-left: none; border-top: 1px solid var(--border); }
    #itemDrawer { align-items: flex-end; }
    .drawer-panel { height: 90vh; border-radius: 16px 16px 0 0; }
    .drawer-panel { transform: translateY(100%); }
    #itemDrawer.open .drawer-panel { transform: translateY(0); }
  }

  /* ── DRAWER EDIT FIELDS ──────────────────────────────────────────────────── */
  .drawer-field.editable { border-color: rgba(0,229,160,0.25); background: rgba(0,229,160,0.03); }
  .drawer-field.readonly { opacity: 0.75; }
  .drawer-field-label-row {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;
  }
  .drawer-edit-tag {
    font-size: 0.58rem; font-family: var(--font-mono); color: var(--accent);
    background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.2);
    padding: 1px 6px; border-radius: 10px; letter-spacing: 1px;
  }
  .drawer-date-tag {
    font-size: 0.58rem; font-family: var(--font-mono); color: var(--accent2);
    background: rgba(0,119,255,0.1); border: 1px solid rgba(0,119,255,0.2);
    padding: 1px 6px; border-radius: 10px; letter-spacing: 1px;
  }
  .drawer-field-input {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.88rem;
    padding: 8px 11px; border-radius: 7px; outline: none; transition: all 0.2s;
  }
  .drawer-field-input:focus { border-color: var(--accent); background: var(--bg); }
  .drawer-field-input::placeholder { color: var(--muted); }
  .drawer-field-input[type="date"] {
    color-scheme: dark; cursor: pointer;
    border-color: rgba(0,119,255,0.3);
  }
  .drawer-field-input[type="date"]:focus { border-color: var(--accent2); }
  .drawer-field-textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-main); font-size: 0.88rem;
    padding: 8px 11px; border-radius: 7px; outline: none; transition: all 0.2s;
    resize: vertical; min-height: 70px; line-height: 1.5;
  }
  .drawer-field-textarea:focus { border-color: var(--accent); background: var(--bg); }
  .drawer-dropdown-wrap { position: relative; }
  .drawer-dropdown-btn {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    background: rgba(0,119,255,0.12); border: 1px solid rgba(0,119,255,0.25);
    color: var(--accent2); border-radius: 5px; width: 22px; height: 22px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .drawer-dropdown-btn:hover { background: rgba(0,119,255,0.25); }
  .drawer-field-input.has-dropdown { padding-right: 36px; }
  .btn-drawer-save-all {
    background: var(--accent); color: #0d0f14; width: 100%; padding: 12px;
    border-radius: 9px; font-family: var(--font-mono); font-size: 0.82rem;
    font-weight: 700; cursor: pointer; border: none; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    letter-spacing: 1px;
  }
  .btn-drawer-save-all:hover { background: #00ffb3; }

  /* ── ADMIN BLOCK MODAL ───────────────────────────────────────────────────── */
  #adminBlockModal {
    display: none; position: fixed; inset: 0; z-index: 1100;
    background: rgba(13,15,20,0.88); align-items: center; justify-content: center;
    padding: 20px;
  }
  #adminBlockModal.open { display: flex; }
  .admin-block-card {
    background: var(--surface); border: 1px solid rgba(255,107,53,0.4);
    border-radius: 16px; padding: 36px 32px; max-width: 380px; width: 100%;
    text-align: center; position: relative;
    box-shadow: 0 0 40px rgba(255,107,53,0.1);
  }
  .admin-block-icon { font-size: 3rem; margin-bottom: 16px; display: block; }
  .admin-block-title {
    font-family: var(--font-mono); font-size: 0.95rem; color: var(--warn);
    letter-spacing: 2px; margin-bottom: 12px;
  }
  .admin-block-msg {
    font-size: 0.84rem; color: var(--muted); line-height: 1.7; margin-bottom: 24px;
  }
  .admin-block-msg strong { color: var(--text); }
  .btn-admin-block-ok {
    background: var(--warn); color: #fff; border: none; border-radius: 9px;
    padding: 11px 32px; font-family: var(--font-mono); font-size: 0.82rem;
    font-weight: 700; cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
  }
  .btn-admin-block-ok:hover { filter: brightness(1.15); }

  /* ── CONFIRM MODAL ─────────────────────────────────── */
  #confirmModal{display:none;position:fixed;inset:0;z-index:1200;background:rgba(13,15,20,.88);align-items:center;justify-content:center;padding:20px}
  #confirmModal.open{display:flex}
  .confirm-card{background:var(--surface);border:1px solid rgba(255,107,53,.35);border-radius:16px;padding:36px 32px;max-width:400px;width:100%;text-align:center;box-shadow:0 0 40px rgba(255,107,53,.08)}
  .confirm-icon{font-size:2.8rem;margin-bottom:14px;display:block}
  .confirm-title{font-family:var(--font-mono);font-size:.95rem;color:var(--warn);letter-spacing:2px;margin-bottom:10px}
  .confirm-msg{font-size:.84rem;color:var(--muted);line-height:1.75;margin-bottom:28px}
  .confirm-msg strong{color:var(--text)}
  .confirm-btns{display:flex;gap:12px;justify-content:center}
  .btn-confirm-yes{background:var(--warn);color:#fff;border:none;border-radius:9px;padding:11px 32px;font-family:var(--font-mono);font-size:.82rem;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:1px}
  .btn-confirm-yes:hover{filter:brightness(1.15)}
  .btn-confirm-no{background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--muted);border-radius:9px;padding:11px 32px;font-family:var(--font-mono);font-size:.82rem;cursor:pointer;transition:all .2s;letter-spacing:1px}
  .btn-confirm-no:hover{color:var(--text);border-color:var(--text)}

  /* ── SCANNER MODAL ─────────────────────────────────── */
  #scannerModal{display:none;position:fixed;inset:0;z-index:1200;background:rgba(13,15,20,.95);align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:20px}
  #scannerModal.open{display:flex}
  .scanner-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;width:100%;max-width:480px;overflow:hidden}
  .scanner-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .scanner-title{font-family:var(--font-mono);color:var(--accent);font-size:.85rem;letter-spacing:2px}
  .scanner-close{background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.25);color:var(--warn);width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
  .scanner-video-wrap{position:relative;background:#000;width:100%;aspect-ratio:4/3;overflow:hidden}
  #scannerVideo{width:100%;height:100%;object-fit:cover;display:block}
  .scanner-crosshair{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .scanner-crosshair::before{content:'';display:block;width:70%;height:38%;border:2px solid var(--accent);border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,.45)}
  .scanner-line{position:absolute;left:15%;right:15%;height:2px;background:var(--accent);opacity:.7;animation:scanLine 1.8s ease-in-out infinite}
  @keyframes scanLine{0%,100%{top:31%}50%{top:63%}}
  .scanner-status{padding:10px 20px;text-align:center;font-family:var(--font-mono);font-size:.75rem;color:var(--muted)}
  .scanner-result{padding:14px 20px;border-top:1px solid var(--border);font-family:var(--font-mono);font-size:.82rem}
  .scanner-result-lbl{color:var(--muted);font-size:.7rem;letter-spacing:1px;margin-bottom:5px}
  .scanner-result-val{color:var(--accent);font-size:.95rem;font-weight:700;word-break:break-all}
  .scanner-actions{display:flex;gap:10px;padding:14px 20px;border-top:1px solid var(--border)}
  .btn-scan-use{flex:1;background:var(--accent);color:#0d0f14;border:none;border-radius:9px;padding:11px;font-family:var(--font-mono);font-size:.8rem;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px}
  .btn-scan-use:hover{background:#00ffb3}
  .btn-scan-use:disabled{opacity:.4;cursor:not-allowed}
  .btn-scan-retry{background:rgba(0,119,255,.1);border:1px solid rgba(0,119,255,.25);color:var(--accent2);border-radius:9px;padding:11px 18px;font-family:var(--font-mono);font-size:.8rem;cursor:pointer}

  /* ── REPORTS ───────────────────────────────────────── */
  #reportsScreen{display:none;min-height:100vh;background:var(--bg);padding-bottom:60px}
  #reportsScreen.active{display:block}
  .rpt-header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100}
  .rpt-body{padding:28px;max-width:960px;margin:0 auto}
  .rpt-filters{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px 24px;margin-bottom:24px}
  .rpt-filter-title{font-family:var(--font-mono);font-size:.72rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:16px}
  .rpt-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .rpt-grid label{display:block;font-size:.7rem;font-family:var(--font-mono);color:var(--muted);margin-bottom:5px;letter-spacing:1px;text-transform:uppercase}
  .rpt-sel,.rpt-inp{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:.85rem;padding:8px 11px;border-radius:8px;outline:none;transition:border-color .2s;cursor:pointer}
  .rpt-sel:focus,.rpt-inp:focus{border-color:var(--accent)}
  .rpt-sel option{background:var(--surface2)}
  .rpt-actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
  .btn-rpt-apply{background:var(--accent);color:#0d0f14;border:none;border-radius:8px;padding:9px 20px;font-family:var(--font-mono);font-size:.8rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:7px}
  .btn-rpt-apply:hover{background:#00ffb3}
  .btn-rpt-print{background:rgba(0,119,255,.1);border:1px solid rgba(0,119,255,.3);color:var(--accent2);border-radius:8px;padding:9px 20px;font-family:var(--font-mono);font-size:.8rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:7px}
  .btn-rpt-print:hover{background:rgba(0,119,255,.2)}
  .btn-rpt-clear{background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:9px 20px;font-family:var(--font-mono);font-size:.8rem;cursor:pointer}
  .rpt-kpis{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-bottom:24px}
  .rpt-kpi{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 16px;text-align:center}
  .rpt-kpi-val{font-family:var(--font-mono);font-size:1.5rem;font-weight:700;color:var(--accent);display:block;margin-bottom:4px}
  .rpt-kpi-lbl{font-size:.68rem;color:var(--muted);font-family:var(--font-mono)}
  .rpt-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .rpt-table-hdr{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-family:var(--font-mono);font-size:.75rem;color:var(--muted)}
  .rpt-table-hdr span{color:var(--accent);font-weight:700}
  .rpt-table{width:100%;border-collapse:collapse;font-size:.82rem}
  .rpt-table th{text-align:left;padding:9px 12px;color:var(--muted);font-size:.68rem;font-family:var(--font-mono);letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);background:var(--surface2)}
  .rpt-table td{padding:9px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
  .rpt-table tr:last-child td{border-bottom:none}
  .rpt-table tr:hover td{background:var(--surface2)}

  /* ── PRINT ─────────────────────────────────────────── */
  @media print{body>*:not(#printArea){display:none!important}#printArea{display:block!important;position:fixed;inset:0;background:#fff;color:#000;padding:20px;font-size:12px}#printArea table{width:100%;border-collapse:collapse}#printArea th,#printArea td{border:1px solid #ccc;padding:6px 10px;text-align:left}#printArea th{background:#f0f0f0;font-weight:bold}.print-title{font-size:18px;font-weight:bold;margin-bottom:4px}.print-sub{font-size:11px;color:#555;margin-bottom:16px}}
  #printArea{display:none}

  /* ── ORDENS DE SERVIÇO SCREEN ─────────────────────── */
  #ordensScreen{display:none;min-height:100vh;background:var(--bg);padding-bottom:60px}
  #ordensScreen.active{display:block}
  .os-header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;flex-wrap:wrap}
  .os-body{padding:24px 28px;max-width:1200px;margin:0 auto}
  .os-kpis{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px;margin-bottom:28px}
  .os-kpi{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px 18px;text-align:center}
  .os-kpi-val{font-family:var(--font-mono);font-size:1.6rem;font-weight:700;display:block;margin-bottom:4px}
  .os-kpi-lbl{font-size:.68rem;color:var(--muted);font-family:var(--font-mono);letter-spacing:1px}
  .os-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px}
  .os-table-hdr{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .os-table{width:100%;border-collapse:collapse;font-size:.83rem}
  .os-table th{text-align:left;padding:9px 12px;color:var(--muted);font-size:.68rem;font-family:var(--font-mono);letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap}
  .os-table td{padding:9px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
  .os-table tr:last-child td{border-bottom:none}
  .os-table tr:hover td{background:var(--surface2)}
  .os-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:.7rem;font-weight:600;font-family:var(--font-mono)}
  .os-aberta{background:rgba(0,229,160,.1);color:var(--accent)}
  .os-andamento{background:rgba(245,158,11,.1);color:#f59e0b}
  .os-concluida{background:rgba(0,119,255,.1);color:var(--accent2)}
  .os-cancelada{background:rgba(255,107,53,.1);color:var(--warn)}
  .btn-os-new{background:#f59e0b;color:#0d0f14;border:none;border-radius:8px;padding:9px 18px;font-family:var(--font-mono);font-size:.8rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s}
  .btn-os-new:hover{background:#fbbf24}
  .btn-os-act{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);color:#f59e0b;width:28px;height:28px;border-radius:6px;font-size:.82rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
  .btn-os-act:hover{background:rgba(245,158,11,.25)}

  /* OS Modal */
  #osModal{display:none;position:fixed;inset:0;z-index:1100;background:rgba(13,15,20,.92);align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
  #osModal.open{display:flex}
  .os-modal-card{background:var(--surface);border:1px solid rgba(245,158,11,.3);border-radius:18px;width:100%;max-width:700px;margin:auto}
  .os-modal-hdr{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .os-modal-title{font-family:var(--font-mono);color:#f59e0b;font-size:.9rem;letter-spacing:2px}
  .os-modal-body{padding:22px}
  .os-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:520px){.os-form-grid{grid-template-columns:1fr}}
  .os-field{margin-bottom:0}
  .os-field label{display:block;font-size:.7rem;font-family:var(--font-mono);color:var(--muted);margin-bottom:5px;letter-spacing:1px;text-transform:uppercase}
  .os-input,.os-select,.os-textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font-main);font-size:.88rem;padding:9px 12px;border-radius:8px;outline:none;transition:border-color .2s}
  .os-input:focus,.os-select:focus,.os-textarea:focus{border-color:#f59e0b}
  .os-select{cursor:pointer}.os-select option{background:var(--surface2)}
  .os-textarea{resize:vertical;min-height:80px;line-height:1.5}
  .os-modal-footer{padding:16px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
  .btn-os-save{background:#f59e0b;color:#0d0f14;border:none;border-radius:9px;padding:10px 24px;font-family:var(--font-mono);font-size:.82rem;font-weight:700;cursor:pointer;transition:all .2s}
  .btn-os-save:hover{background:#fbbf24}
  .btn-os-cancel{background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--muted);border-radius:9px;padding:10px 24px;font-family:var(--font-mono);font-size:.82rem;cursor:pointer;transition:all .2s}
  .btn-os-cancel:hover{color:var(--text)}
  .os-mat-list{background:var(--surface2);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:8px}
  .os-mat-row{display:grid;grid-template-columns:1fr 80px 80px 36px;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)}
  .os-mat-row:last-child{border-bottom:none}
  .os-mat-hdr{background:var(--surface);font-family:var(--font-mono);font-size:.66rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
  .btn-os-add-mat{background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.25);color:#06b6d4;border-radius:7px;padding:7px 14px;font-family:var(--font-mono);font-size:.76rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
  .btn-os-add-mat:hover{background:rgba(6,182,212,.2)}
  .btn-os-del-mat{background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.2);color:var(--warn);width:28px;height:28px;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem}

  /* OS Detail Drawer */
  #osDetailDrawer{position:fixed;inset:0;z-index:800;display:flex;justify-content:flex-end;pointer-events:none}
  #osDetailDrawer.open{pointer-events:all}
  #osDetailDrawer .drawer-backdrop{position:absolute;inset:0;background:rgba(13,15,20,0);transition:background .3s}
  #osDetailDrawer.open .drawer-backdrop{background:rgba(13,15,20,.75)}
  #osDetailDrawer .drawer-panel{position:relative;width:100%;max-width:480px;background:var(--surface);border-left:1px solid var(--border);height:100%;overflow-y:auto;transform:translateX(100%);transition:transform .32s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
  #osDetailDrawer.open .drawer-panel{transform:translateX(0)}
  .os-detail-section{margin-bottom:20px}
  .os-detail-section-title{font-family:var(--font-mono);font-size:.68rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
  .os-detail-row{display:flex;justify-content:space-between;align-items:flex-start;padding:6px 0;border-bottom:1px solid rgba(42,48,80,.5)}
  .os-detail-row:last-child{border-bottom:none}
  .os-detail-lbl{font-size:.72rem;color:var(--muted);font-family:var(--font-mono)}
  .os-detail-val{font-size:.84rem;color:var(--text);text-align:right;max-width:60%}
  .os-status-select{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:.78rem;padding:5px 9px;border-radius:6px;cursor:pointer;outline:none}
  .os-status-select:focus{border-color:#f59e0b}

  /* ── ESTOQUE SCREEN ────────────────────────────────── */
  #estoqueScreen{display:none;min-height:100vh;background:var(--bg);padding-bottom:60px}
  #estoqueScreen.active{display:block}
  .est-header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;flex-wrap:wrap}
  .est-body{padding:24px 28px;max-width:1200px;margin:0 auto}
  .est-tabs{display:flex;gap:0;background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:24px;width:fit-content}
  .est-tab{padding:9px 20px;font-family:var(--font-mono);font-size:.78rem;background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .2s;border-right:1px solid var(--border)}
  .est-tab:last-child{border-right:none}
  .est-tab.active{background:var(--surface2);color:#06b6d4}
  .est-kpis{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:14px;margin-bottom:28px}
  .est-kpi{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px 18px;text-align:center}
  .est-kpi-val{font-family:var(--font-mono);font-size:1.6rem;font-weight:700;color:#06b6d4;display:block;margin-bottom:4px}
  .est-kpi-lbl{font-size:.68rem;color:var(--muted);font-family:var(--font-mono);letter-spacing:1px}
  .est-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px}
  .est-table-hdr{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .est-table{width:100%;border-collapse:collapse;font-size:.83rem}
  .est-table th{text-align:left;padding:9px 12px;color:var(--muted);font-size:.68rem;font-family:var(--font-mono);letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap}
  .est-table td{padding:9px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
  .est-table tr:last-child td{border-bottom:none}
  .est-table tr:hover td{background:var(--surface2)}
  .btn-est-new{background:#06b6d4;color:#0d0f14;border:none;border-radius:8px;padding:9px 18px;font-family:var(--font-mono);font-size:.8rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s}
  .btn-est-new:hover{background:#22d3ee}
  .est-saldo-ok{color:var(--accent)}
  .est-saldo-low{color:#ffc107}
  .est-saldo-zero{color:var(--warn)}

  /* NF Modal */
  #nfModal{display:none;position:fixed;inset:0;z-index:1100;background:rgba(13,15,20,.92);align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
  #nfModal.open{display:flex}
  .nf-modal-card{background:var(--surface);border:1px solid rgba(6,182,212,.3);border-radius:18px;width:100%;max-width:680px;margin:auto}
  .nf-modal-hdr{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .nf-modal-title{font-family:var(--font-mono);color:#06b6d4;font-size:.9rem;letter-spacing:2px}
  .nf-modal-body{padding:22px}
  .nf-scan-area{background:var(--surface2);border:2px dashed var(--border);border-radius:12px;padding:20px;margin-bottom:20px;text-align:center;cursor:pointer;transition:all .2s}
  .nf-scan-area:hover{border-color:#06b6d4;background:rgba(6,182,212,.04)}
  .nf-scan-area.scanning{border-color:#06b6d4;animation:pulse .8s infinite}
  .nf-scan-icon{font-size:2.5rem;margin-bottom:10px;display:block}
  .nf-scan-lbl{font-family:var(--font-mono);font-size:.78rem;color:var(--muted)}
  .nf-data-card{background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.2);border-radius:10px;padding:16px;margin-bottom:18px;display:none}
  .nf-data-card.show{display:block}
  .nf-data-row{display:flex;justify-content:space-between;padding:5px 0;font-size:.82rem;border-bottom:1px solid rgba(42,48,80,.5)}
  .nf-data-row:last-child{border-bottom:none}
  .nf-data-lbl{color:var(--muted);font-family:var(--font-mono);font-size:.7rem}
  .nf-data-val{color:var(--text);font-weight:600}
  .nf-itens-wrap{margin-bottom:18px}
  .nf-item-row{display:grid;grid-template-columns:1fr 80px 90px 36px;gap:8px;align-items:center;padding:7px 10px;border-bottom:1px solid var(--border);background:var(--surface2);border-radius:0}
  .nf-item-row:first-child{border-radius:8px 8px 0 0}
  .nf-item-row:last-child{border-bottom:none;border-radius:0 0 8px 8px}
  .nf-item-hdr{background:var(--surface)!important;font-family:var(--font-mono);font-size:.66rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
  .nf-input{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:.82rem;padding:5px 8px;border-radius:6px;outline:none}
  .nf-input:focus{border-color:#06b6d4}
  .nf-modal-footer{padding:16px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
  .btn-nf-save{background:#06b6d4;color:#0d0f14;border:none;border-radius:9px;padding:10px 24px;font-family:var(--font-mono);font-size:.82rem;font-weight:700;cursor:pointer;transition:all .2s}
  .btn-nf-save:hover{background:#22d3ee}
  .btn-nf-scan{background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.3);color:#06b6d4;border-radius:9px;padding:10px 18px;font-family:var(--font-mono);font-size:.82rem;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s}
  .btn-nf-scan:hover{background:rgba(6,182,212,.2)}

  /* NF Scanner */
  #nfScannerModal{display:none;position:fixed;inset:0;z-index:1300;background:rgba(13,15,20,.97);align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:20px}
  #nfScannerModal.open{display:flex}
  .nfscan-instruction{font-family:var(--font-mono);font-size:.75rem;color:var(--muted);text-align:center;max-width:380px}
  .nfscan-manual{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;width:100%;max-width:480px}
  .nfscan-manual-title{font-family:var(--font-mono);font-size:.7rem;color:var(--muted);margin-bottom:10px;letter-spacing:1px}
  .nfscan-input-wrap{display:flex;gap:8px}
  .nfscan-inp{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:.82rem;padding:9px 12px;border-radius:8px;outline:none}
  .nfscan-inp:focus{border-color:#06b6d4}
  .btn-nfscan-go{background:#06b6d4;color:#0d0f14;border:none;border-radius:8px;padding:9px 16px;font-family:var(--font-mono);font-size:.8rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s}
  .btn-nfscan-go:hover{background:#22d3ee}
  .btn-nfscan-close{background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.25);color:var(--warn);border-radius:9px;padding:9px 20px;font-family:var(--font-mono);font-size:.8rem;cursor:pointer}

  /* Equipment search autocomplete */
  .equip-search-wrap{position:relative}
  .equip-results{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid #f59e0b;border-radius:8px;z-index:2000;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.5);margin-top:3px;max-height:220px;overflow-y:auto}
  .equip-result-item{padding:10px 13px;font-size:.82rem;cursor:pointer;color:var(--text);border-bottom:1px solid var(--border);transition:background .12s}
  .equip-result-item:last-child{border-bottom:none}
  .equip-result-item:hover{background:var(--surface2);color:#f59e0b}
  .equip-result-tag{font-family:var(--font-mono);font-size:.68rem;color:var(--muted);margin-top:2px}
  .equip-result-sel{background:rgba(245,158,11,.08);border-left:3px solid #f59e0b}
  .equip-no-results{padding:12px 13px;font-family:var(--font-mono);font-size:.72rem;color:var(--muted);text-align:center}
</style>
</head>
<body>

<!-- ── AUTH OVERLAY ──────────────────────────────────────────────────────── -->
<div id="authOverlay">
  <div class="auth-card">
    <div class="auth-logo">INV<span>//</span>CTRL</div>
    <div class="auth-subtitle">Sistema de controle de inventário</div>

    <div id="authErr" class="auth-err"></div>

    <div class="auth-field">
      <label>Usuário</label>
      <input class="auth-input" id="loginUser" type="text" placeholder="seu usuário" autocomplete="username">
    </div>
    <div class="auth-field">
      <label>Senha</label>
      <input class="auth-input" id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password">
    </div>
    <button class="btn-auth" onclick="doLogin()">ENTRAR →</button>
  </div>
</div>

<!-- ── ADMIN PANEL ──────────────────────────────────────────────────────────── -->
<div id="adminOverlay" style="display:none;position:fixed;inset:0;z-index:900;background:rgba(13,15,20,0.92);align-items:center;justify-content:center;padding:20px;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;padding:32px 30px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <div>
        <div style="font-family:var(--font-mono);color:var(--accent);font-size:0.9rem;letter-spacing:2px;">PAINEL ADMIN</div>
        <div style="font-size:0.74rem;color:var(--muted);font-family:var(--font-mono);margin-top:2px;">Gerenciamento de usuários</div>
      </div>
      <button onclick="closeAdmin()" style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.25);color:var(--warn);padding:6px 13px;border-radius:7px;font-family:var(--font-mono);font-size:0.75rem;cursor:pointer;">✕ Fechar</button>
    </div>

    <!-- User list -->
    <div style="margin-bottom:24px;">
      <div style="font-size:0.72rem;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Usuários cadastrados</div>
      <div id="adminUserList"></div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin-bottom:22px;">

    <!-- Add user -->
    <div style="font-size:0.72rem;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;">Adicionar usuário</div>
    <div id="adminErr" class="auth-err"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="auth-field"><label>Nome completo</label><input class="auth-input" id="regName" type="text" placeholder="João Silva"></div>
      <div class="auth-field"><label>Usuário</label><input class="auth-input" id="regUser" type="text" placeholder="joaosilva"></div>
      <div class="auth-field"><label>Senha</label><input class="auth-input" id="regPass" type="password" placeholder="mín. 6 caracteres"></div>
      <div class="auth-field"><label>Confirmar senha</label><input class="auth-input" id="regPass2" type="password" placeholder="repita a senha"></div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <label style="display:flex;align-items:center;gap:7px;font-family:var(--font-mono);font-size:0.75rem;color:var(--muted);cursor:pointer;">
        <input type="checkbox" id="regIsAdmin" style="accent-color:var(--accent)"> Admin
      </label>
      <button class="btn-auth" style="flex:1" onclick="doRegister()">ADICIONAR USUÁRIO →</button>
    </div>

    <!-- Change password -->
    <hr style="border:none;border-top:1px solid var(--border);margin:22px 0;">
    <div style="font-size:0.72rem;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;">Alterar senha de usuário</div>
    <div id="adminPassErr" class="auth-err"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="auth-field"><label>Usuário</label>
        <select class="auth-input" id="chgUser" style="cursor:pointer;"></select>
      </div>
      <div class="auth-field"><label>Nova senha</label><input class="auth-input" id="chgPass" type="password" placeholder="mín. 6 caracteres"></div>
      <div class="auth-field"><label>Confirmar</label><input class="auth-input" id="chgPass2" type="password" placeholder="repita"></div>
    </div>
    <button class="btn-auth" onclick="doChangePass()" style="background:rgba(0,119,255,0.15);color:var(--accent2);border:1px solid rgba(0,119,255,0.3);">ALTERAR SENHA →</button>
  </div>
</div>


<!-- ── NAVIGATION SCREEN ─────────────────────────────────────────────────── -->
<div id="navScreen">
  <!-- top bar with user info and logout -->
  <div style="position:absolute;top:0;left:0;right:0;padding:16px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--surface);">
    <div style="font-family:var(--font-mono);font-size:0.9rem;color:var(--accent);letter-spacing:2px;">INV<span style="color:var(--muted)">//</span>CTRL</div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span style="font-family:var(--font-mono);font-size:0.75rem;color:var(--muted);">👤 <strong id="navUserName" style="color:var(--text)"></strong></span>
      <button onclick="doLogout()" style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.25);color:var(--warn);padding:5px 12px;border-radius:6px;font-size:0.73rem;font-weight:600;cursor:pointer;font-family:var(--font-mono);transition:all 0.2s;">Sair</button>
    </div>
  </div>

  <div style="text-align:center;margin-top:20px;">
    <div class="nav-subtitle">Selecione uma opção para continuar</div>
    <div class="nav-sync-status" style="justify-content:center;margin-top:10px;">
      <div class="dot" id="navSyncDot"></div>
      <span id="navSyncLabel">Carregando dados...</span>
    </div>
  </div>

  <div class="nav-cards">
    <div class="nav-card inv" onclick="goTo('inventory')">
      <span class="nav-card-icon">📦</span>
      <div class="nav-card-title">INVENTÁRIO</div>
      <div class="nav-card-desc">Consulte, edite e gerencie todos os itens carregados da planilha.</div>
    </div>
    <div class="nav-card chart" onclick="goTo('charts')">
      <span class="nav-card-icon">📊</span>
      <div class="nav-card-title">GRÁFICOS</div>
      <div class="nav-card-desc">Visualize o percentual de itens Moderados em relação ao total.</div>
    </div>
    <div class="nav-card" style="border-color:var(--border)" onclick="goTo('reports')"
      onmouseenter="this.style.borderColor='#a855f7';this.style.boxShadow='0 8px 32px rgba(168,85,247,0.12)';this.style.transform='translateY(-4px)'"
      onmouseleave="this.style.borderColor='var(--border)';this.style.boxShadow='';this.style.transform=''">
      <span class="nav-card-icon">🗂️</span>
      <div class="nav-card-title" style="color:#a855f7">RELATÓRIOS</div>
      <div class="nav-card-desc">Filtre, visualize e imprima relatórios personalizados da planilha.</div>
    </div>
    <div class="nav-card" style="border-color:var(--border)" onclick="goTo('ordens')"
      onmouseenter="this.style.borderColor='#f59e0b';this.style.boxShadow='0 8px 32px rgba(245,158,11,0.12)';this.style.transform='translateY(-4px)'"
      onmouseleave="this.style.borderColor='var(--border)';this.style.boxShadow='';this.style.transform=''">
      <span class="nav-card-icon">🔧</span>
      <div class="nav-card-title" style="color:#f59e0b">ORDENS DE SERVIÇO</div>
      <div class="nav-card-desc">Gerencie ordens de serviço integradas ao CMMS SAP com controle de materiais.</div>
    </div>
    <div class="nav-card" style="border-color:var(--border)" onclick="goTo('estoque')"
      onmouseenter="this.style.borderColor='#06b6d4';this.style.boxShadow='0 8px 32px rgba(6,182,212,0.12)';this.style.transform='translateY(-4px)'"
      onmouseleave="this.style.borderColor='var(--border)';this.style.boxShadow='';this.style.transform=''">
      <span class="nav-card-icon">🏪</span>
      <div class="nav-card-title" style="color:#06b6d4">ESTOQUE</div>
      <div class="nav-card-desc">Controle entradas por NF-e com câmera, saldos e movimentações vinculadas às OSs.</div>
    </div>
  </div>
</div>

<!-- ── CHART SCREEN ───────────────────────────────────────────────────────── -->
<div id="chartScreen">
  <div class="chart-header">
    <button class="btn-back" onclick="goTo('nav')">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
      Voltar
    </button>
    <div style="font-family:var(--font-mono);font-size:0.85rem;color:var(--accent);letter-spacing:2px;">GRÁFICOS</div>
    <div style="margin-left:auto;font-family:var(--font-mono);font-size:0.72rem;color:var(--muted)" id="chartLastSync"></div>
  </div>
  <div class="chart-body">
    <div id="chartContent"></div>
  </div>
</div>

<!-- ── INVENTORY SCREEN ────────────────────────────────────────────────────── -->
<div id="inventoryScreen" style="display:none;">
<header>
  <button class="btn-back" onclick="goTo('nav')" style="margin-right:8px;">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <polyline points="15 18 9 12 15 6"/>
    </svg>
    Menu
  </button>
  <div class="logo">INV<span>//</span>CTRL</div>
  <div class="stats">
    <span>Total: <strong id="statTotal">0</strong></span>
    <span>Consolidados: <strong id="statLocked">0</strong></span>
    <span id="statLow" style="display:none"></span>
  </div>
  <div class="user-badge">
    <span>👤 <strong id="headerUser"></strong></span>
    <button id="btnAdminPanel" onclick="openAdmin()" style="display:none;background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.3);color:var(--accent);padding:4px 10px;border-radius:6px;font-size:0.72rem;font-weight:600;cursor:pointer;font-family:var(--font-mono);">⚙ Admin</button>
    <div id="notifWrap" style="display:none;position:relative;">
      <button onclick="toggleNotifPanel()"
        style="background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.25);color:var(--accent);width:30px;height:30px;border-radius:6px;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;"
        title="Notificações">🔔
        <span id="notifBadge" style="display:none;position:absolute;top:-5px;right:-5px;background:var(--warn);color:#fff;border-radius:50%;width:16px;height:16px;font-size:.6rem;font-weight:700;align-items:center;justify-content:center;font-family:var(--font-mono);">0</span>
      </button>
      <div id="notifPanel" style="display:none;position:absolute;right:0;top:38px;width:300px;background:var(--surface);border:1px solid var(--border);border-radius:12px;z-index:500;box-shadow:0 8px 32px rgba(0,0,0,.4);overflow:hidden;"></div>
    </div>
    <button class="btn-logout" onclick="doLogout()">Sair</button>
  </div>
</header>

<div class="sync-bar">
  <div class="sync-status">
    <div class="dot" id="syncDot"></div>
    <span id="syncLabel">Não sincronizado</span>
  </div>
  <span id="lastSync" style="color:var(--muted);font-size:0.74rem;font-family:var(--font-mono)"></span>
  <button class="btn-file" onclick="document.getElementById('fileInput').click()">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    Carregar Arquivo
  </button>
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="loadLocalFile(event)">
  <button class="btn-sync" id="btnSync" onclick="syncSheet()">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
    </svg>
    Sincronizar Planilha
  </button>
  <button class="btn-publish" id="btnPublish" onclick="publishChanges()" style="display:none">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
      <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
    </svg>
    Publicar Alterações <span id="pendingCount"></span>
  </button>
</div>

<div id="colInfo" style="display:none"><span id="colInfoText"></span></div>

<div class="toolbar">
  <div class="search-wrap">
    <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    <input class="search-input" id="searchInput" type="text" placeholder="Buscar em qualquer coluna..." onkeydown="if(event.key==='Enter') doSearch()">
  </div>
  <button class="btn btn-search" onclick="doSearch()">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    Buscar
  </button>
  <button class="btn" style="background:rgba(0,229,160,.1);border:1px solid rgba(0,229,160,.3);color:var(--accent)" onclick="openScanner()" title="Ler código de barras">
    <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
      <circle cx="12" cy="13" r="4"/>
    </svg>
    Câmera
  </button>
  <button class="btn btn-add" onclick="addRow()">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    Novo Item
  </button>
</div>

<div class="filter-tabs">
  <button class="filter-tab active" onclick="setFilter('all',this)">Todos</button>
  <button class="filter-tab" onclick="setFilter('ok',this)">ATIVO</button>
  <button class="filter-tab" onclick="setFilter('low',this)">Baixo estoque</button>
  <button class="filter-tab" onclick="setFilter('out',this)">Sem estoque</button>
  <button class="filter-tab" onclick="setFilter('locked',this)">Consolidados</button>
</div>

<div class="table-wrap">
  <table>
    <thead><tr id="tHead"></tr></thead>
    <tbody id="tBody"></tbody>
  </table>
  <div class="empty" id="emptyState">
    <h3 id="emptyTitle">Pronto para conectar!</h3>
    <p id="emptyMsg">Clique em <strong style="color:var(--accent)">Sincronizar Planilha</strong> para carregar<br>seus dados do Google Sheets automaticamente.</p>
  </div>
  <div class="empty" id="searchPrompt" style="display:none;">
    <div style="font-size:2.5rem;margin-bottom:16px;">🔍</div>
    <h3>Digite para buscar</h3>
    <p>Use a barra de pesquisa acima para localizar itens.<br>
    <span style="color:var(--muted);font-family:var(--font-mono);font-size:0.75rem;">
      <strong id="searchPromptCount" style="color:var(--accent)">0</strong> itens carregados
    </span></p>
  </div>
</div>

</div><!-- /inventoryScreen -->

<!-- ── REPORTS SCREEN ── -->
<div id="reportsScreen">
  <div class="rpt-header">
    <button class="btn-back" onclick="goTo('nav')">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
      Menu
    </button>
    <div style="font-family:var(--font-mono);font-size:.85rem;color:#a855f7;letter-spacing:2px;">RELATÓRIOS</div>
    <div style="margin-left:auto;font-family:var(--font-mono);font-size:.72rem;color:var(--muted)" id="rptSyncLbl"></div>
  </div>
  <div class="rpt-body">
    <div class="rpt-filters">
      <div class="rpt-filter-title">⚙ Filtros</div>
      <div class="rpt-grid" id="rptFilterGrid">
        <div><label>Status</label>
          <select class="rpt-sel" id="rFilterStatus">
            <option value="all">Todos</option><option value="ok">ATIVO</option>
            <option value="low">Baixo estoque</option><option value="out">Sem estoque</option>
            <option value="locked">Consolidados</option>
          </select>
        </div>
        <div><label>Busca geral</label>
          <input class="rpt-inp" id="rFilterSearch" type="text" placeholder="Qualquer campo...">
        </div>
      </div>
      <div class="rpt-actions">
        <button class="btn-rpt-apply" onclick="applyRptFilter()">🔍 Aplicar filtros</button>
        <button class="btn-rpt-print" onclick="printRpt()">🖨️ Imprimir</button>
        <button class="btn-rpt-clear" onclick="clearRptFilter()">Limpar</button>
      </div>
    </div>
    <div class="rpt-kpis" id="rptKpis"></div>
    <div class="rpt-table-wrap">
      <div class="rpt-table-hdr">Resultados: <span id="rptCount">0</span> itens</div>
      <div style="overflow-x:auto">
        <table class="rpt-table"><thead><tr id="rptHead"></tr></thead><tbody id="rptBody"></tbody></table>
      </div>
      <div id="rptEmpty" style="display:none;text-align:center;padding:50px;color:var(--muted);">
        <div style="font-size:2rem;margin-bottom:12px;">🗂️</div>
        <div style="font-family:var(--font-mono);font-size:.85rem;">Nenhum resultado</div>
      </div>
    </div>
  </div>
</div>

<!-- ── CONFIRM MODAL ── -->
<div id="confirmModal">
  <div class="confirm-card">
    <span class="confirm-icon" id="confirmIcon">🔒</span>
    <div class="confirm-title" id="confirmTitle">CONSOLIDAR ITEM</div>
    <div class="confirm-msg" id="confirmMsg"></div>
    <div class="confirm-btns">
      <button class="btn-confirm-yes" id="confirmYesBtn">Sim, consolidar</button>
      <button class="btn-confirm-no" onclick="closeConfirm()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ── SCANNER MODAL ── -->
<div id="scannerModal">
  <div class="scanner-card">
    <div class="scanner-header">
      <span class="scanner-title">📷 LEITOR DE CÓDIGO DE BARRAS</span>
      <button class="scanner-close" onclick="closeScanner()">✕</button>
    </div>
    <div class="scanner-video-wrap">
      <video id="scannerVideo" playsinline autoplay muted></video>
      <div class="scanner-crosshair"><div class="scanner-line"></div></div>
    </div>
    <div class="scanner-status" id="scannerStatus">Aponte a câmera para o código de barras</div>
    <div class="scanner-result" id="scannerResultBox" style="display:none">
      <div class="scanner-result-lbl">CÓDIGO DETECTADO</div>
      <div class="scanner-result-val" id="scannerResultVal"></div>
    </div>
    <div class="scanner-actions">
      <button class="btn-scan-use" id="btnScanUse" disabled onclick="useScannedCode()">✅ Usar código na busca</button>
      <button class="btn-scan-retry" onclick="restartScanner()">↺ Novo scan</button>
    </div>
  </div>
</div>

<!-- ── PRINT AREA ── -->
<div id="printArea"></div>

<!-- ══════════════════════════════════════════════════════
     ORDENS DE SERVIÇO SCREEN
══════════════════════════════════════════════════════ -->
<div id="ordensScreen">
  <div class="os-header">
    <button class="btn-back" onclick="goTo('nav')">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
      Menu
    </button>
    <div style="font-family:var(--font-mono);font-size:.85rem;color:#f59e0b;letter-spacing:2px;">🔧 ORDENS DE SERVIÇO</div>
    <div style="display:flex;gap:8px;margin-left:auto;flex-wrap:wrap;align-items:center">
      <div class="search-wrap" style="min-width:180px;">
        <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" id="osSearchInput" type="text" placeholder="Buscar OS..." oninput="renderOrdens()">
      </div>
      <select id="osFilterStatus" onchange="renderOrdens()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:.76rem;padding:8px 10px;border-radius:8px;cursor:pointer;outline:none;">
        <option value="">Todos os status</option>
        <option value="Aberta">Aberta</option>
        <option value="Em Andamento">Em Andamento</option>
        <option value="Concluída">Concluída</option>
        <option value="Cancelada">Cancelada</option>
      </select>
      <button class="btn-os-new" onclick="openOsModal()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Nova OS
      </button>
    </div>
  </div>
  <div class="os-body">
    <div class="os-kpis" id="osKpis"></div>
    <div class="os-table-wrap" id="osTableWrap" style="display:none">
      <div class="os-table-hdr">
        <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--muted);">Ordens de Serviço · <span id="osCount" style="color:#f59e0b;font-weight:700;">0</span> registros</span>
      </div>
      <div style="overflow-x:auto">
        <table class="os-table">
          <thead><tr>
            <th>Ações</th><th>N° OS / SAP</th><th>Tipo</th><th>Equipamento</th><th>Setor</th>
            <th>Responsável</th><th>Prioridade</th><th>Status</th><th>Data Abertura</th><th>Prazo</th>
          </tr></thead>
          <tbody id="osBody"></tbody>
        </table>
      </div>
      <div id="osEmpty" style="text-align:center;padding:50px;color:var(--muted);display:none;">
        <div style="font-size:2rem;margin-bottom:12px;">🔧</div>
        <div style="font-family:var(--font-mono);font-size:.85rem;">Nenhuma OS encontrada</div>
        <div style="font-size:.78rem;margin-top:6px;">Clique em "Nova OS" para criar a primeira</div>
      </div>
    </div>
  </div>
</div>

<!-- OS Modal (criar/editar) -->
<div id="osModal">
  <div class="os-modal-card">
    <div class="os-modal-hdr">
      <span class="os-modal-title" id="osModalTitle">🔧 NOVA ORDEM DE SERVIÇO</span>
      <button onclick="closeOsModal()" style="background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.25);color:var(--warn);width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;">✕</button>
    </div>
    <div class="os-modal-body">
      <div style="background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:14px 16px;margin-bottom:18px;font-family:var(--font-mono);font-size:.72rem;color:var(--muted);">
        💡 Baseado no padrão CMMS SAP PM — Preencha os campos conforme a notificação/ordem SAP
      </div>
      <div class="os-form-grid">
        <div class="os-field">
          <label>N° OS <span style="color:#f59e0b;font-size:.65rem;background:rgba(245,158,11,.12);padding:1px 6px;border-radius:8px;font-family:var(--font-mono);">AUTO</span></label>
          <input class="os-input" id="osNumSap" type="text" readonly style="cursor:default;opacity:.7;font-family:var(--font-mono);color:#f59e0b;" placeholder="Gerado automaticamente">
        </div>
        <div class="os-field">
          <label>Tipo de Ordem</label>
          <select class="os-select" id="osTipo">
            <option>PM01 - Manutenção Corretiva</option>
            <option>PM02 - Manutenção Preventiva</option>
            <option>PM03 - Manutenção Preditiva</option>
            <option>PM04 - Manutenção de Melhoria</option>
            <option>PM05 - Inspeção</option>
          </select>
        </div>
        <div class="os-field" style="position:relative">
          <label>Equipamento / TAG <span style="color:var(--accent2);font-size:.62rem;font-family:var(--font-mono);">busca no inventário</span></label>
          <div class="equip-search-wrap">
            <input class="os-input" id="osEquipamento" type="text"
              placeholder="Digite TAG, modelo, nº de série ou descrição..."
              autocomplete="off" spellcheck="false"
              oninput="searchEquipamento(this.value)"
              onfocus="if(this.value.length>0) searchEquipamento(this.value)"
              onblur="setTimeout(closeEquipResults, 220)">
            <div class="equip-results" id="equipResults" style="display:none"></div>
          </div>
          <div id="osEquipHint" style="font-family:var(--font-mono);font-size:.66rem;color:var(--accent2);margin-top:4px;min-height:14px;"></div>
        </div>
        <div class="os-field">
          <label>Setor / Centro de Custo</label>
          <input class="os-input" id="osSetor" type="text" placeholder="Ex: Utilidades / CC-1025">
        </div>
        <div class="os-field">
          <label>Responsável Técnico</label>
          <input class="os-input" id="osResponsavel" type="text" placeholder="Nome do técnico">
        </div>
        <div class="os-field">
          <label>Prioridade</label>
          <select class="os-select" id="osPrioridade">
            <option>1 - Muito Alta</option>
            <option>2 - Alta</option>
            <option selected>3 - Média</option>
            <option>4 - Baixa</option>
          </select>
        </div>
        <div class="os-field">
          <label>Data de Abertura</label>
          <input class="os-input" id="osDataAbertura" type="date">
        </div>
        <div class="os-field">
          <label>Prazo de Conclusão</label>
          <input class="os-input" id="osDataPrazo" type="date">
        </div>
        <div class="os-field">
          <label>Status</label>
          <select class="os-select" id="osStatus">
            <option>Aberta</option>
            <option>Em Andamento</option>
            <option>Concluída</option>
            <option>Cancelada</option>
          </select>
        </div>
        <div class="os-field">
          <label>Centro de Trabalho</label>
          <input class="os-input" id="osCentroTrabalho" type="text" placeholder="Ex: MANUT-EL">
        </div>
      </div>
      <div class="os-field" style="margin-top:14px;">
        <label>Descrição / Sintoma</label>
        <textarea class="os-textarea" id="osDescricao" rows="3" placeholder="Descreva o problema ou serviço a realizar..."></textarea>
      </div>

      <!-- Materiais -->
      <div style="margin-top:18px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <span style="font-family:var(--font-mono);font-size:.72rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;">📦 Materiais / Peças Utilizadas</span>
          <button class="btn-os-add-mat" onclick="addOsMatRow()">+ Adicionar</button>
        </div>
        <div class="os-mat-list" id="osMatList">
          <div class="os-mat-row os-mat-hdr">
            <span>Descrição do material</span><span>Qtd</span><span>Und</span><span></span>
          </div>
        </div>
        <div id="osMatEmpty" style="font-family:var(--font-mono);font-size:.72rem;color:var(--muted);padding:10px 0;text-align:center;">Nenhum material adicionado</div>
      </div>
    </div>
    <div class="os-modal-footer">
      <button class="btn-os-cancel" onclick="closeOsModal()">Cancelar</button>
      <button class="btn-os-save" onclick="saveOs()">💾 Salvar OS</button>
    </div>
  </div>
</div>

<!-- OS Detail Drawer -->
<div id="osDetailDrawer">
  <div class="drawer-backdrop" onclick="closeOsDetail()"></div>
  <div class="drawer-panel">
    <div class="drawer-top">
      <span class="drawer-title" style="color:#f59e0b">DETALHES DA OS</span>
      <button class="drawer-close" onclick="closeOsDetail()">✕</button>
    </div>
    <div class="drawer-body" id="osDetailBody"></div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════
     ESTOQUE SCREEN
══════════════════════════════════════════════════════ -->
<div id="estoqueScreen">
  <div class="est-header">
    <button class="btn-back" onclick="goTo('nav')">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
      Menu
    </button>
    <div style="font-family:var(--font-mono);font-size:.85rem;color:#06b6d4;letter-spacing:2px;">🏪 ESTOQUE</div>
    <div style="display:flex;gap:8px;margin-left:auto;flex-wrap:wrap;align-items:center">
      <div class="search-wrap" style="min-width:180px;">
        <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" id="estSearchInput" type="text" placeholder="Buscar produto..." oninput="renderEstoque()">
      </div>
      <button class="btn-est-new" onclick="openNfModal()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Entrada NF-e
      </button>
    </div>
  </div>
  <div class="est-body">
    <!-- Abas -->
    <div class="est-tabs">
      <button class="est-tab active" onclick="setEstTab('saldos',this)">📦 Saldos</button>
      <button class="est-tab" onclick="setEstTab('entradas',this)">📥 Entradas NF</button>
      <button class="est-tab" onclick="setEstTab('movimentos',this)">📋 Movimentos</button>
    </div>

    <!-- KPIs -->
    <div class="est-kpis" id="estKpis"></div>

    <!-- Aba Saldos -->
    <div id="estTabSaldos">
      <div class="est-table-wrap">
        <div class="est-table-hdr">
          <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--muted);">Saldo por Produto · <span id="estSaldoCount" style="color:#06b6d4;font-weight:700;">0</span></span>
        </div>
        <div style="overflow-x:auto">
          <table class="est-table">
            <thead><tr><th>Código</th><th>Descrição</th><th>Unidade</th><th>Saldo Atual</th><th>Mín. Seg.</th><th>Última Entrada</th><th>Ações</th></tr></thead>
            <tbody id="estSaldoBody"></tbody>
          </table>
        </div>
        <div id="estSaldoEmpty" style="text-align:center;padding:50px;color:var(--muted);display:none;">
          <div style="font-size:2rem;margin-bottom:12px;">📦</div>
          <div style="font-family:var(--font-mono);font-size:.85rem;">Nenhum produto em estoque</div>
          <div style="font-size:.78rem;margin-top:6px;">Registre uma entrada de NF para começar</div>
        </div>
      </div>
    </div>

    <!-- Aba Entradas -->
    <div id="estTabEntradas" style="display:none">
      <div class="est-table-wrap">
        <div class="est-table-hdr">
          <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--muted);">Notas Fiscais Registradas · <span id="estNfCount" style="color:#06b6d4;font-weight:700;">0</span></span>
        </div>
        <div style="overflow-x:auto">
          <table class="est-table">
            <thead><tr><th>N° NF</th><th>Série</th><th>Fornecedor</th><th>CNPJ</th><th>Valor Total</th><th>Data Emissão</th><th>Itens</th><th>Status</th></tr></thead>
            <tbody id="estNfBody"></tbody>
          </table>
        </div>
        <div id="estNfEmpty" style="text-align:center;padding:50px;color:var(--muted);display:none;">
          <div style="font-size:2rem;margin-bottom:12px;">📥</div>
          <div style="font-family:var(--font-mono);font-size:.85rem;">Nenhuma nota fiscal registrada</div>
        </div>
      </div>
    </div>

    <!-- Aba Movimentos -->
    <div id="estTabMovimentos" style="display:none">
      <div class="est-table-wrap">
        <div class="est-table-hdr">
          <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--muted);">Movimentos · <span id="estMovCount" style="color:#06b6d4;font-weight:700;">0</span></span>
        </div>
        <div style="overflow-x:auto">
          <table class="est-table">
            <thead><tr><th>Data/Hora</th><th>Tipo</th><th>Produto</th><th>Qtd</th><th>Referência</th><th>Usuário</th></tr></thead>
            <tbody id="estMovBody"></tbody>
          </table>
        </div>
        <div id="estMovEmpty" style="text-align:center;padding:50px;color:var(--muted);display:none;">
          <div style="font-size:2rem;margin-bottom:12px;">📋</div>
          <div style="font-family:var(--font-mono);font-size:.85rem;">Nenhum movimento registrado</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NF Modal -->
<div id="nfModal">
  <div class="nf-modal-card">
    <div class="nf-modal-hdr">
      <span class="nf-modal-title">📥 NOVA ENTRADA DE NF-e</span>
      <button onclick="closeNfModal()" style="background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.25);color:var(--warn);width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;">✕</button>
    </div>
    <div class="nf-modal-body">
      <!-- Scanner/Câmera area -->
      <div style="margin-bottom:16px;">
        <div style="font-family:var(--font-mono);font-size:.7rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Leitura de Código de Barras / QR Code NF-e</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-nf-scan" onclick="openNfScanner()">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            Usar câmera
          </button>
          <button class="btn-nf-scan" onclick="document.getElementById('nfChaveInput').focus()">
            ⌨️ Digitar chave
          </button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;">
          <input class="os-input" id="nfChaveInput" type="text" placeholder="Chave de acesso NF-e (44 dígitos)" maxlength="44" style="flex:1;font-family:var(--font-mono);font-size:.78rem;" oninput="this.value=this.value.replace(/\D/g,'')">
          <button onclick="consultarNfe()" style="background:#06b6d4;color:#0d0f14;border:none;border-radius:8px;padding:9px 16px;font-family:var(--font-mono);font-size:.8rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s" id="btnConsultarNfe">Consultar</button>
        </div>
        <div id="nfConsultaStatus" style="margin-top:8px;font-family:var(--font-mono);font-size:.72rem;color:var(--muted);"></div>
      </div>

      <!-- Dados NF retornados -->
      <div class="nf-data-card" id="nfDataCard">
        <div style="font-family:var(--font-mono);font-size:.7rem;color:#06b6d4;letter-spacing:1px;margin-bottom:10px;">✅ DADOS DA NOTA FISCAL</div>
        <div class="nf-data-row"><span class="nf-data-lbl">N° / Série</span><span class="nf-data-val" id="nfNumero">—</span></div>
        <div class="nf-data-row"><span class="nf-data-lbl">Emitente</span><span class="nf-data-val" id="nfEmitente">—</span></div>
        <div class="nf-data-row"><span class="nf-data-lbl">CNPJ Emitente</span><span class="nf-data-val" id="nfCnpj">—</span></div>
        <div class="nf-data-row"><span class="nf-data-lbl">Data Emissão</span><span class="nf-data-val" id="nfData">—</span></div>
        <div class="nf-data-row"><span class="nf-data-lbl">Valor Total</span><span class="nf-data-val" id="nfValor">—</span></div>
        <div class="nf-data-row"><span class="nf-data-lbl">Chave de Acesso</span><span class="nf-data-val" id="nfChaveDisplay" style="font-size:.65rem;word-break:break-all;max-width:none;text-align:right;">—</span></div>
      </div>

      <!-- Itens da NF -->
      <div class="nf-itens-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <span style="font-family:var(--font-mono);font-size:.72rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;">📦 Itens da Nota Fiscal</span>
          <button class="btn-os-add-mat" onclick="addNfItem()">+ Adicionar item</button>
        </div>
        <div>
          <div class="nf-item-row nf-item-hdr" style="grid-template-columns:1fr 70px 60px 80px 36px"><span>Descrição</span><span>Qtd</span><span>Und</span><span>R$ Unit.</span><span></span></div>
          <div id="nfItemsList"></div>
        </div>
        <div id="nfItemsEmpty" style="font-family:var(--font-mono);font-size:.72rem;color:var(--muted);text-align:center;padding:12px;">Adicione os itens da nota fiscal</div>
      </div>

      <!-- Dados manuais -->
      <div style="margin-top:4px;">
        <div class="os-form-grid">
          <div class="os-field">
            <label>N° da Nota Fiscal</label>
            <input class="os-input" id="nfNumeroManual" type="text" placeholder="Ex: 123456">
          </div>
          <div class="os-field">
            <label>Série</label>
            <input class="os-input" id="nfSerie" type="text" placeholder="Ex: 001" maxlength="3">
          </div>
          <div class="os-field">
            <label>Fornecedor</label>
            <input class="os-input" id="nfFornecedor" type="text" placeholder="Nome do fornecedor">
          </div>
          <div class="os-field">
            <label>Data de Emissão</label>
            <input class="os-input" id="nfDataEmissao" type="date">
          </div>
        </div>
        <div class="os-field" style="margin-top:12px;">
          <label>Observações</label>
          <textarea class="os-textarea" id="nfObs" rows="2" placeholder="Observações da entrada..."></textarea>
        </div>
      </div>
    </div>
    <div class="nf-modal-footer">
      <button class="btn-os-cancel" onclick="closeNfModal()">Cancelar</button>
      <button class="btn-nf-save" onclick="saveNfEntrada()">✅ Registrar Entrada</button>
    </div>
  </div>
</div>

<!-- NF Scanner Modal -->
<div id="nfScannerModal">
  <div class="scanner-card">
    <div class="scanner-header">
      <span class="scanner-title">📷 LEITOR NF-e</span>
      <button class="scanner-close" onclick="closeNfScanner()">✕</button>
    </div>
    <div class="scanner-video-wrap">
      <video id="nfScannerVideo" playsinline autoplay muted></video>
      <div class="scanner-crosshair"><div class="scanner-line"></div></div>
    </div>
    <div class="scanner-status" id="nfScannerStatus">Aponte para o QR Code ou código de barras da NF-e</div>
    <div class="scanner-result" id="nfScannerResultBox" style="display:none">
      <div class="scanner-result-lbl">CHAVE DETECTADA</div>
      <div class="scanner-result-val" id="nfScannerResultVal"></div>
    </div>
    <div class="scanner-actions">
      <button class="btn-scan-use" id="btnNfScanUse" disabled onclick="useNfScan()">✅ Usar chave</button>
      <button class="btn-scan-retry" onclick="restartNfScanner()">↺ Novo scan</button>
    </div>
  </div>
  <div class="nfscan-manual">
    <div class="nfscan-manual-title">OU INSIRA A CHAVE MANUALMENTE</div>
    <div class="nfscan-input-wrap">
      <input class="nfscan-inp" id="nfScanManualKey" type="text" placeholder="44 dígitos..." maxlength="44" oninput="this.value=this.value.replace(/\D/g,'')">
      <button class="btn-nfscan-go" onclick="useNfManualKey()">Usar</button>
    </div>
  </div>
  <button class="btn-nfscan-close" onclick="closeNfScanner()">✕ Fechar câmera</button>
</div>

<div class="loading-overlay" id="loadOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadText">Conectando...</div>
</div>

<div id="toast"></div>

<script>
// ── AUTH ──────────────────────────────────────────────────────────────────────
const SESSION_KEY = 'invctr_session';
const USERS_SHEET_NAME = 'Usuários';
const DEFAULT_ADMIN = { user: 'ericson', name: 'Ericson Cardoso', hash: btoa('123456'), admin: true };

// In-memory users cache loaded from Sheets
let usersCache = null;

function getSession() { try { return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); } catch { return null; } }
function saveSession(s) { localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }

function authErr(msg) {
  const el = document.getElementById('authErr');
  el.textContent = msg; el.classList.toggle('show', !!msg);
}
function adminErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.classList.toggle('show', !!msg);
}

// ── USERS SHEET HELPERS ───────────────────────────────────────────────────────
// Sheet columns: usuario | nome | hash | admin
async function loadUsersFromSheet() {
  try {
    const token = await getToken();
    const metaRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}`,
      { headers: { Authorization: `Bearer ${token}` } });
    const meta = await metaRes.json();

    // Check if Usuários tab exists
    const userSheet = meta.sheets?.find(s => s.properties.title === USERS_SHEET_NAME);

    if (!userSheet) {
      // Create the tab with header + default admin
      await createUsersSheet(token);
      usersCache = buildDefaultUsers();
      return usersCache;
    }

    const res = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(USERS_SHEET_NAME)}!A1:D200`,
      { headers: { Authorization: `Bearer ${token}` } });
    const json = await res.json();
    const rows = json.values || [];

    if (rows.length < 2) {
      // Empty sheet — seed default admin
      await writeUsersToSheet(token, buildDefaultUsers());
      usersCache = buildDefaultUsers();
      return usersCache;
    }

    // Parse rows (skip header row 0)
    const users = {};
    rows.slice(1).forEach(r => {
      if (!r[0]) return;
      users[r[0]] = { name: r[1] || '', hash: r[2] || '', admin: r[3] === 'true' };
    });

    // Ensure default admin always exists
    if (!users[DEFAULT_ADMIN.user]) {
      users[DEFAULT_ADMIN.user] = { name: DEFAULT_ADMIN.name, hash: DEFAULT_ADMIN.hash, admin: true };
      await writeUsersToSheet(token, users);
    }

    usersCache = users;
    return users;
  } catch(e) {
    console.error('Erro ao carregar usuários:', e);
    // Fallback to default admin only
    usersCache = buildDefaultUsers();
    return usersCache;
  }
}

function buildDefaultUsers() {
  return { [DEFAULT_ADMIN.user]: { name: DEFAULT_ADMIN.name, hash: DEFAULT_ADMIN.hash, admin: true } };
}

async function createUsersSheet(token) {
  // Add new sheet tab
  await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}:batchUpdate`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ requests: [{ addSheet: { properties: { title: USERS_SHEET_NAME } } }] })
  });
  // Write header + default admin
  await writeUsersToSheet(token, buildDefaultUsers());
}

async function writeUsersToSheet(token, users) {
  const rows = [['usuario','nome','hash','admin']];
  Object.entries(users).forEach(([k, u]) => {
    rows.push([k, u.name, u.hash, String(u.admin)]);
  });
  await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(USERS_SHEET_NAME)}!A1:D${rows.length}?valueInputOption=RAW`,
    {
      method: 'PUT',
      headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ range: `${USERS_SHEET_NAME}!A1:D${rows.length}`, majorDimension: 'ROWS', values: rows })
    }
  );
  usersCache = users;
}

async function saveUsersToSheet(users) {
  try {
    const token = await getToken();
    await writeUsersToSheet(token, users);
  } catch(e) {
    showToast('⚠️ Erro ao salvar usuários na planilha.', true);
    console.error(e);
  }
}

// ── LOGIN ─────────────────────────────────────────────────────────────────────
async function doLogin() {
  const user = document.getElementById('loginUser').value.trim().toLowerCase();
  const pass = document.getElementById('loginPass').value;
  if (!user || !pass) return authErr('Preencha usuário e senha.');

  authErr('');
  const btn = document.querySelector('.btn-auth');
  btn.textContent = 'Aguarde...'; btn.disabled = true;

  try {
    const users = await loadUsersFromSheet();
    if (!users[user]) return authErr('Usuário não encontrado.');
    if (users[user].hash !== btoa(pass)) return authErr('Senha incorreta.');
    saveSession({ user, name: users[user].name, admin: !!users[user].admin });
    showApp(users[user].name, !!users[user].admin);
  } catch(e) {
    authErr('Erro ao conectar. Tente novamente.');
  } finally {
    btn.textContent = 'ENTRAR →'; btn.disabled = false;
  }
}

function showApp(name, isAdmin) {
  document.getElementById('authOverlay').classList.add('hidden');
  document.getElementById('headerUser').textContent = name;
  document.getElementById('navUserName').textContent = name;
  document.getElementById('btnAdminPanel').style.display = isAdmin ? '' : 'none';
  const nw = document.getElementById('notifWrap');
  if (nw) nw.style.display = isAdmin ? '' : 'none';
  if (isAdmin) updateNotifBadge();
  goTo('nav');
  setTimeout(() => { syncSheet().then(() => updateNavSync()); }, 300);
}

function doLogout() {
  localStorage.removeItem(SESSION_KEY);
  usersCache = null;
  document.getElementById('navScreen').classList.remove('active');
  document.getElementById('inventoryScreen').style.display = 'none';
  document.getElementById('chartScreen').classList.remove('active');
  document.getElementById('authOverlay').classList.remove('hidden');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  authErr('');
}

// ── ADMIN PANEL ───────────────────────────────────────────────────────────────
async function openAdmin() {
  const s = getSession();
  if (!s || !s.admin) return showToast('❌ Acesso negado', true);
  document.getElementById('adminOverlay').style.display = 'flex';
  setLoad(true, 'Carregando usuários...');
  await loadUsersFromSheet();
  setLoad(false);
  renderAdminUsers();
  refreshChgSelect();
  adminErr('adminErr', '');
  adminErr('adminPassErr', '');
}

function closeAdmin() {
  document.getElementById('adminOverlay').style.display = 'none';
  ['regName','regUser','regPass','regPass2','chgPass','chgPass2'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '';
  });
}

function renderAdminUsers() {
  const users = usersCache || {};
  const session = getSession();
  const list = document.getElementById('adminUserList');
  const entries = Object.entries(users);
  if (!entries.length) { list.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;font-family:var(--font-mono);">Nenhum usuário.</div>'; return; }
  list.innerHTML = entries.map(([key, u]) => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:9px 13px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;">
      <div>
        <span style="font-weight:600;color:var(--text);font-size:0.86rem;">${u.name}</span>
        <span style="font-family:var(--font-mono);font-size:0.72rem;color:var(--muted);margin-left:9px;">@${key}</span>
        ${u.admin ? '<span style="font-family:var(--font-mono);font-size:0.68rem;color:var(--accent);margin-left:7px;background:rgba(0,229,160,0.1);padding:2px 7px;border-radius:10px;">ADMIN</span>' : ''}
      </div>
      ${key !== session?.user ? `<button onclick="deleteUser('${key}')" style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.2);color:var(--warn);padding:3px 9px;border-radius:5px;font-size:0.72rem;cursor:pointer;font-family:var(--font-mono);">Remover</button>` : '<span style="font-size:0.7rem;color:var(--muted);font-family:var(--font-mono);">(você)</span>'}
    </div>`).join('');
}

function refreshChgSelect() {
  const users = usersCache || {};
  const sel = document.getElementById('chgUser');
  sel.innerHTML = Object.entries(users).map(([k,u]) => `<option value="${k}">${u.name} (@${k})</option>`).join('');
}

async function deleteUser(key) {
  const session = getSession();
  if (key === session?.user) return showToast('❌ Não é possível remover a si mesmo.', true);
  const users = usersCache || {};
  const name = users[key]?.name || key;
  delete users[key];
  await saveUsersToSheet(users);
  showToast(`🗑 Usuário "${name}" removido.`);
  renderAdminUsers();
  refreshChgSelect();
}

async function doRegister() {
  const name = document.getElementById('regName').value.trim();
  const user = document.getElementById('regUser').value.trim().toLowerCase();
  const pass = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  const isAdmin = document.getElementById('regIsAdmin').checked;
  if (!name || !user || !pass) return adminErr('adminErr', 'Preencha todos os campos.');
  if (!/^[a-z0-9_]+$/.test(user)) return adminErr('adminErr', 'Usuário: apenas letras, números e _');
  if (pass.length < 6) return adminErr('adminErr', 'Senha mínima: 6 caracteres.');
  if (pass !== pass2) return adminErr('adminErr', 'As senhas não coincidem.');
  const users = usersCache || {};
  if (users[user]) return adminErr('adminErr', 'Usuário já cadastrado.');
  users[user] = { name, hash: btoa(pass), admin: isAdmin };
  await saveUsersToSheet(users);
  adminErr('adminErr', '');
  ['regName','regUser','regPass','regPass2'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('regIsAdmin').checked = false;
  showToast(`✅ Usuário "${name}" salvo na planilha!`);
  renderAdminUsers();
  refreshChgSelect();
}

async function doChangePass() {
  const user = document.getElementById('chgUser').value;
  const pass = document.getElementById('chgPass').value;
  const pass2 = document.getElementById('chgPass2').value;
  if (!user || !pass) return adminErr('adminPassErr', 'Selecione o usuário e informe a nova senha.');
  if (pass.length < 6) return adminErr('adminPassErr', 'Senha mínima: 6 caracteres.');
  if (pass !== pass2) return adminErr('adminPassErr', 'As senhas não coincidem.');
  const users = usersCache || {};
  if (!users[user]) return adminErr('adminPassErr', 'Usuário não encontrado.');
  users[user].hash = btoa(pass);
  await saveUsersToSheet(users);
  adminErr('adminPassErr', '');
  document.getElementById('chgPass').value = '';
  document.getElementById('chgPass2').value = '';
  showToast(`✅ Senha de "${users[user].name}" alterada na planilha!`);
}

// Check existing session on load
(function checkSession() {
  const s = getSession();
  if (s) { showApp(s.name, s.admin); }
})();

// ── LOCAL FILE LOADING ────────────────────────────────────────────────────────
function loadLocalFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = ''; // reset so same file can be re-loaded
  const ext = file.name.split('.').pop().toLowerCase();
  setLoad(true, `Carregando "${file.name}"...`);
  const reader = new FileReader();

  if (ext === 'csv') {
    reader.onload = e => {
      try {
        processRows(parseCSV(e.target.result), file.name);
      } catch(err) {
        showToast('❌ Erro ao ler CSV: ' + err.message, true);
      } finally { setLoad(false); }
    };
    reader.readAsText(file, 'UTF-8');
  } else if (ext === 'xlsx' || ext === 'xls') {
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        processRows(rows.map(r => r.map(c => String(c ?? ''))), file.name);
      } catch(err) {
        showToast('❌ Erro ao ler Excel: ' + err.message, true);
      } finally { setLoad(false); }
    };
    reader.readAsArrayBuffer(file);
  } else {
    setLoad(false);
    showToast('❌ Formato não suportado. Use CSV ou Excel.', true);
  }
}

function processRows(rows, filename) {
  if (!rows || rows.length < 2) throw new Error('Arquivo vazio ou sem dados.');
  headers = rows[0].map(h => String(h).trim()).filter(Boolean);
  const qIdx = headers.findIndex(h => /qtd|quant|quantidade|qty|estoque|stock/i.test(h));
  const qCol = qIdx >= 0 ? headers[qIdx] : null;
  const mColIdx = headers.findIndex(h => h.trim().toLowerCase() === 'moderado');
  const mColName = mColIdx >= 0 ? headers[mColIdx] : null;
  data = rows.slice(1)
    .filter(r => r.some(c => c && String(c).trim()))
    .map(row => {
      const obj = { _id: nextId++, _locked: false, _qCol: qCol };
      headers.forEach((h, i) => { obj[h] = row[i] !== undefined ? String(row[i]) : ''; });
      // Auto-lock if Moderado === 'SIM'
      if (mColName && String(obj[mColName] || '').trim().toUpperCase() === 'SIM') {
        obj._locked = true;
      }
      return obj;
    });
  document.getElementById('colInfoText').textContent = headers.join(' · ');
  // colInfo hidden
  setSyncState('ok', `Arquivo local · ${data.length} itens`);
  document.getElementById('lastSync').textContent = `"${filename}" · ${new Date().toLocaleTimeString('pt-BR')}`;
  showToast(`✅ ${data.length} itens carregados de "${filename}"`);
  render();
}

// ── CONFIG ────────────────────────────────────────────────────────────────────
const SHEET_ID = '1Wh50lTf9TFOz0-RyjS1g28A47_VsuP5MJXkGma67-zI';

const SA = {
  email: 'inventario@invetario2.iam.gserviceaccount.com',
  key: `MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCuE+JyaPridKbP
O0mFVX5xwakOzj46wEMhT0IxhdDT4CekI2EnjuUeiAoR+DmB5oWA9AHmiyy1RM6Q
Owm+BxFZR4BVPVAQk2zEi20hUvlwnlIZN85DnvDpdupn+yrQoFyxSVOXWqUnZcf7
i1A1UU0LfrEAtLd4EfE5SvTxoDMQ4egHDps3PqCU9nZD3fkUtt+Z/CBqihon9Voa
02+rlZfVrEhnlvJoetCPQvtYUfmdIpsCht6yJTeIa0hoheGLQvQDdIi1gO6FLb67
OGL1JvLOagVz0ZPjRlMF8hcvaWZrnwSRwvT+mQLj9+5kkDD1B4k/DHlF1997X21S
A5cJylZZAgMBAAECggEAHO1w/qeItC5uX0Ga621USyhuJOe2Wk0DhXrbpR8iShNA
gyYzSZTqvjLHzvSmRHqU9OOXl+1zddaup4koCqFiC1QLyh5w5PrwDY6d3qEgknZn
bjQNMsTW2Up0PuieKiJ773of9KbmNbB+6xjbhgCyAkGraFKfqnRQ1xR9tSl0qE6b
60X2dQIYHmqJMeMW5H7fmVOTYJ+RmRF7QzCmGXRUzLNVs22CWQaL6N7OkqizjJr/
HgF7jfm1JnnORlbrmD0h6Amuexx9YQ2+MLN13ntCmI14cf5DxDVlV1jMmY9X7a+w
YR9pme+e1vVXtvStbdwaRB0mrHRPv2bFhtMFkj5pgQKBgQDa3q+9UzggvHn/QmMC
Si6sb0dliGI5AVN/C2Qec5BmG2Zd0kYq+GQl/JmwU1y6gT1Tu2i611iq9aUfKy04
5X46hJzG3SmihjH24VCeN7BYAl2J2xISeggFSK2QLEylBOrb9tpnjINW/l+eG+Kr
hEJmV8U1idPOkxo+o5IsLNSGpwKBgQDLm+o8CM7HSwJt0AwvBzMaxzcQaRtqec3C
AJy7iyT0Bc3CDlhKax2SI9Xfy76w8W4nmVg2C7GlpHmzZBaLdOu54BstTCxY11tU
DGO6Sfk2ScpkCkxoh740XcgR/TCnZQUw/FLc1Yjtr3ae+egXDsJwH+U5erEphHMz
oJO6OOLa/wKBgBjggMcbI2ENKyypRgmnluCAkXPn6YojLXNePxX6+qmwaZU2ZkVS
EEgFCw7wmrSUJf1Tatb5zRk5bHg7dxtlclCCbDNqReY0LI+sEna5S7DlK+6UWNyC
xFCdbyTY9Ck5gtxXlYF5hiAoL4QQFVZ7ZPSu+zpXnRx4ud3ux5l/yvQ3AoGBAK0U
8k5sclLqCbuN0v2bUi8eUEnL/7lIp8eWO6YVx6kE0f93sEg6vF2BxwrCqWzDH4/c
BCeVU0NrCOWdXKjaEJTm1FNyYHR5RbKyAYjX31jt63WVZ5SoZ+EeI7hfEiAKeRpG
NK5zez4KHX1RFaGcM1+bTYHKMZYIeOHXTB1OxFHDAoGAEGwrlF2gYH6fwGFrjhjK
RwO5/YQEyCNvHn3KjwOcFW7e5CTnMh4baOtR2wLQWuvJYnPh0NblrQBdyX+IFk7c
JkwVQ9B2+GtSripk8pREQgJm3Zt8OwwJP0MkEM+Xm1hf3f1AlIICGxpmALsN+QoP
Uvx2ldx0l6Pznan3XUum4TI=`
};

// ── STATE ─────────────────────────────────────────────────────────────────────
let data = [], headers = [], nextId = 1, filterState = 'all';
let cachedToken = null, tokenExpiry = 0;
let pendingChanges = new Set(); // tracks row indices (1-based in sheet) with changes
let sheetRowMap = []; // maps data._id to sheet row index (1-based, excluding header)

// ── JWT AUTH ──────────────────────────────────────────────────────────────────
function b64u(str) { return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,''); }
function b64uBuf(buf) {
  let s = ''; new Uint8Array(buf).forEach(b => s += String.fromCharCode(b));
  return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

async function getToken() {
  if (cachedToken && Date.now() < tokenExpiry - 60000) return cachedToken;
  const now = Math.floor(Date.now() / 1000);
  const hdr = b64u(JSON.stringify({alg:'RS256',typ:'JWT'}));
  const pay = b64u(JSON.stringify({
    iss: SA.email,
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    aud: 'https://oauth2.googleapis.com/token',
    exp: now + 3600, iat: now
  }));
  const msg = `${hdr}.${pay}`;

  // Strip PEM headers/footers and all whitespace to get clean base64 DER
  const pemClean = SA.key
    .replace(/-----BEGIN PRIVATE KEY-----/, '')
    .replace(/-----END PRIVATE KEY-----/, '')
    .replace(/\s+/g, '');
  const der = Uint8Array.from(atob(pemClean), c => c.charCodeAt(0));
  const ck = await crypto.subtle.importKey('pkcs8', der.buffer,
    {name:'RSASSA-PKCS1-v1_5',hash:'SHA-256'}, false, ['sign']);
  const sig = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', ck, new TextEncoder().encode(msg));
  const jwt = `${msg}.${b64uBuf(sig)}`;

  const res = await fetch('https://oauth2.googleapis.com/token', {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
  });
  if (!res.ok) {
    const errText = await res.text();
    throw new Error(`Falha auth (${res.status}): ${errText}`);
  }
  const j = await res.json();
  cachedToken = j.access_token;
  tokenExpiry = Date.now() + j.expires_in * 1000;
  return cachedToken;
}


// ── CSV PARSER ────────────────────────────────────────────────────────────────
function parseCSV(text) {
  const rows = [];
  let row = [], cell = '', inQuote = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (inQuote) {
      if (c === '"' && text[i+1] === '"') { cell += '"'; i++; }
      else if (c === '"') { inQuote = false; }
      else { cell += c; }
    } else {
      if (c === '"') { inQuote = true; }
      else if (c === ',') { row.push(cell.trim()); cell = ''; }
      else if (c === '\n') { row.push(cell.trim()); rows.push(row); row = []; cell = ''; }
      else if (c === '\r') { /* skip */ }
      else { cell += c; }
    }
  }
  if (cell || row.length) { row.push(cell.trim()); rows.push(row); }
  return rows.filter(r => r.length > 0);
}

// ── SYNC ──────────────────────────────────────────────────────────────────────
async function syncSheet() {
  const btn = document.getElementById('btnSync');
  btn.disabled = true;
  setSyncState('loading', 'Conectando...');
  setLoad(true, 'Autenticando com Google...');
  try {
    setLoad(true, 'Autenticando...');
    const token = await getToken();

    // Get sheet metadata to find actual sheet name
    setLoad(true, 'Lendo estrutura da planilha...');
    const metaRes = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}`,
      { headers:{ Authorization:`Bearer ${token}` } }
    );
    if (!metaRes.ok) {
      let errBody = '';
      try { const e = await metaRes.json(); errBody = JSON.stringify(e.error || e); } catch(_) { errBody = metaRes.status; }
      throw new Error(`Erro ao acessar planilha (${metaRes.status}): ${errBody}`);
    }
    const meta = await metaRes.json();
    const sheetName = meta.sheets?.[0]?.properties?.title || 'Sheet1';
    setLoad(true, `Carregando aba "${sheetName}"...`);

    const res = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}!A1:ZZ5000`,
      { headers:{ Authorization:`Bearer ${token}` } }
    );
    if (!res.ok) {
      const e = await res.json();
      throw new Error(`Erro API (${res.status}): ${e.error?.message || 'desconhecido'}`);
    }
    const json = await res.json();
    const rows = json.values || [];
    if (rows.length < 2) throw new Error(`Aba "${sheetName}" está vazia ou tem apenas cabeçalho`);

    headers = rows[0].map(h => String(h).trim());

    // Detect qty column
    const qIdx = headers.findIndex(h => /qtd|quant|quantidade|qty|estoque|stock/i.test(h));
    const qCol = qIdx >= 0 ? headers[qIdx] : null;

    const mColIdx = headers.findIndex(h => h.trim().toLowerCase() === 'moderado');
    const mColName = mColIdx >= 0 ? headers[mColIdx] : null;
    data = rows.slice(1)
      .filter(r => r.some(c => c && String(c).trim()))
      .map((row, idx) => {
        const obj = { _id: nextId++, _locked: false, _qCol: qCol, _sheetRow: idx + 2 };
        headers.forEach((h, i) => { obj[h] = row[i] !== undefined ? String(row[i]) : ''; });
        // Auto-lock if Moderado === 'SIM'
        if (mColName && String(obj[mColName] || '').trim().toUpperCase() === 'SIM') {
          obj._locked = true;
        }
        return obj;
      });

    pendingChanges = new Set();
    updatePublishBtn();

    document.getElementById('colInfoText').textContent = headers.join(' · ');
    // colInfo hidden
    setSyncState('ok', `Sincronizado · ${data.length} itens`);
    document.getElementById('lastSync').textContent =
      'Última sync: ' + new Date().toLocaleTimeString('pt-BR');
    showToast(`✅ ${data.length} itens carregados`);
    render();
    updateNavSync();
  } catch(e) {
    setSyncState('error', 'Erro na sync');
    showToast('❌ ' + e.message, true);
    console.error('Full error:', e);
    updateNavSync();
  } finally {
    setLoad(false);
    btn.disabled = false;
  }
}

function setSyncState(s, lbl) {
  const d = document.getElementById('syncDot');
  d.className = 'dot' + (s==='ok'?' green':s==='loading'?' yellow':s==='error'?' red':'');
  document.getElementById('syncLabel').textContent = lbl;
}
function setLoad(show, txt='') {
  document.getElementById('loadOverlay').classList.toggle('show', show);
  if (txt) document.getElementById('loadText').textContent = txt;
}

// ── PUBLISH CHANGES ───────────────────────────────────────────────────────────
async function publishChanges() {
  if (!pendingChanges.size) return showToast('⚠️ Nenhuma alteração pendente.', true);

  const btn = document.getElementById('btnPublish');
  btn.disabled = true;
  setLoad(true, 'Publicando alterações...');

  try {
    const token = await getToken();

    // Get sheet name
    const metaRes = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}`,
      { headers: { Authorization: `Bearer ${token}` } }
    );
    if (!metaRes.ok) throw new Error('Erro ao acessar planilha');
    const meta = await metaRes.json();
    const sheetName = meta.sheets?.[0]?.properties?.title || 'Sheet1';

    // Build batch update data
    const valueRanges = [];
    for (const id of pendingChanges) {
      const row = data.find(r => r._id === id);
      if (!row || !row._sheetRow) continue;
      const rowValues = headers.map(h => row[h] || '');
      const range = `${sheetName}!A${row._sheetRow}:${colLetter(headers.length)}${row._sheetRow}`;
      valueRanges.push({ range, values: [rowValues] });
    }

    const res = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchUpdate`,
      {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          valueInputOption: 'USER_ENTERED',
          data: valueRanges
        })
      }
    );

    if (!res.ok) {
      const e = await res.json();
      throw new Error(`Erro ao publicar (${res.status}): ${e.error?.message || 'desconhecido'}`);
    }

    const count = pendingChanges.size;
    pendingChanges.clear();
    updatePublishBtn();
    const _ses = getSession();
    notifyAdminPublish(count, _ses ? _ses.name : 'Usuário');
    showToast(`✅ ${count} linha(s) publicada(s) na planilha!`);
  } catch(e) {
    showToast('❌ ' + e.message, true);
    console.error(e);
  } finally {
    setLoad(false);
    btn.disabled = false;
  }
}

function colLetter(n) {
  let s = '';
  while (n > 0) { s = String.fromCharCode(64 + (n % 26 || 26)) + s; n = Math.floor((n - 1) / 26); }
  return s;
}

// ── RENDER ────────────────────────────────────────────────────────────────────
function qty(row) {
  if (!row._qCol) return null;
  const v = parseFloat(row[row._qCol]);
  return isNaN(v) ? null : v;
}
function status(row) {
  const q = qty(row);
  if (q === null) return 'ok';
  if (q <= 0) return 'out';
  if (q <= 10) return 'low';
  return 'ok';
}
function badge(row) {
  if (row._locked) return `<span class="badge badge-locked">🔒 Consolidado</span>`;
  const s = status(row);
  if (s==='out') return `<span class="badge badge-out">● Sem estoque</span>`;
  if (s==='low') return `<span class="badge badge-low">● Baixo estoque</span>`;
  return `<span class="badge badge-ok">● ATIVO</span>`;
}

function setFilter(f, el) {
  filterState = f;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  render();
}



// ── ITEM DRAWER ───────────────────────────────────────────────────────────────
// Columns editable via dropdown
const DRAWER_DROPDOWN_COLS = ['equipamento','modelo','fabricante','setor','situação','situacao'];
// Columns that are dates
function isDateCol(h) {
  return /data|date|vencimento|validade|prazo|instalação|instalacao|aquisição|aquisicao/i.test(h);
}
// Columns editable freely (dropdown + date + textarea)
const DRAWER_EDIT_COLS = ['equipamento','modelo','fabricante','setor','situação','situacao'];

function isDrawerDropdown(h) {
  return DRAWER_DROPDOWN_COLS.includes(h.trim().toLowerCase());
}
function isDrawerEdit(h) {
  return DRAWER_EDIT_COLS.includes(h.trim().toLowerCase()) || isDateCol(h);
}

function openDrawer(id) {
  const row = data.find(r => r._id === id);
  if (!row) return;

  document.getElementById('drawerBadge').innerHTML = badge(row);
  document.getElementById('drawerFields').innerHTML = headers.map(h => buildDrawerField(row, h)).join('');

  const acts = document.getElementById('drawerActions');
  acts.innerHTML = '';

  // Save changes button (always shown when not locked)
  if (!row._locked) {
    acts.innerHTML += `<button class="btn-drawer-save-all" onclick="saveDrawerChanges(${id})">✅ Salvar alterações</button>`;
  }
  if (row._locked) {
    acts.innerHTML += `<button class="drawer-btn drawer-btn-unlock" onclick="unlock(${id});openDrawer(${id})">🔓 Desconsolidar</button>`;
  } else {
    acts.innerHTML += `<button class="drawer-btn drawer-btn-cons" onclick="lock(${id});openDrawer(${id})">🔒 Consolidar</button>`;
  }
  if (row._sheetRow && !row._locked) {
    acts.innerHTML += `<button class="drawer-btn drawer-btn-save" onclick="saveRow(${id})">💾 Salvar na planilha</button>`;
  }

  document.getElementById('itemDrawer').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function buildDrawerField(row, h) {
  const val = row[h] || '';
  const locked = row._locked;
  const isEdit = isDrawerEdit(h) || true; // all fields editable
  const isDD = isDrawerDropdown(h);
  const isDate = isDateCol(h);

  if (locked) {
    // Read-only when locked
    return `<div class="drawer-field readonly">
      <div class="drawer-field-label-row">
        <div class="drawer-field-label">${esc(h)}</div>
      </div>
      <div class="drawer-field-value${!val ? ' empty' : ''}">${val ? esc(val) : 'Não informado'}</div>
    </div>`;
  }

  if (isDate) {
    // Format value to YYYY-MM-DD for date input if possible
    let dateVal = '';
    if (val) {
      // Try DD/MM/YYYY → YYYY-MM-DD
      const dmyMatch = val.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (dmyMatch) dateVal = `${dmyMatch[3]}-${dmyMatch[2].padStart(2,'0')}-${dmyMatch[1].padStart(2,'0')}`;
      else dateVal = val; // assume already ISO
    }
    return `<div class="drawer-field editable">
      <div class="drawer-field-label-row">
        <div class="drawer-field-label">${esc(h)}</div>
        <span class="drawer-date-tag">📅 DATA</span>
      </div>
      <input type="date" class="drawer-field-input"
        id="dfield_${row._id}_${escA(h)}"
        value="${dateVal}"
        onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">
    </div>`;
  }

  if (isDD) {
    const opts = getUniqueValues(h);
    return `<div class="drawer-field editable">
      <div class="drawer-field-label-row">
        <div class="drawer-field-label">${esc(h)}</div>
        <span class="drawer-edit-tag">EDITÁVEL</span>
      </div>
      <div class="drawer-dropdown-wrap">
        <input type="text" class="drawer-field-input has-dropdown"
          id="dfield_${row._id}_${escA(h)}"
          value="${esc(val)}" placeholder="Digite ou selecione..."
          onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">
        <button class="drawer-dropdown-btn" onclick="showDrawerDropdown(event,${row._id},'${escA(h)}')"
          title="Ver opções">
          <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
      </div>
    </div>`;
  }

  // Default: textarea for long text, input for short
  const isLong = val.length > 60;
  return `<div class="drawer-field editable">
    <div class="drawer-field-label-row">
      <div class="drawer-field-label">${esc(h)}</div>
      <span class="drawer-edit-tag">EDITÁVEL</span>
    </div>
    ${isLong
      ? `<textarea class="drawer-field-textarea"
          id="dfield_${row._id}_${escA(h)}"
          onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">${esc(val)}</textarea>`
      : `<input type="text" class="drawer-field-input"
          id="dfield_${row._id}_${escA(h)}"
          value="${esc(val)}" placeholder="Não informado"
          onchange="drawerFieldChange(${row._id},'${escA(h)}',this.value)">`
    }
  </div>`;
}

// Track drawer changes separately before committing
let drawerChanges = {};

function drawerFieldChange(id, col, val) {
  if (!drawerChanges[id]) drawerChanges[id] = {};
  drawerChanges[id][col] = val;
}

function saveDrawerChanges(id) {
  const row = data.find(r => r._id === id);
  if (!row) return;
  const changes = drawerChanges[id] || {};
  let changed = false;

  for (const [col, val] of Object.entries(changes)) {
    const h = headers.find(hh => escA(hh) === col) || col;
    // Convert date back to DD/MM/YYYY for consistency
    let finalVal = val;
    if (isDateCol(h) && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
      const [y,m,d] = val.split('-');
      finalVal = `${d}/${m}/${y}`;
    }
    row[h] = finalVal;
    changed = true;
  }

  if (changed) {
    if (row._sheetRow) pendingChanges.add(id);
    updatePublishBtn();
    drawerChanges[id] = {};
    render();
    // Refresh badge in drawer
    document.getElementById('drawerBadge').innerHTML = badge(row);
    showToast('✅ Alterações aplicadas! Clique em Salvar na planilha para publicar.');
  } else {
    showToast('⚠️ Nenhuma alteração detectada.', true);
  }
}

function showDrawerDropdown(e, id, col) {
  e.stopPropagation();
  closeDropdown();
  const h = headers.find(hh => escA(hh) === col) || col;
  const values = getUniqueValues(h);
  const btn = e.currentTarget;
  const wrap = btn.closest('.drawer-dropdown-wrap');

  const dl = document.createElement('div');
  dl.className = 'dropdown-list';
  dl.style.cssText = 'position:absolute;top:100%;left:0;right:0;z-index:900;margin-top:3px;';
  dl.innerHTML = `
    <div class="dropdown-header">Valores cadastrados</div>
    <div class="dropdown-list-inner">
      ${values.length
        ? values.map(v => `<div class="dropdown-item" onclick="pickDrawerDropdown(${id},'${col}',this)">${esc(v)}</div>`).join('')
        : `<div class="dropdown-empty">Nenhum valor encontrado</div>`}
    </div>`;

  wrap.style.position = 'relative';
  wrap.appendChild(dl);
  activeDropdown = dl;
  setTimeout(() => document.addEventListener('click', closeDropdown, { once: true }), 10);
}

function pickDrawerDropdown(id, col, el) {
  const val = el.textContent.trim();
  const inputEl = document.getElementById(`dfield_${id}_${col}`);
  if (inputEl) inputEl.value = val;
  drawerFieldChange(id, col, val);
  closeDropdown();
}


function closeDrawer() {
  document.getElementById('itemDrawer').classList.remove('open');
  document.body.style.overflow = '';
}

// ── DROPDOWN COLUMNS ──────────────────────────────────────────────────────────
const DROPDOWN_COLS = ['equipamento','modelo','fabricante','situação','situacao'];

function isDropdownCol(h) {
  return DROPDOWN_COLS.includes(h.trim().toLowerCase());
}

function getUniqueValues(col) {
  const vals = data
    .map(r => String(r[col] || '').trim())
    .filter(v => v.length > 0);
  return [...new Set(vals)].sort((a, b) => a.localeCompare(b, 'pt-BR'));
}

function renderCell(row, h) {
  const minW = h.length > 10 ? 130 : 85;
  const val = esc(row[h] || '');
  const disabled = row._locked ? 'disabled' : '';
  const id = row._id;
  const hEsc = escA(h);

  if (!row._locked && isDropdownCol(h)) {
    return `<div class="cell-wrap">
      <input class="cell-input" style="min-width:${minW}px"
        id="ci_${id}_${escA(h)}"
        value="${val}"
        onchange="upd(${id},'${hEsc}',this.value)">
      <button class="btn-dropdown" onclick="showDropdown(event,${id},'${hEsc}')" title="Ver opções">
        <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
    </div>`;
  }

  return `<input class="cell-input" style="min-width:${minW}px"
    value="${val}" ${disabled}
    onchange="upd(${id},'${hEsc}',this.value)">`;
}

let activeDropdown = null;

function showDropdown(e, id, col) {
  e.stopPropagation();
  closeDropdown();

  // Find the actual header key (un-escaped)
  const h = headers.find(hh => escA(hh) === col) || col;
  const values = getUniqueValues(h);
  const btn = e.currentTarget;
  const wrap = btn.closest('.cell-wrap');

  const dl = document.createElement('div');
  dl.className = 'dropdown-list';
  dl.innerHTML = `
    <div class="dropdown-header">Valores cadastrados</div>
    <div class="dropdown-list-inner">
      ${values.length
        ? values.map(v => `<div class="dropdown-item" onclick="selectDropdown(${id},'${col}',this)">${esc(v)}</div>`).join('')
        : `<div class="dropdown-empty">Nenhum valor encontrado</div>`
      }
    </div>`;

  wrap.style.position = 'relative';
  wrap.appendChild(dl);
  activeDropdown = dl;

  // Close on outside click
  setTimeout(() => document.addEventListener('click', closeDropdown, { once: true }), 10);
}

function selectDropdown(id, col, el) {
  const val = el.textContent.trim();
  const h = headers.find(hh => escA(hh) === col) || col;
  const inputId = `ci_${id}_${col}`;
  const input = document.getElementById(inputId);
  if (input) { input.value = val; }
  upd(id, h, val);
  closeDropdown();
}

function closeDropdown() {
  if (activeDropdown) { activeDropdown.remove(); activeDropdown = null; }
}

function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q && filterState === 'all') {
    showToast('⚠️ Digite algo para buscar.', true);
    return;
  }
  render();
}

function render() {
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const emptyState   = document.getElementById('emptyState');
  const searchPrompt = document.getElementById('searchPrompt');

  updateStats();

  // No data loaded yet
  if (!data.length) {
    emptyState.style.display = '';
    searchPrompt.style.display = 'none';
    document.getElementById('tHead').innerHTML = '';
    document.getElementById('tBody').innerHTML = '';
    return;
  }

  // Data loaded but no search query — show prompt
  if (!q && filterState === 'all') {
    emptyState.style.display = 'none';
    searchPrompt.style.display = '';
    document.getElementById('searchPromptCount').textContent = data.length;
    document.getElementById('tHead').innerHTML = '';
    document.getElementById('tBody').innerHTML = '';
    return;
  }

  // Has query or active filter — show results
  const filtered = data.filter(row => {
    const ms = !q || headers.some(h => (row[h]||'').toLowerCase().includes(q));
    const mf = filterState==='all' || (filterState==='locked'&&row._locked) || (!row._locked&&filterState===status(row));
    return ms && mf;
  });

  searchPrompt.style.display = 'none';

  if (!filtered.length) {
    emptyState.style.display = '';
    document.getElementById('emptyTitle').textContent = 'Nenhum resultado';
    document.getElementById('emptyMsg').innerHTML = 'Tente outros termos ou filtros.';
    document.getElementById('tHead').innerHTML = '';
    document.getElementById('tBody').innerHTML = '';
    return;
  }

  emptyState.style.display = 'none';

  // Summary columns — only show these if present in headers
  const SUMMARY_COLS = ['equipamento','modelo','fabricante','situação','situacao','setor','moderado'];
  const visibleHeaders = headers.filter(h => SUMMARY_COLS.includes(h.trim().toLowerCase()));
  const displayHeaders = visibleHeaders.length > 0 ? visibleHeaders : headers.slice(0, 4);

  document.getElementById('tHead').innerHTML =
    `<th style="width:110px">Ações</th>` +
    `<th style="width:90px">Status</th>` +
    displayHeaders.map(h=>`<th>${esc(h)}</th>`).join('');

  document.getElementById('tBody').innerHTML = filtered.map((row,i)=>`
    <tr class="${row._locked?'locked-row':''}${pendingChanges.has(row._id)?' pending-row':''}">
      <td>
        <div class="action-btns">
          <button class="btn-view" onclick="openDrawer(${row._id})">👁</button>
          ${row._locked
            ?`<button class="btn-unlock" onclick="unlock(${row._id})">🔓</button>`
            :`<button class="btn-cons"   onclick="lock(${row._id})">🔒</button>`}
          ${row._sheetRow && !row._locked
            ?`<button class="btn-save-row" onclick="saveRow(${row._id})" title="Salvar">💾</button>`
            :''}
        </div>
      </td>
      <td>${badge(row)}</td>
      ${displayHeaders.map(h=>`
        <td>${renderCell(row, h)}</td>
      `).join('')}
    </tr>`).join('');
}

function updateStats() {
  document.getElementById('statTotal').textContent = data.length;
  document.getElementById('statLocked').textContent = data.filter(r=>r._locked).length;
  document.getElementById('statLow').textContent = data.filter(r=>!r._locked&&status(r)==='low').length;
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escA(s) { return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

function upd(id, col, val) {
  const r = data.find(r=>r._id===id);
  if (r && !r._locked) {
    r[col]=val;
    if (r._sheetRow) pendingChanges.add(r._id);
    updatePublishBtn();
    render();
  }
}

function updatePublishBtn() {
  const btn = document.getElementById('btnPublish');
  const count = pendingChanges.size;
  btn.style.display = count > 0 ? 'flex' : 'none';
  document.getElementById('pendingCount').textContent = count > 0 ? count : '';
}
function getModeradoCol() {
  return headers.find(h => h.trim().toLowerCase() === 'moderado') || null;
}

function lock(id) {
  const r = data.find(r=>r._id===id);
  if (!r) return;
  const itemName = r[headers[0]] || 'este item';
  openConfirm(
    'Tem certeza que deseja consolidar <strong>"' + esc(itemName) + '"</strong>?<br><br>' +
    'Após consolidado, somente um <strong>Administrador</strong> poderá desfazer esta ação.',
    '🔒', 'CONSOLIDAR ITEM', 'Sim, consolidar',
    function() {
      r._locked = true;
      const mCol = getModeradoCol();
      if (mCol) {
        r[mCol] = 'SIM';
        if (r._sheetRow) pendingChanges.add(r._id);
        updatePublishBtn();
      }
      showToast('✅ "' + itemName + '" consolidado');
      render();
      if (document.getElementById('itemDrawer').classList.contains('open')) openDrawer(id);
    }
  );
}
function unlock(id) {
  // Only admins can unlock
  const session = getSession();
  if (!session || !session.admin) {
    openAdminBlock();
    return;
  }
  const r = data.find(r=>r._id===id);
  if (!r) return;
  r._locked = false;
  // Clear SIM from Moderado column on unlock
  const mCol = getModeradoCol();
  if (mCol && r[mCol] === 'SIM') {
    r[mCol] = '';
    if (r._sheetRow) pendingChanges.add(r._id);
    updatePublishBtn();
  }
  showToast(`🔓 "${r[headers[0]]||'Item'}" desbloqueado`);
  render();
}

function openAdminBlock() {
  document.getElementById('adminBlockModal').classList.add('open');
}
function closeAdminBlock() {
  document.getElementById('adminBlockModal').classList.remove('open');
}
function addRow() {
  if (!headers.length) { showToast('⚠️ Sincronize primeiro', true); return; }
  const obj = { _id: nextId++, _locked: false, _qCol: data[0]?._qCol||null };
  headers.forEach(h => { obj[h]=''; });
  data.unshift(obj);
  setFilter('all', document.querySelector('.filter-tab'));
  render();
  showToast('➕ Novo item adicionado');
}

async function saveRow(id) {
  const row = data.find(r => r._id === id);
  if (!row || !row._sheetRow) return showToast('⚠️ Linha sem referência na planilha.', true);

  setLoad(true, 'Salvando linha...');
  try {
    const token = await getToken();
    const metaRes = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}`,
      { headers: { Authorization: `Bearer ${token}` } }
    );
    if (!metaRes.ok) throw new Error('Erro ao acessar planilha');
    const meta = await metaRes.json();
    const sheetName = meta.sheets?.[0]?.properties?.title || 'Sheet1';

    const rowValues = headers.map(h => row[h] || '');
    const range = `${sheetName}!A${row._sheetRow}:${colLetter(headers.length)}${row._sheetRow}`;

    const res = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,
      {
        method: 'PUT',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ range, majorDimension: 'ROWS', values: [rowValues] })
      }
    );
    if (!res.ok) {
      const e = await res.json();
      throw new Error(`Erro (${res.status}): ${e.error?.message || 'desconhecido'}`);
    }
    pendingChanges.delete(id);
    updatePublishBtn();
    render();
    showToast(`✅ Linha salva na planilha!`);
  } catch(e) {
    showToast('❌ ' + e.message, true);
    console.error(e);
  } finally {
    setLoad(false);
  }
}

let tTimer;
function showToast(msg, err=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = (err?'err ':'') + 'show';
  clearTimeout(tTimer);
  tTimer = setTimeout(()=>t.classList.remove('show'), 3500);
}

// Search triggered by button or Enter key only

// Enter key support for login
['loginUser','loginPass'].forEach(id =>
  document.getElementById(id).addEventListener('keydown', e => e.key==='Enter' && doLogin()));

render();



// ── NAVIGATION ────────────────────────────────────────────────────────────────
function goTo(screen) {
  document.getElementById('navScreen').classList.remove('active');
  document.getElementById('inventoryScreen').style.display = 'none';
  document.getElementById('chartScreen').classList.remove('active');
  const _rs = document.getElementById('reportsScreen');
  if (_rs) _rs.classList.remove('active');
  const _os = document.getElementById('ordensScreen');
  if (_os) _os.classList.remove('active');
  const _est = document.getElementById('estoqueScreen');
  if (_est) _est.classList.remove('active');

  if (screen === 'nav') {
    document.getElementById('navScreen').classList.add('active');
    updateNavSync();
  } else if (screen === 'inventory') {
    document.getElementById('inventoryScreen').style.display = 'block';
  } else if (screen === 'charts') {
    document.getElementById('chartScreen').classList.add('active');
    renderCharts();
  } else if (screen === 'reports') {
    const rs = document.getElementById('reportsScreen');
    if (rs) { rs.classList.add('active'); initReportsScreen(); }
  } else if (screen === 'ordens') {
    if (_os) { _os.classList.add('active'); renderOrdens(); }
  } else if (screen === 'estoque') {
    if (_est) { _est.classList.add('active'); renderEstoque(); }
  }
}

function updateNavSync() {
  const dot = document.getElementById('navSyncDot');
  const lbl = document.getElementById('navSyncLabel');
  const srcDot = document.getElementById('syncDot');
  const srcLbl = document.getElementById('syncLabel');
  dot.className = srcDot.className;
  lbl.textContent = srcLbl.textContent;
}

// ── CHARTS ────────────────────────────────────────────────────────────────────
function renderCharts() {
  const el = document.getElementById('chartContent');
  const lastSync = document.getElementById('lastSync').textContent;
  document.getElementById('chartLastSync').textContent = lastSync;

  if (!data.length) {
    el.innerHTML = `
      <div class="chart-empty">
        <h3>Sem dados carregados</h3>
        <p>Volte ao menu e sincronize a planilha primeiro.</p>
      </div>`;
    return;
  }

  // Find "Moderado" column by name, count rows with value "SIM"
  const mCol = headers.find(h => h.trim().toLowerCase() === 'moderado') || null;
  const total = data.length;

  if (!mCol) {
    el.innerHTML = `
      <div class="chart-empty">
        <h3>Coluna "Moderado" não encontrada</h3>
        <p>Verifique se sua planilha possui uma coluna chamada <strong style="color:var(--accent2)">Moderado</strong>.</p>
      </div>`;
    return;
  }

  const moderadoCount = data.filter(row =>
    String(row[mCol] || '').trim().toUpperCase() === 'SIM'
  ).length;

  const pct = total > 0 ? Math.round((moderadoCount / total) * 100) : 0;
  const outros = total - moderadoCount;

  // SVG donut
  const r = 60, stroke = 18;
  const circ = 2 * Math.PI * r;
  const dash = (pct / 100) * circ;
  const gap = circ - dash;

  el.innerHTML = `
    <div class="chart-section-title">Análise · Consolidados na coluna Moderado</div>

    <div class="kpi-card">
      <div class="kpi-donut-wrap">
        <svg viewBox="0 0 160 160">
          <circle cx="80" cy="80" r="${r}" fill="none"
            stroke="var(--surface2)" stroke-width="${stroke}"/>
          <circle cx="80" cy="80" r="${r}" fill="none"
            stroke="var(--accent2)" stroke-width="${stroke}"
            stroke-dasharray="${dash.toFixed(2)} ${gap.toFixed(2)}"
            stroke-linecap="round"
            style="transition: stroke-dasharray 1s cubic-bezier(0.4,0,0.2,1)"/>
        </svg>
        <div class="kpi-donut-center">
          <span class="kpi-pct">${pct}%</span>
          <span class="kpi-pct-label">SIM</span>
        </div>
      </div>

      <div class="kpi-info">
        <div class="kpi-title">Itens <span>Consolidados</span> (SIM)</div>
        <div class="kpi-desc">
          Proporção de itens consolidados (<strong style="color:var(--accent2)">SIM</strong> na coluna Moderado)
          em relação ao total de itens carregados da planilha.
        </div>
        <div class="kpi-numbers">
          <div class="kpi-num">
            <span class="kpi-num-val mod">${moderadoCount}</span>
            <span class="kpi-num-lbl">SIM</span>
          </div>
          <div class="kpi-num">
            <span class="kpi-num-val" style="color:var(--muted)">${outros}</span>
            <span class="kpi-num-lbl">Outros</span>
          </div>
          <div class="kpi-num">
            <span class="kpi-num-val total">${total}</span>
            <span class="kpi-num-lbl">Total</span>
          </div>
        </div>
      </div>
    </div>

    <div class="bar-visual">
      <div class="bar-visual-title">Distribuição visual</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${pct}%">
          ${pct >= 10 ? `<span class="bar-fill-label">${pct}%</span>` : ''}
        </div>
      </div>
      <div class="bar-legend">
        <div class="bar-leg-item">
          <div class="bar-leg-dot" style="background:var(--accent2)"></div>
          SIM na col. Moderado (${moderadoCount} itens · ${pct}%)
        </div>
        <div class="bar-leg-item">
          <div class="bar-leg-dot" style="background:var(--surface2);border:1px solid var(--border)"></div>
          Outros (${outros} itens · ${100 - pct}%)
        </div>
      </div>
    </div>
  `;
}

// Register PWA service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}


// ── CONFIRM MODAL ─────────────────────────────────────────────────────────────
let _confirmCb = null;
function openConfirm(msg, icon, title, yesLabel, cb) {
  document.getElementById('confirmMsg').innerHTML = msg;
  document.getElementById('confirmIcon').textContent = icon;
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmYesBtn').textContent = yesLabel;
  _confirmCb = cb;
  document.getElementById('confirmModal').classList.add('open');
}
function closeConfirm() {
  document.getElementById('confirmModal').classList.remove('open');
  _confirmCb = null;
}
document.getElementById('confirmYesBtn').addEventListener('click', function() {
  if (_confirmCb) _confirmCb();
  closeConfirm();
});

// ── BARCODE SCANNER ───────────────────────────────────────────────────────────
var _scanStream = null, _scanDetector = null, _scanFrame = null, _lastCode = '';

async function openScanner() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showToast('❌ Câmera não suportada neste dispositivo.', true); return;
  }
  _lastCode = '';
  document.getElementById('scannerResultBox').style.display = 'none';
  document.getElementById('btnScanUse').disabled = true;
  document.getElementById('scannerStatus').textContent = 'Solicitando permissão de câmera...';
  document.getElementById('scannerModal').classList.add('open');
  try {
    _scanStream = await navigator.mediaDevices.getUserMedia(
      { video: { facingMode: { ideal: 'environment' } } }
    );
    var vid = document.getElementById('scannerVideo');
    vid.srcObject = _scanStream;
    await vid.play();
    document.getElementById('scannerStatus').textContent = 'Aponte para um código de barras ou QR Code';
    if ('BarcodeDetector' in window) {
      _scanDetector = new BarcodeDetector({ formats: [
        'code_128','code_39','ean_13','ean_8','qr_code','upc_a','upc_e','itf','pdf417'
      ]});
      _scanLoop();
    } else {
      document.getElementById('scannerStatus').textContent =
        '⚠️ Detecção automática indisponível neste navegador. Digite o código na busca.';
    }
  } catch(err) {
    var msg = err.name === 'NotAllowedError'
      ? '❌ Permissão de câmera negada.'
      : err.name === 'NotFoundError'
        ? '❌ Câmera não encontrada.'
        : '❌ Não foi possível acessar a câmera.';
    document.getElementById('scannerStatus').textContent = msg;
    showToast(msg, true);
  }
}
function _scanLoop() {
  var vid = document.getElementById('scannerVideo');
  if (!_scanDetector || !_scanStream || vid.readyState < 2) {
    _scanFrame = requestAnimationFrame(_scanLoop); return;
  }
  _scanDetector.detect(vid).then(function(codes) {
    if (codes.length > 0 && codes[0].rawValue !== _lastCode) {
      _lastCode = codes[0].rawValue;
      document.getElementById('scannerResultVal').textContent = _lastCode;
      document.getElementById('scannerResultBox').style.display = 'block';
      document.getElementById('btnScanUse').disabled = false;
      document.getElementById('scannerStatus').textContent = '✅ Código detectado!';
      if (navigator.vibrate) navigator.vibrate([80,40,80]);
    }
  }).catch(function(){}).finally(function() {
    if (_scanStream) _scanFrame = requestAnimationFrame(_scanLoop);
  });
}
function restartScanner() {
  _lastCode = '';
  document.getElementById('scannerResultBox').style.display = 'none';
  document.getElementById('btnScanUse').disabled = true;
  document.getElementById('scannerStatus').textContent = 'Aponte para um código de barras ou QR Code';
}
function useScannedCode() {
  if (!_lastCode) return;
  closeScanner();
  goTo('inventory');
  document.getElementById('searchInput').value = _lastCode;
  doSearch();
  showToast('🔍 Buscando: "' + _lastCode + '"');
}
function closeScanner() {
  _stopCamera();
  document.getElementById('scannerModal').classList.remove('open');
}
function _stopCamera() {
  if (_scanFrame) { cancelAnimationFrame(_scanFrame); _scanFrame = null; }
  if (_scanStream) { _scanStream.getTracks().forEach(function(t){t.stop();}); _scanStream = null; }
  var v = document.getElementById('scannerVideo');
  if (v) v.srcObject = null;
}

// ── REPORTS ───────────────────────────────────────────────────────────────────
var _rptData = [];
var RPT_COLS = ['equipamento','modelo','fabricante','setor','situação','situacao','moderado'];

function initReportsScreen() {
  var grid = document.getElementById('rptFilterGrid');
  Array.from(grid.querySelectorAll('.rpt-dyn')).forEach(function(el){el.remove();});
  headers.filter(function(h){return RPT_COLS.includes(h.trim().toLowerCase());}).forEach(function(col){
    var vals = getUniqueValues(col);
    if (!vals.length) return;
    var d = document.createElement('div');
    d.className = 'rpt-dyn';
    d.innerHTML = '<label>' + esc(col) + '</label>' +
      '<select class="rpt-sel" id="rf_' + escA(col) + '">' +
      '<option value="">Todos</option>' +
      vals.map(function(v){return '<option value="'+esc(v)+'">'+esc(v)+'</option>';}).join('') +
      '</select>';
    grid.appendChild(d);
  });
  document.getElementById('rptSyncLbl').textContent = document.getElementById('lastSync').textContent;
  applyRptFilter();
}
function applyRptFilter() {
  var sf = document.getElementById('rFilterStatus').value;
  var qf = document.getElementById('rFilterSearch').value.trim().toLowerCase();
  var filtered = data.filter(function(row) {
    var ms = !qf || headers.some(function(h){return (row[h]||'').toLowerCase().includes(qf);});
    var mf = sf==='all' || (sf==='locked'&&row._locked) || (!row._locked&&sf===status(row));
    return ms && mf;
  });
  headers.forEach(function(col){
    var el = document.getElementById('rf_' + escA(col));
    if (el && el.value) filtered = filtered.filter(function(r){return (r[col]||'').trim()===el.value;});
  });
  _rptData = filtered;
  _renderRptTable(); _renderRptKpis();
}
function _renderRptKpis() {
  var t = _rptData.length;
  document.getElementById('rptKpis').innerHTML =
    '<div class="rpt-kpi"><span class="rpt-kpi-val">'+t+'</span><span class="rpt-kpi-lbl">TOTAL</span></div>' +
    '<div class="rpt-kpi"><span class="rpt-kpi-val" style="color:var(--accent)">' +
      _rptData.filter(function(r){return !r._locked&&status(r)==='ok';}).length +
    '</span><span class="rpt-kpi-lbl">ATIVO</span></div>' +
    '<div class="rpt-kpi"><span class="rpt-kpi-val" style="color:#ffc107">' +
      _rptData.filter(function(r){return !r._locked&&status(r)==='low';}).length +
    '</span><span class="rpt-kpi-lbl">BAIXO ESTOQUE</span></div>' +
    '<div class="rpt-kpi"><span class="rpt-kpi-val" style="color:var(--warn)">' +
      _rptData.filter(function(r){return !r._locked&&status(r)==='out';}).length +
    '</span><span class="rpt-kpi-lbl">SEM ESTOQUE</span></div>' +
    '<div class="rpt-kpi"><span class="rpt-kpi-val" style="color:var(--muted)">' +
      _rptData.filter(function(r){return r._locked;}).length +
    '</span><span class="rpt-kpi-lbl">CONSOLIDADOS</span></div>';
}
function _renderRptTable() {
  var vis = headers.filter(function(h){return RPT_COLS.includes(h.trim().toLowerCase());});
  var show = vis.length ? vis : headers.slice(0,5);
  document.getElementById('rptCount').textContent = _rptData.length;
  document.getElementById('rptHead').innerHTML = '<th>Status</th>' +
    show.map(function(h){return '<th>'+esc(h)+'</th>';}).join('');
  var empty = document.getElementById('rptEmpty');
  var tbl = document.querySelector('.rpt-table');
  if (!_rptData.length) {
    document.getElementById('rptBody').innerHTML = '';
    empty.style.display = ''; tbl.style.display = 'none'; return;
  }
  tbl.style.display = ''; empty.style.display = 'none';
  document.getElementById('rptBody').innerHTML = _rptData.map(function(row){
    return '<tr><td>'+badge(row)+'</td>'+
      show.map(function(h){return '<td>'+esc(row[h]||'—')+'</td>';}).join('')+'</tr>';
  }).join('');
}
function clearRptFilter() {
  document.getElementById('rFilterStatus').value = 'all';
  document.getElementById('rFilterSearch').value = '';
  headers.forEach(function(col){
    var el = document.getElementById('rf_'+escA(col));
    if (el) el.value = '';
  });
  applyRptFilter();
}
function printRpt() {
  if (!_rptData.length) { showToast('⚠️ Nenhum dado para imprimir.', true); return; }
  var vis = headers.filter(function(h){return RPT_COLS.includes(h.trim().toLowerCase());});
  var show = vis.length ? vis : headers.slice(0,5);
  var ses = getSession();
  document.getElementById('printArea').innerHTML =
    '<div class="print-title">INV//CTRL — Relatório de Inventário</div>' +
    '<div class="print-sub">Gerado em: ' + new Date().toLocaleString('pt-BR') +
    ' · Por: ' + (ses ? ses.name : '—') + ' · Total: ' + _rptData.length + ' itens</div>' +
    '<table><thead><tr><th>Status</th>' +
    show.map(function(h){return '<th>'+esc(h)+'</th>';}).join('') + '</tr></thead><tbody>' +
    _rptData.map(function(row){
      var st = row._locked?'Consolidado':status(row)==='out'?'Sem estoque':status(row)==='low'?'Baixo estoque':'ATIVO';
      return '<tr><td>'+st+'</td>'+show.map(function(h){return '<td>'+esc(row[h]||'—')+'</td>';}).join('')+'</tr>';
    }).join('') + '</tbody></table>';
  window.print();
}

// ── NOTIFICAÇÕES PARA ADMIN ───────────────────────────────────────────────────
function notifyAdminPublish(count, userName) {
  try {
    var all = JSON.parse(localStorage.getItem('invctr_notifs') || '[]');
    all.unshift({ id: Date.now(), msg: '📤 ' + userName + ' publicou ' + count + ' alteração(ões) na planilha.', time: new Date().toLocaleString('pt-BR'), read: false });
    localStorage.setItem('invctr_notifs', JSON.stringify(all.slice(0,20)));
    localStorage.setItem('invctr_ping', Date.now().toString());
    setTimeout(function(){ localStorage.removeItem('invctr_ping'); }, 200);
  } catch(e) {}
}
function updateNotifBadge() {
  var badge = document.getElementById('notifBadge');
  if (!badge) return;
  try {
    var n = JSON.parse(localStorage.getItem('invctr_notifs')||'[]').filter(function(x){return !x.read;}).length;
    badge.textContent = n;
    badge.style.display = n > 0 ? 'inline-flex' : 'none';
  } catch(e) {}
}
function toggleNotifPanel() {
  var panel = document.getElementById('notifPanel');
  if (!panel) return;
  if (panel.style.display !== 'none') { panel.style.display = 'none'; return; }
  var all = [];
  try { all = JSON.parse(localStorage.getItem('invctr_notifs')||'[]'); } catch(e) {}
  panel.innerHTML =
    '<div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">' +
      '<span style="font-family:var(--font-mono);font-size:.75rem;color:var(--accent);">NOTIFICAÇÕES</span>' +
      '<button onclick="markNotifsRead()" style="font-size:.68rem;font-family:var(--font-mono);color:var(--muted);background:none;border:none;cursor:pointer;">Marcar lidas</button>' +
    '</div>' +
    '<div style="max-height:280px;overflow-y:auto;">' +
    (all.length ? all.map(function(n){
      return '<div style="padding:11px 16px;border-bottom:1px solid var(--border);' + (!n.read?'background:rgba(0,229,160,.04)':'') + '">' +
        '<div style="font-size:.82rem;color:'+(n.read?'var(--muted)':'var(--text)')+';">'+n.msg+'</div>' +
        '<div style="font-size:.68rem;color:var(--muted);font-family:var(--font-mono);margin-top:3px;">'+n.time+'</div></div>';
    }).join('') : '<div style="padding:24px;text-align:center;color:var(--muted);font-size:.8rem;">Sem notificações</div>') +
    '</div>';
  panel.style.display = 'block';
  markNotifsRead();
}
function markNotifsRead() {
  try {
    var all = JSON.parse(localStorage.getItem('invctr_notifs')||'[]');
    all.forEach(function(n){n.read=true;});
    localStorage.setItem('invctr_notifs', JSON.stringify(all));
    updateNotifBadge();
  } catch(e) {}
}
window.addEventListener('storage', function(e) {
  if (e.key === 'invctr_ping') {
    var s = getSession();
    if (s && s.admin) {
      updateNotifBadge();
      try {
        var unread = JSON.parse(localStorage.getItem('invctr_notifs')||'[]').filter(function(x){return !x.read;});
        if (unread.length) showToast('🔔 ' + unread[0].msg);
      } catch(e) {}
    }
  }
});

// ══════════════════════════════════════════════════════════════════
// MÓDULO: ORDENS DE SERVIÇO (CMMS SAP)
// ══════════════════════════════════════════════════════════════════
const OS_STORAGE_KEY = 'invctr_ordens';
let ordensData = [];
let osEditId = null;
let osMatRows = [];

function loadOrdens() {
  try { ordensData = JSON.parse(localStorage.getItem(OS_STORAGE_KEY) || '[]'); } catch(e) { ordensData = []; }
}
function saveOrdens() {
  localStorage.setItem(OS_STORAGE_KEY, JSON.stringify(ordensData));
}

function osBadge(status) {
  const map = {
    'Aberta': '<span class="os-badge os-aberta">● Aberta</span>',
    'Em Andamento': '<span class="os-badge os-andamento">● Em Andamento</span>',
    'Concluída': '<span class="os-badge os-concluida">✔ Concluída</span>',
    'Cancelada': '<span class="os-badge os-cancelada">✕ Cancelada</span>'
  };
  return map[status] || `<span class="os-badge">${esc(status)}</span>`;
}

function renderOrdens() {
  loadOrdens();
  const q = (document.getElementById('osSearchInput')?.value || '').toLowerCase().trim();
  const sf = document.getElementById('osFilterStatus')?.value || '';
  const hasFilter = q.length > 0 || sf.length > 0;

  // KPIs always visible
  const total = ordensData.length;
  const abertas = ordensData.filter(o=>o.status==='Aberta').length;
  const andamento = ordensData.filter(o=>o.status==='Em Andamento').length;
  const concluidas = ordensData.filter(o=>o.status==='Concluída').length;
  const vencidas = ordensData.filter(o=>o.prazo && o.status!=='Concluída' && o.status!=='Cancelada' && new Date(o.prazo) < new Date()).length;
  document.getElementById('osKpis').innerHTML = [
    ['Total OS', total, 'var(--text)'],
    ['Abertas', abertas, 'var(--accent)'],
    ['Em Andamento', andamento, '#f59e0b'],
    ['Concluídas', concluidas, 'var(--accent2)'],
    ['Vencidas', vencidas, 'var(--warn)']
  ].map(([l,v,c]) => `<div class="os-kpi"><span class="os-kpi-val" style="color:${c}">${v}</span><span class="os-kpi-lbl">${l}</span></div>`).join('');

  const body = document.getElementById('osBody');
  const empty = document.getElementById('osEmpty');
  const tableWrap = document.getElementById('osTableWrap');

  // If no filter active: hide table, show hint
  if (!hasFilter) {
    body.innerHTML = '';
    document.getElementById('osCount').textContent = '—';
    tableWrap.style.display = 'none';
    empty.style.display = '';
    empty.innerHTML = `
      <div style="font-size:2rem;margin-bottom:12px;">🔍</div>
      <div style="font-family:var(--font-mono);font-size:.85rem;color:var(--text);">Use os filtros para localizar OSs</div>
      <div style="font-size:.78rem;margin-top:8px;color:var(--muted);">Busque por N°, equipamento, responsável ou filtre pelo status acima.</div>`;
    return;
  }

  tableWrap.style.display = '';

  let filtered = ordensData.filter(o => {
    const ms = !q || [o.numSap,o.tipo,o.equipamento,o.setor,o.responsavel,o.descricao].some(f => (f||'').toLowerCase().includes(q));
    const mf = !sf || o.status === sf;
    return ms && mf;
  });

  document.getElementById('osCount').textContent = filtered.length;

  if (!filtered.length) {
    body.innerHTML = '';
    empty.style.display = '';
    empty.innerHTML = `
      <div style="font-size:2rem;margin-bottom:12px;">🔧</div>
      <div style="font-family:var(--font-mono);font-size:.85rem;">Nenhuma OS encontrada</div>
      <div style="font-size:.78rem;margin-top:6px;color:var(--muted);">Tente outros termos ou filtros</div>`;
    return;
  }

  empty.style.display = 'none';
  body.innerHTML = filtered.map(o => `
    <tr>
      <td>
        <div class="action-btns">
          <button class="btn-os-act" onclick="openOsDetail('${o.id}')" title="Ver detalhes">👁</button>
          <button class="btn-os-act" onclick="editOs('${o.id}')" title="Editar">✏️</button>
          <button class="btn-os-act" onclick="deleteOs('${o.id}')" title="Excluir" style="color:var(--warn);border-color:rgba(255,107,53,.25);">🗑</button>
        </div>
      </td>
      <td style="font-family:var(--font-mono);font-size:.8rem;color:#f59e0b">${esc(o.numSap||'—')}</td>
      <td style="font-size:.78rem;color:var(--muted)">${esc((o.tipo||'').split(' - ')[0])}</td>
      <td><strong>${esc(o.equipamento||'—')}</strong></td>
      <td>${esc(o.setor||'—')}</td>
      <td>${esc(o.responsavel||'—')}</td>
      <td><span style="font-family:var(--font-mono);font-size:.75rem;color:${o.prioridade&&o.prioridade.startsWith('1')?'var(--warn)':o.prioridade&&o.prioridade.startsWith('2')?'#f59e0b':'var(--muted)'}">${esc(o.prioridade||'—')}</span></td>
      <td>${osBadge(o.status)}</td>
      <td style="font-family:var(--font-mono);font-size:.76rem">${o.dataAbertura||'—'}</td>
      <td style="font-family:var(--font-mono);font-size:.76rem;color:${o.prazo&&o.status!=='Concluída'&&new Date(o.prazo)<new Date()?'var(--warn)':'var(--muted)'}">${o.prazo||'—'}</td>
    </tr>`).join('');
}

function gerarNumOS() {
  // Gera número sequencial baseado nos existentes + timestamp parcial
  loadOrdens();
  const prefix = 'OS';
  const year = new Date().getFullYear().toString().slice(-2);
  const existing = ordensData.map(o => {
    const m = (o.numSap || '').match(/^OS(\d+)$/);
    return m ? parseInt(m[1]) : 0;
  });
  const nextSeq = existing.length ? Math.max(...existing) + 1 : 1;
  return `OS${String(nextSeq).padStart(6,'0')}`;
}

function searchEquipamento(q) {
  const box = document.getElementById('equipResults');
  const term = (q || '').trim().toLowerCase();

  if (term.length < 1) { box.style.display = 'none'; return; }

  if (!data || !data.length) {
    box.style.display = '';
    box.innerHTML = '<div class="equip-no-results">⚠️ Nenhum inventário carregado.<br>Sincronize ou carregue um arquivo primeiro.</div>';
    return;
  }

  // Busca em TODAS as colunas do inventário
  const results = data.filter(row =>
    headers.some(h => (row[h] || '').toLowerCase().includes(term))
  ).slice(0, 15);

  if (!results.length) {
    box.style.display = '';
    box.innerHTML = `<div class="equip-no-results">Nenhum item encontrado para "<strong>${esc(q)}</strong>"</div>`;
    return;
  }

  // Identifica colunas mais relevantes para exibição no dropdown
  const colPrimary   = headers.find(h => /equipamento|descri|nome|tag|item/i.test(h)) || headers[0];
  const colTag       = headers.find(h => /^tag$/i.test(h)) || headers.find(h => /\btag\b/i.test(h));
  const colSerie     = headers.find(h => /serie|serial|n.?serie|patrimonio|patrim/i.test(h));
  const colModelo    = headers.find(h => /modelo|model/i.test(h));
  const colFabric    = headers.find(h => /fabricante|fabric|marca/i.test(h));
  const colSetor     = headers.find(h => /setor|area|local|departamento|cc|centro/i.test(h));

  // Salva os resultados num mapa global para acessar no onclick
  window._equipSearchResults = {};
  results.forEach(row => { window._equipSearchResults[row._id] = row; });

  box.style.display = '';
  box.innerHTML = results.map(row => {
    const primary = row[colPrimary] || row[headers[0]] || '—';
    const tag     = colTag    ? row[colTag]    : '';
    const serie   = colSerie  ? row[colSerie]  : '';
    const modelo  = colModelo ? row[colModelo] : '';
    const fabric  = colFabric ? row[colFabric] : '';
    const setor   = colSetor  ? row[colSetor]  : '';

    const sub = [tag && `TAG: ${tag}`, serie && `Série: ${serie}`, modelo, fabric, setor && `📍 ${setor}`]
      .filter(Boolean).join(' · ');

    return `<div class="equip-result-item" onclick="selectEquipamento(${row._id})">
      <div style="font-weight:600">${esc(primary)}</div>
      ${sub ? `<div class="equip-result-tag">${esc(sub)}</div>` : ''}
    </div>`;
  }).join('');
}

function selectEquipamento(rowId) {
  const row = window._equipSearchResults && window._equipSearchResults[rowId];
  if (!row) return;

  // Identifica colunas para preenchimento
  const colPrimary = headers.find(h => /equipamento|descri|nome|tag|item/i.test(h)) || headers[0];
  const colTag     = headers.find(h => /^tag$/i.test(h)) || headers.find(h => /\btag\b/i.test(h));
  const colSerie   = headers.find(h => /serie|serial|n.?serie|patrimonio|patrim/i.test(h));
  const colModelo  = headers.find(h => /modelo|model/i.test(h));
  const colFabric  = headers.find(h => /fabricante|fabric|marca/i.test(h));
  const colSetor   = headers.find(h => /setor|area|local|departamento|cc|centro/i.test(h));
  const colResp    = headers.find(h => /responsavel|resp|tecnico/i.test(h));

  // Monta label do equipamento: TAG + Nome, ou apenas Nome
  const tag     = colTag   ? (row[colTag]   || '') : '';
  const primary = row[colPrimary] || row[headers[0]] || '';
  const serie   = colSerie ? (row[colSerie] || '') : '';
  const modelo  = colModelo? (row[colModelo]|| '') : '';

  // Campo equipamento: TAG + descrição/modelo (o mais completo possível)
  let equipLabel = '';
  if (tag)    equipLabel = tag;
  if (primary && primary !== tag) equipLabel += (equipLabel ? ' — ' : '') + primary;
  if (modelo && modelo !== primary) equipLabel += (equipLabel ? ' / ' : '') + modelo;
  if (!equipLabel) equipLabel = primary || serie || '—';

  document.getElementById('osEquipamento').value = equipLabel;

  // Preenche Setor se disponível e vazio
  if (colSetor && row[colSetor]) {
    const el = document.getElementById('osSetor');
    if (!el.value) el.value = row[colSetor];
  }

  // Preenche Responsável se disponível e vazio
  if (colResp && row[colResp]) {
    const el = document.getElementById('osResponsavel');
    if (!el.value) el.value = row[colResp];
  }

  // Preenche Centro de Trabalho / Fabricante como dica
  const colCentro = headers.find(h => /centro.trab|ct|ctrab/i.test(h));
  if (colCentro && row[colCentro]) {
    const el = document.getElementById('osCentroTrabalho');
    if (!el.value) el.value = row[colCentro];
  }

  // Feedback visual: mostra tag/série abaixo do campo
  let feedback = [];
  if (tag)   feedback.push(`TAG: ${tag}`);
  if (serie) feedback.push(`Série: ${serie}`);
  if (colFabric && row[colFabric]) feedback.push(`Fabricante: ${row[colFabric]}`);
  const hint = document.getElementById('osEquipHint');
  if (hint) hint.textContent = feedback.join(' · ');

  closeEquipResults();
  window._equipSearchResults = {};
}

function closeEquipResults() {
  const box = document.getElementById('equipResults');
  if (box) box.style.display = 'none';
}

function openOsModal(id) {
  osEditId = id || null;
  osMatRows = [];
  loadOrdens();
  const o = id ? ordensData.find(x=>x.id===id) : null;

  document.getElementById('osModalTitle').textContent = o ? '✏️ EDITAR ORDEM DE SERVIÇO' : '🔧 NOVA ORDEM DE SERVIÇO';
  // Auto-generate OS number for new OS
  document.getElementById('osNumSap').value = o?.numSap || gerarNumOS();
  document.getElementById('osTipo').value = o?.tipo || 'PM01 - Manutenção Corretiva';
  document.getElementById('osEquipamento').value = o?.equipamento || '';
  const hint = document.getElementById('osEquipHint');
  if (hint) hint.textContent = '';
  document.getElementById('osSetor').value = o?.setor || '';
  document.getElementById('osResponsavel').value = o?.responsavel || '';
  document.getElementById('osPrioridade').value = o?.prioridade || '3 - Média';
  document.getElementById('osDataAbertura').value = o?.dataAbertura || new Date().toISOString().slice(0,10);
  document.getElementById('osDataPrazo').value = o?.prazo || '';
  document.getElementById('osStatus').value = o?.status || 'Aberta';
  document.getElementById('osCentroTrabalho').value = o?.centroTrabalho || '';
  document.getElementById('osDescricao').value = o?.descricao || '';
  closeEquipResults();

  // Render materials
  osMatRows = o?.materiais ? o.materiais.map(m => ({...m})) : [];
  renderOsMatRows();

  document.getElementById('osModal').classList.add('open');
}

function closeOsModal() { document.getElementById('osModal').classList.remove('open'); }

function renderOsMatRows() {
  const list = document.getElementById('osMatList');
  const empty = document.getElementById('osMatEmpty');
  if (!osMatRows.length) {
    list.innerHTML = '<div class="os-mat-row os-mat-hdr"><span>Descrição do material</span><span>Qtd</span><span>Und</span><span></span></div>';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = '<div class="os-mat-row os-mat-hdr"><span>Descrição do material</span><span>Qtd</span><span>Und</span><span></span></div>' +
    osMatRows.map((m,i) => `
      <div class="os-mat-row">
        <input class="nf-input" value="${esc(m.desc||'')}" oninput="osMatRows[${i}].desc=this.value" placeholder="Descrição">
        <input class="nf-input" type="number" min="0" value="${m.qtd||''}" oninput="osMatRows[${i}].qtd=this.value" placeholder="0" style="text-align:right">
        <input class="nf-input" value="${esc(m.und||'')}" oninput="osMatRows[${i}].und=this.value" placeholder="UN/PC/M">
        <button class="btn-os-del-mat" onclick="osMatRows.splice(${i},1);renderOsMatRows()">✕</button>
      </div>`).join('');
}

function addOsMatRow() {
  osMatRows.push({desc:'',qtd:'',und:'UN'});
  renderOsMatRows();
}

function saveOs() {
  const numSap = document.getElementById('osNumSap').value.trim();
  const equipamento = document.getElementById('osEquipamento').value.trim();
  if (!equipamento) { showToast('⚠️ Informe o equipamento.', true); return; }

  loadOrdens();
  const session = getSession();
  const o = {
    id: osEditId || ('OS_' + Date.now()),
    numSap, tipo: document.getElementById('osTipo').value,
    equipamento, setor: document.getElementById('osSetor').value.trim(),
    responsavel: document.getElementById('osResponsavel').value.trim(),
    prioridade: document.getElementById('osPrioridade').value,
    dataAbertura: document.getElementById('osDataAbertura').value,
    prazo: document.getElementById('osDataPrazo').value,
    status: document.getElementById('osStatus').value,
    centroTrabalho: document.getElementById('osCentroTrabalho').value.trim(),
    descricao: document.getElementById('osDescricao').value.trim(),
    materiais: osMatRows.filter(m=>m.desc),
    criadoPor: session?.name || '—',
    criadoEm: osEditId ? (ordensData.find(x=>x.id===osEditId)?.criadoEm || new Date().toISOString()) : new Date().toISOString(),
    atualizadoEm: new Date().toISOString()
  };

  if (osEditId) {
    const idx = ordensData.findIndex(x=>x.id===osEditId);
    if (idx >= 0) ordensData[idx] = o;
  } else {
    ordensData.unshift(o);
  }

  saveOrdens();
  closeOsModal();
  renderOrdens();
  showToast(osEditId ? '✅ OS atualizada!' : '✅ OS criada com sucesso!');
}

function editOs(id) { openOsModal(id); }

function deleteOs(id) {
  loadOrdens();
  const o = ordensData.find(x=>x.id===id);
  if (!o) return;
  openConfirm(
    'Excluir a OS <strong>"' + esc(o.numSap||o.equipamento) + '"</strong>? Esta ação não pode ser desfeita.',
    '🗑', 'EXCLUIR OS', 'Sim, excluir',
    function() {
      ordensData = ordensData.filter(x=>x.id!==id);
      saveOrdens();
      renderOrdens();
      showToast('🗑 OS excluída.');
    }
  );
}

function openOsDetail(id) {
  loadOrdens();
  const o = ordensData.find(x=>x.id===id);
  if (!o) return;
  const body = document.getElementById('osDetailBody');
  body.innerHTML = `
    <div style="padding:0 0 16px;margin-bottom:16px;border-bottom:1px solid var(--border);">
      ${osBadge(o.status)}
      <div style="margin-top:8px;">
        <span style="font-family:var(--font-mono);font-size:.7rem;color:var(--muted);">Alterar Status:</span><br>
        <select class="os-status-select" style="margin-top:6px;" onchange="changeOsStatus('${o.id}',this.value)">
          <option ${o.status==='Aberta'?'selected':''}>Aberta</option>
          <option ${o.status==='Em Andamento'?'selected':''}>Em Andamento</option>
          <option ${o.status==='Concluída'?'selected':''}>Concluída</option>
          <option ${o.status==='Cancelada'?'selected':''}>Cancelada</option>
        </select>
      </div>
    </div>
    <div class="os-detail-section">
      <div class="os-detail-section-title">📋 Identificação SAP</div>
      ${detailRow('N° OS SAP', o.numSap)}
      ${detailRow('Tipo', o.tipo)}
      ${detailRow('Centro de Trabalho', o.centroTrabalho)}
    </div>
    <div class="os-detail-section">
      <div class="os-detail-section-title">🔧 Equipamento</div>
      ${detailRow('Equipamento / TAG', o.equipamento)}
      ${detailRow('Setor / CC', o.setor)}
      ${detailRow('Responsável', o.responsavel)}
      ${detailRow('Prioridade', o.prioridade)}
    </div>
    <div class="os-detail-section">
      <div class="os-detail-section-title">📅 Datas</div>
      ${detailRow('Abertura', o.dataAbertura)}
      ${detailRow('Prazo', o.prazo)}
      ${detailRow('Última atualização', o.atualizadoEm ? new Date(o.atualizadoEm).toLocaleString('pt-BR') : '—')}
    </div>
    <div class="os-detail-section">
      <div class="os-detail-section-title">📝 Descrição</div>
      <div style="font-size:.84rem;color:var(--text);line-height:1.6;padding:8px 0;">${esc(o.descricao||'Não informada')}</div>
    </div>
    ${o.materiais && o.materiais.length ? `
    <div class="os-detail-section">
      <div class="os-detail-section-title">📦 Materiais</div>
      ${o.materiais.map(m=>`<div class="os-detail-row"><span class="os-detail-lbl">${esc(m.desc)}</span><span class="os-detail-val">${esc(m.qtd)} ${esc(m.und)}</span></div>`).join('')}
    </div>` : ''}
    <div class="os-detail-section">
      <div class="os-detail-section-title">👤 Rastreio</div>
      ${detailRow('Criado por', o.criadoPor)}
      ${detailRow('Criado em', o.criadoEm ? new Date(o.criadoEm).toLocaleString('pt-BR') : '—')}
    </div>`;
  document.getElementById('osDetailDrawer').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function detailRow(lbl, val) {
  return `<div class="os-detail-row"><span class="os-detail-lbl">${lbl}</span><span class="os-detail-val">${esc(val||'—')}</span></div>`;
}

function closeOsDetail() {
  document.getElementById('osDetailDrawer').classList.remove('open');
  document.body.style.overflow = '';
}

function changeOsStatus(id, status) {
  loadOrdens();
  const o = ordensData.find(x=>x.id===id);
  if (o) { o.status = status; o.atualizadoEm = new Date().toISOString(); }
  saveOrdens();
  renderOrdens();
  showToast('✅ Status atualizado: ' + status);
}

// ══════════════════════════════════════════════════════════════════
// MÓDULO: ESTOQUE COMPLETO
// ══════════════════════════════════════════════════════════════════
const EST_NF_KEY = 'invctr_nf_entradas';
const EST_SALDO_KEY = 'invctr_est_saldos';
const EST_MOV_KEY = 'invctr_est_movimentos';

let nfEntradas = [];
let estSaldos = {};
let estMovimentos = [];
let nfItemsTemp = [];
let nfScanStream = null;
let nfScanInterval = null;
let nfScannedKey = '';

function loadEstoque() {
  try { nfEntradas = JSON.parse(localStorage.getItem(EST_NF_KEY)||'[]'); } catch(e) { nfEntradas = []; }
  try { estSaldos = JSON.parse(localStorage.getItem(EST_SALDO_KEY)||'{}'); } catch(e) { estSaldos = {}; }
  try { estMovimentos = JSON.parse(localStorage.getItem(EST_MOV_KEY)||'[]'); } catch(e) { estMovimentos = []; }
}
function saveEstoque() {
  localStorage.setItem(EST_NF_KEY, JSON.stringify(nfEntradas));
  localStorage.setItem(EST_SALDO_KEY, JSON.stringify(estSaldos));
  localStorage.setItem(EST_MOV_KEY, JSON.stringify(estMovimentos));
}

let estActiveTab = 'saldos';
function setEstTab(tab, el) {
  estActiveTab = tab;
  document.querySelectorAll('.est-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('estTabSaldos').style.display = tab==='saldos' ? '' : 'none';
  document.getElementById('estTabEntradas').style.display = tab==='entradas' ? '' : 'none';
  document.getElementById('estTabMovimentos').style.display = tab==='movimentos' ? '' : 'none';
  renderEstoque();
}

function renderEstoque() {
  loadEstoque();
  const q = (document.getElementById('estSearchInput')?.value||'').toLowerCase();

  // KPIs
  const totalItens = Object.keys(estSaldos).length;
  const totalEntradas = nfEntradas.length;
  const semEstoque = Object.values(estSaldos).filter(s=>s.saldo<=0).length;
  const estoqueBaixo = Object.values(estSaldos).filter(s=>s.saldo>0&&s.minSeg>0&&s.saldo<=s.minSeg).length;
  document.getElementById('estKpis').innerHTML = [
    ['Produtos', totalItens, '#06b6d4'],
    ['Notas Fiscais', totalEntradas, 'var(--accent2)'],
    ['Sem Estoque', semEstoque, 'var(--warn)'],
    ['Estoque Baixo', estoqueBaixo, '#ffc107'],
    ['Movimentos', estMovimentos.length, 'var(--muted)']
  ].map(([l,v,c])=>`<div class="est-kpi"><span class="est-kpi-val" style="color:${c}">${v}</span><span class="est-kpi-lbl">${l}</span></div>`).join('');

  // Saldos
  const saldosArr = Object.entries(estSaldos).filter(([k,s])=>!q||[k,s.descricao,s.unidade].some(f=>(f||'').toLowerCase().includes(q)));
  document.getElementById('estSaldoCount').textContent = saldosArr.length;
  const sb = document.getElementById('estSaldoBody');
  const se = document.getElementById('estSaldoEmpty');
  if (!saldosArr.length) { sb.innerHTML=''; se.style.display=''; }
  else {
    se.style.display = 'none';
    sb.innerHTML = saldosArr.map(([cod,s])=>{
      const cls = s.saldo<=0 ? 'est-saldo-zero' : (s.minSeg>0&&s.saldo<=s.minSeg ? 'est-saldo-low' : 'est-saldo-ok');
      return `<tr>
        <td style="font-family:var(--font-mono);font-size:.8rem;color:#06b6d4">${esc(cod)}</td>
        <td>${esc(s.descricao||'—')}</td>
        <td style="font-family:var(--font-mono);font-size:.76rem">${esc(s.unidade||'UN')}</td>
        <td><strong class="${cls}" style="font-family:var(--font-mono)">${s.saldo||0}</strong></td>
        <td style="font-family:var(--font-mono);font-size:.76rem;color:var(--muted)">${s.minSeg||0}</td>
        <td style="font-family:var(--font-mono);font-size:.74rem;color:var(--muted)">${s.ultimaEntrada||'—'}</td>
        <td>
          <div class="action-btns">
            <button class="btn-os-act" onclick="lancarSaidaEstoque('${esc(cod)}')" title="Lançar saída" style="color:#ffc107;border-color:rgba(255,193,7,.25);">📤</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  // NF Entradas
  const nfFiltered = nfEntradas.filter(n=>!q||[n.numero,n.fornecedor,n.cnpj].some(f=>(f||'').toLowerCase().includes(q)));
  document.getElementById('estNfCount').textContent = nfFiltered.length;
  const nb = document.getElementById('estNfBody');
  const ne = document.getElementById('estNfEmpty');
  if (!nfFiltered.length) { nb.innerHTML=''; ne.style.display=''; }
  else {
    ne.style.display = 'none';
    nb.innerHTML = nfFiltered.map(n=>`
      <tr>
        <td style="font-family:var(--font-mono);color:#06b6d4">${esc(n.numero||'—')}/${esc(n.serie||'—')}</td>
        <td style="font-family:var(--font-mono);font-size:.76rem">${esc(n.serie||'—')}</td>
        <td><strong>${esc(n.fornecedor||'—')}</strong></td>
        <td style="font-family:var(--font-mono);font-size:.74rem">${esc(n.cnpj||'—')}</td>
        <td style="font-family:var(--font-mono);color:var(--accent)">R$ ${Number(n.valorTotal||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
        <td style="font-family:var(--font-mono);font-size:.76rem">${n.dataEmissao||'—'}</td>
        <td style="font-family:var(--font-mono);font-size:.76rem;color:var(--accent2)">${(n.itens||[]).length} iten(s)</td>
        <td><span class="badge badge-ok" style="font-size:.66rem">Registrada</span></td>
      </tr>`).join('');
  }

  // Movimentos
  const mvFiltered = estMovimentos.filter(m=>!q||[m.produto,m.referencia,m.usuario].some(f=>(f||'').toLowerCase().includes(q)));
  document.getElementById('estMovCount').textContent = mvFiltered.length;
  const mb = document.getElementById('estMovBody');
  const mve = document.getElementById('estMovEmpty');
  if (!mvFiltered.length) { mb.innerHTML=''; mve.style.display=''; }
  else {
    mve.style.display = 'none';
    mb.innerHTML = mvFiltered.slice().reverse().map(m=>`
      <tr>
        <td style="font-family:var(--font-mono);font-size:.74rem">${m.datahora||'—'}</td>
        <td><span style="font-family:var(--font-mono);font-size:.72rem;padding:2px 8px;border-radius:10px;background:${m.tipo==='ENTRADA'?'rgba(0,229,160,.1)':'rgba(255,107,53,.1)'};color:${m.tipo==='ENTRADA'?'var(--accent)':'var(--warn)'}">${m.tipo}</span></td>
        <td>${esc(m.produto||'—')}</td>
        <td style="font-family:var(--font-mono);font-weight:700;color:${m.tipo==='ENTRADA'?'var(--accent)':'var(--warn)'}">${m.tipo==='ENTRADA'?'+':'−'}${m.qtd||0}</td>
        <td style="font-size:.76rem;color:var(--muted)">${esc(m.referencia||'—')}</td>
        <td style="font-size:.76rem;color:var(--muted)">${esc(m.usuario||'—')}</td>
      </tr>`).join('');
  }
}

// ── NF Modal ──────────────────────────────────────────────────────
function openNfModal() {
  nfItemsTemp = [];
  nfScannedKey = '';
  document.getElementById('nfChaveInput').value = '';
  document.getElementById('nfConsultaStatus').textContent = '';
  document.getElementById('nfDataCard').classList.remove('show');
  ['nfNumero','nfEmitente','nfCnpj','nfData','nfValor','nfChaveDisplay'].forEach(id=>{document.getElementById(id).textContent='—';});
  document.getElementById('nfNumeroManual').value = '';
  document.getElementById('nfSerie').value = '';
  document.getElementById('nfFornecedor').value = '';
  document.getElementById('nfDataEmissao').value = new Date().toISOString().slice(0,10);
  document.getElementById('nfObs').value = '';
  renderNfItems();
  document.getElementById('nfModal').classList.add('open');
}
function closeNfModal() { document.getElementById('nfModal').classList.remove('open'); }

function renderNfItems() {
  const list = document.getElementById('nfItemsList');
  const empty = document.getElementById('nfItemsEmpty');
  if (!nfItemsTemp.length) { list.innerHTML=''; empty.style.display=''; return; }
  empty.style.display = 'none';
  list.innerHTML = nfItemsTemp.map((it,i)=>`
    <div class="nf-item-row" style="grid-template-columns:1fr 70px 60px 80px 36px">
      <input class="nf-input" value="${esc(it.descricao||'')}" oninput="nfItemsTemp[${i}].descricao=this.value" placeholder="Descrição do produto">
      <input class="nf-input" type="number" min="0" step="0.01" value="${it.qtd||''}" oninput="nfItemsTemp[${i}].qtd=parseFloat(this.value)||0" placeholder="Qtd" style="text-align:right">
      <input class="nf-input" value="${esc(it.unidade||'UN')}" oninput="nfItemsTemp[${i}].unidade=this.value" placeholder="UN">
      <input class="nf-input" type="number" min="0" step="0.01" value="${it.valorUn||''}" oninput="nfItemsTemp[${i}].valorUn=parseFloat(this.value)||0" placeholder="R$ Un" style="text-align:right">
      <button class="btn-os-del-mat" onclick="nfItemsTemp.splice(${i},1);renderNfItems()">✕</button>
    </div>`).join('');
}

function addNfItem() {
  nfItemsTemp.push({descricao:'',qtd:1,unidade:'UN',codigo:'',valorUn:0});
  renderNfItems();
}

async function consultarNfe() {
  const chave = document.getElementById('nfChaveInput').value.replace(/\D/g,'');
  if (chave.length !== 44) { showToast('⚠️ Chave deve ter 44 dígitos.', true); return; }

  const btn = document.getElementById('btnConsultarNfe');
  btn.disabled = true;
  document.getElementById('nfConsultaStatus').innerHTML =
    '<span style="color:#f59e0b">🔄 Consultando dados da NF-e...</span>';

  // 1) Extrai dados que estão codificados na própria chave (sempre disponível)
  const dadosChave = extrairDadosChave(chave);

  // 2) Tenta buscar dados reais via BrasilAPI (CNPJ do emitente)
  let emitenteNome = '';
  try {
    const cnpjLimpo = dadosChave.cnpjRaw;
    const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpjLimpo}`);
    if (r.ok) {
      const j = await r.json();
      emitenteNome = j.razao_social || j.nome_fantasia || '';
    }
  } catch(e) { /* CORS ou timeout — não bloqueia */ }

  // 3) Tenta buscar XML/dados da NF-e via proxy CORS público
  //    O QR Code NF-e aponta para a URL do portal estadual com a chave.
  //    Usamos allorigins como proxy para tentar obter o DANFE/XML simplificado.
  let itensEncontrados = [];
  let valorTotal = 0;
  let nfFound = false;
  try {
    const url = `https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g%3d&nfe=${chave}`;
    // Tenta via allorigins.win (proxy CORS gratuito)
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const pr = await Promise.race([
      fetch(proxyUrl),
      new Promise((_,rej) => setTimeout(() => rej(new Error('timeout')), 6000))
    ]);
    if (pr.ok) {
      const pj = await pr.json();
      const html = pj.contents || '';
      // Tenta extrair valor total do HTML da página SEFAZ
      const mValor = html.match(/Valor\s+Total\s*[:=]?\s*R?\$?\s*([\d.,]+)/i);
      if (mValor) valorTotal = parseFloat(mValor[1].replace(/\./g,'').replace(',','.')) || 0;
      // Tenta extrair itens de tabelas
      const mItens = [...html.matchAll(/<tr[^>]*>[\s\S]*?<\/tr>/gi)];
      // Extrai linhas de produto (heurística: linhas com números e descrições longas)
      mItens.forEach(m => {
        const row = m[0].replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
        const parts = row.split(/\s{2,}/);
        if (parts.length >= 3) {
          const desc = parts.find(p => p.length > 5 && isNaN(p.replace(',','.')));
          const qtdStr = parts.find(p => /^\d+[,.]?\d*$/.test(p.trim()));
          const qtd = qtdStr ? parseFloat(qtdStr.replace(',','.')) : 0;
          if (desc && qtd > 0 && desc.length > 3) {
            itensEncontrados.push({descricao: desc.trim(), qtd, unidade:'UN', codigo:'', valorUn:0});
          }
        }
      });
      if (itensEncontrados.length > 0) nfFound = true;
    }
  } catch(e) { /* proxy indisponível */ }

  // 4) Preenche tela com o que conseguiu
  preencherDadosChaveNaTela(chave, dadosChave, emitenteNome, valorTotal);

  // 5) Se encontrou itens reais, popula a tabela; senão abre 1 linha vazia
  if (itensEncontrados.length > 0) {
    nfItemsTemp = itensEncontrados;
    renderNfItems();
    document.getElementById('nfConsultaStatus').innerHTML +=
      ` <span style="color:var(--accent)">· ${itensEncontrados.length} iten(s) importados automaticamente.</span>`;
  } else {
    if (!nfItemsTemp.length) {
      nfItemsTemp.push({descricao:'', qtd:1, unidade:'UN', codigo:'', valorUn:0});
      renderNfItems();
    }
    document.getElementById('nfConsultaStatus').innerHTML +=
      `<br><span style="color:var(--muted);font-size:.7rem;">ℹ️ O portal da SEFAZ não permite leitura automática dos itens por restrições de segurança (CAPTCHA/CORS). Preencha os itens manualmente ou consulte o DANFE impresso. &nbsp;<a href="https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g%3d" target="_blank" style="color:#06b6d4;">Abrir portal SEFAZ ↗</a></span>`;
  }

  btn.disabled = false;
}

function extrairDadosChave(chave) {
  // Estrutura: cUF(2)+AAMM(4)+CNPJ(14)+mod(2)+serie(3)+nNF(9)+tpEmis(1)+cNF(8)+cDV(1)
  const ufMap = {'11':'RO','12':'AC','13':'AM','14':'RR','15':'PA','16':'AP','17':'TO','21':'MA','22':'PI','23':'CE','24':'RN','25':'PB','26':'PE','27':'AL','28':'SE','29':'BA','31':'MG','32':'ES','33':'RJ','35':'SP','41':'PR','42':'SC','43':'RS','50':'MS','51':'MT','52':'GO','53':'DF'};
  const cuf  = chave.substring(0,2);
  const aamm = chave.substring(2,6);
  const cnpj = chave.substring(6,20);
  const serie= chave.substring(22,25);
  const nnf  = chave.substring(25,34);
  const ano  = '20' + aamm.substring(0,2);
  const mes  = aamm.substring(2,4);
  return {
    uf: ufMap[cuf] || cuf,
    cnpjRaw: cnpj,
    cnpjFmt: cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5'),
    serie: parseInt(serie,10).toString(),
    numero: parseInt(nnf,10).toString(),
    ano, mes
  };
}

function preencherDadosChaveNaTela(chave, d, emitenteNome, valorTotal) {
  document.getElementById('nfNumero').textContent  = `${d.numero} / Série ${d.serie}`;
  document.getElementById('nfEmitente').textContent = emitenteNome || `CNPJ emitente (UF: ${d.uf})`;
  document.getElementById('nfCnpj').textContent    = d.cnpjFmt;
  document.getElementById('nfData').textContent    = `${d.mes}/${d.ano}`;
  document.getElementById('nfValor').textContent   = valorTotal > 0
    ? `R$ ${valorTotal.toLocaleString('pt-BR',{minimumFractionDigits:2})}`
    : 'Preencha manualmente';
  document.getElementById('nfChaveDisplay').textContent = chave.replace(/(\d{4})/g,'$1 ').trim();
  document.getElementById('nfDataCard').classList.add('show');

  document.getElementById('nfNumeroManual').value  = d.numero;
  document.getElementById('nfSerie').value         = d.serie;
  document.getElementById('nfFornecedor').value    = emitenteNome || `Emitente CNPJ ${d.cnpjFmt}`;
  document.getElementById('nfDataEmissao').value   = `${d.ano}-${d.mes}-01`;
  nfScannedKey = chave;

  document.getElementById('nfConsultaStatus').innerHTML =
    `<span style="color:var(--accent)">✅ Dados extraídos${emitenteNome ? ' · Emitente identificado via CNPJ' : ' da chave NF-e'}. </span>`;
}

function preencherDadosDaChave(chave) {
  // Mantido para compatibilidade com o scanner
  const d = extrairDadosChave(chave);
  preencherDadosChaveNaTela(chave, d, '', 0);
  if (!nfItemsTemp.length) {
    nfItemsTemp.push({descricao:'', qtd:1, unidade:'UN', codigo:'', valorUn:0});
    renderNfItems();
  }
  document.getElementById('nfConsultaStatus').innerHTML +=
    `<span style="color:var(--muted);font-size:.7rem;"> Adicione os itens abaixo. &nbsp;<a href="https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g%3d" target="_blank" style="color:#06b6d4;">Portal SEFAZ ↗</a></span>`;
}

function saveNfEntrada() {
  const numero = document.getElementById('nfNumeroManual').value.trim();
  const fornecedor = document.getElementById('nfFornecedor').value.trim();
  if (!numero) { showToast('⚠️ Informe o número da NF.', true); return; }
  const itensFiltrados = nfItemsTemp.filter(it => it.descricao && String(it.descricao).trim());
  if (!itensFiltrados.length) { showToast('⚠️ Adicione ao menos um item com descrição.', true); return; }

  // Confirmation modal
  const totalQtd = itensFiltrados.reduce((s,it) => s + (parseFloat(it.qtd)||0), 0);
  openConfirm(
    `Confirmar entrada da <strong>NF ${esc(numero)}</strong>?<br><br>` +
    `<span style="font-family:var(--font-mono);font-size:.78rem;color:var(--muted)">` +
    `Fornecedor: <strong style="color:var(--text)">${esc(fornecedor||'Não informado')}</strong><br>` +
    `Itens: <strong style="color:var(--accent)">${itensFiltrados.length}</strong> &nbsp;·&nbsp; ` +
    `Qtd total: <strong style="color:var(--accent)">${totalQtd}</strong><br><br>` +
    `Os saldos serão atualizados no estoque.</span>`,
    '📥', 'REGISTRAR ENTRADA DE NF-e', 'Confirmar',
    function() { _executarSaveNf(numero, fornecedor, itensFiltrados); }
  );
}

function _executarSaveNf(numero, fornecedor, itensFiltrados) {
  loadEstoque();
  const session = getSession();
  const nf = {
    id: 'NF_' + Date.now(),
    numero,
    serie: document.getElementById('nfSerie').value.trim(),
    fornecedor,
    cnpj: (document.getElementById('nfCnpj')?.textContent !== '—' ? document.getElementById('nfCnpj').textContent : ''),
    dataEmissao: document.getElementById('nfDataEmissao').value,
    valorTotal: itensFiltrados.reduce((s,it) => s + ((parseFloat(it.qtd)||0)*(parseFloat(it.valorUn)||0)), 0),
    chaveAcesso: nfScannedKey,
    obs: document.getElementById('nfObs').value.trim(),
    itens: itensFiltrados,
    registradoPor: session?.name || '—',
    registradoEm: new Date().toISOString()
  };

  // Atualiza saldos e movimentos
  nf.itens.forEach(it => {
    const cod = (it.codigo || it.descricao.substring(0,20).toUpperCase().replace(/\s+/g,'_'));
    if (!estSaldos[cod]) {
      estSaldos[cod] = {descricao: it.descricao, unidade: it.unidade||'UN', saldo: 0, minSeg: 0, ultimaEntrada: ''};
    }
    estSaldos[cod].saldo = (estSaldos[cod].saldo || 0) + (parseFloat(it.qtd) || 0);
    estSaldos[cod].ultimaEntrada = new Date().toLocaleDateString('pt-BR');

    estMovimentos.push({
      datahora: new Date().toLocaleString('pt-BR'),
      tipo: 'ENTRADA',
      produto: it.descricao,
      qtd: parseFloat(it.qtd)||0,
      referencia: `NF ${numero}`,
      usuario: session?.name || '—'
    });
  });

  nfEntradas.unshift(nf);
  saveEstoque();
  closeNfModal();
  renderEstoque();
  showToast(`✅ NF ${numero} registrada! ${nf.itens.length} iten(s) adicionado(s) ao estoque.`);
}

function lancarSaidaEstoque(cod) {
  loadEstoque();
  const s = estSaldos[cod];
  if (!s) return;
  const qtd = parseFloat(prompt(`Saída de: ${s.descricao}\nSaldo atual: ${s.saldo} ${s.unidade}\n\nInforme a quantidade de saída:`) || '0');
  if (isNaN(qtd) || qtd <= 0) return;
  if (qtd > s.saldo) { showToast('⚠️ Quantidade maior que o saldo disponível.', true); return; }

  const ref = prompt('Referência (ex: OS 4001234567):') || '';
  const session = getSession();
  estSaldos[cod].saldo -= qtd;
  estMovimentos.push({
    datahora: new Date().toLocaleString('pt-BR'),
    tipo: 'SAÍDA',
    produto: s.descricao,
    qtd,
    referencia: ref,
    usuario: session?.name || '—'
  });
  saveEstoque();
  renderEstoque();
  showToast(`📤 Saída de ${qtd} ${s.unidade} de "${s.descricao}" registrada.`);
}

// ── NF Scanner ──────────────────────────────────────────────────
async function openNfScanner() {
  document.getElementById('nfScannerModal').classList.add('open');
  nfScannedKey = '';
  document.getElementById('nfScannerResultBox').style.display = 'none';
  document.getElementById('btnNfScanUse').disabled = true;
  document.getElementById('nfScannerStatus').textContent = 'Iniciando câmera...';
  try {
    nfScanStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    document.getElementById('nfScannerVideo').srcObject = nfScanStream;
    document.getElementById('nfScannerStatus').textContent = 'Aponte para o QR Code / código de barras da NF-e';

    // Usar BarcodeDetector API se disponível
    if ('BarcodeDetector' in window) {
      const bd = new BarcodeDetector({formats:['qr_code','code_128','code_39','ean_13','ean_8']});
      const video = document.getElementById('nfScannerVideo');
      nfScanInterval = setInterval(async () => {
        try {
          const codes = await bd.detect(video);
          if (codes.length) {
            const raw = codes[0].rawValue.replace(/\D/g,'');
            if (raw.length === 44) {
              nfScannedKey = raw;
              document.getElementById('nfScannerResultVal').textContent = raw;
              document.getElementById('nfScannerResultBox').style.display = '';
              document.getElementById('btnNfScanUse').disabled = false;
              document.getElementById('nfScannerStatus').textContent = '✅ Chave NF-e detectada!';
              clearInterval(nfScanInterval);
            }
          }
        } catch(e){}
      }, 400);
    } else {
      document.getElementById('nfScannerStatus').textContent = 'Câmera ativa. Se não detectar automaticamente, use a digitação manual abaixo.';
    }
  } catch(e) {
    document.getElementById('nfScannerStatus').textContent = '❌ Sem acesso à câmera. Use a digitação manual.';
  }
}

function restartNfScanner() {
  nfScannedKey = '';
  document.getElementById('nfScannerResultBox').style.display = 'none';
  document.getElementById('btnNfScanUse').disabled = true;
  document.getElementById('nfScannerStatus').textContent = 'Aponte para o QR Code / código de barras da NF-e';
  if (nfScanInterval) { clearInterval(nfScanInterval); nfScanInterval = null; }
}

function closeNfScanner() {
  document.getElementById('nfScannerModal').classList.remove('open');
  if (nfScanInterval) { clearInterval(nfScanInterval); nfScanInterval = null; }
  if (nfScanStream) { nfScanStream.getTracks().forEach(t=>t.stop()); nfScanStream = null; }
}

function useNfScan() {
  if (!nfScannedKey) return;
  closeNfScanner();
  document.getElementById('nfChaveInput').value = nfScannedKey;
  preencherDadosDaChave(nfScannedKey);
}

function useNfManualKey() {
  const key = document.getElementById('nfScanManualKey').value.replace(/\D/g,'');
  if (key.length !== 44) { showToast('⚠️ Chave deve ter 44 dígitos.', true); return; }
  nfScannedKey = key;
  closeNfScanner();
  document.getElementById('nfChaveInput').value = key;
  preencherDadosDaChave(key);
}

// Inicializar dados ao carregar
loadOrdens();
loadEstoque();

</script>

<!-- ── ITEM DRAWER ───────────────────────────────────────────────────────── -->
<div id="itemDrawer">
  <div class="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="drawer-panel">
    <div class="drawer-top">
      <span class="drawer-title">DETALHES DO ITEM</span>
      <button class="drawer-close" onclick="closeDrawer()">✕</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-badge-row" id="drawerBadge"></div>
      <div class="drawer-fields" id="drawerFields"></div>
    </div>
    <div class="drawer-actions" id="drawerActions"></div>
  </div>
</div>

<!-- ── ADMIN BLOCK MODAL ─────────────────────────────────────────────────── -->
<div id="adminBlockModal">
  <div class="admin-block-card">
    <span class="admin-block-icon">🔐</span>
    <div class="admin-block-title">ACESSO RESTRITO</div>
    <div class="admin-block-msg">
      Desconsolidar um item é uma ação exclusiva de <strong>Administradores</strong>.<br><br>
      Entre em contato com o administrador do sistema para realizar esta operação.
    </div>
    <button class="btn-admin-block-ok" onclick="closeAdminBlock()">ENTENDIDO</button>
  </div>
</div>
</body>
</html>
